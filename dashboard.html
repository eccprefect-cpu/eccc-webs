<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Prefects' Guild | New Era</title>
    <link rel="icon" href="meroon Transparent logo prefect.png" type="image/png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        /* --- DESIGN SYSTEM : MAROON & GOLD PREMIUM --- */
        :root {
            /* Core Colors */
            --primary-700: #58120c;
            /* Deep Maroon */
            --primary-600: #720e0e;
            /* Standard Maroon */
            --primary-500: #942b2b;
            /* Light Maroon */
            --primary-100: #fce8e8;
            /* Pale Maroon */

            --gold-700: #9c7c25;
            --gold-500: #D4AF37;
            /* Metallic Gold */
            --gold-300: #f0d676;
            --gold-100: #fbf5dc;

            /* Neutrals */
            --gray-900: #1a1a1a;
            --gray-600: #5c5c5c;
            --gray-500: #808080;
            --gray-200: #e5e5e5;
            --gray-100: #f5f5f5;
            --white: #ffffff;

            /* Backgrounds */
            --bg-body: #F4F6F9;
            /* Clean light gray-blue body */
            --bg-surface: rgba(255, 255, 255, 0.75);
            /* Glass surface */
            --bg-panel: #ffffff;

            /* Effects */
            --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.03);
            --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.1);
            --glass-blur: blur(12px);
            --border-light: 1px solid rgba(0, 0, 0, 0.05);

            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;

            /* Sizing */
            --sidebar-width: 280px;
            --header-height: 80px;
            --radius-xl: 24px;
            --radius-lg: 16px;
        }

        /* --- RESET & BASE --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-body);
            color: var(--gray-900);
            height: 100dvh;
            /* Use dynamic viewport height */
            width: 100%;
            overflow: hidden;
            /* Prevent body scroll entirely */
            display: flex;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: 0.3s;
        }

        ul {
            list-style: none;
        }

        button {
            font-family: inherit;
            cursor: pointer;
        }

        /* --- LAYOUT GRID --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100dvh;
            /* Full viewport fixed */
            overflow: hidden;
        }

        /* --- SIDEBAR (MODERN) --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            border-right: var(--border-light);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2.5rem;
            padding: 0 0.5rem;
        }

        .brand img {
            height: 48px;
            filter: drop-shadow(0 4px 6px rgba(114, 14, 14, 0.2));
        }

        .brand-text h1 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-600);
            line-height: 1;
            letter-spacing: -0.5px;
        }

        .brand-text span {
            font-size: 0.75rem;
            color: var(--gold-700);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.85rem 1rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--gray-600);
            font-weight: 500;
            font-size: 0.95rem;
            position: relative;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
            color: var(--gray-500);
            transition: 0.3s;
        }

        .nav-item:hover {
            background-color: var(--primary-100);
            color: var(--primary-700);
        }

        .nav-item:hover i {
            color: var(--primary-600);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: var(--white);
            box-shadow: 0 8px 20px rgba(114, 14, 14, 0.25);
        }

        .nav-item.active i {
            color: var(--gold-500);
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: var(--border-light);
            padding-top: 1.5rem;
        }

        .logout-btn {
            width: 100%;
            padding: 1rem;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, #2d3436, #000000);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-body);
            position: relative;
            height: 100dvh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* --- HEADER --- */
        .header {
            height: var(--header-height);
            padding: 0 2.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 90;
            background: rgba(244, 246, 249, 0.85);
            /* Matches bg-body with opacity */
            backdrop-filter: blur(10px);
        }

        .page-title h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .page-title span {
            color: var(--gray-500);
            font-weight: 400;
            margin-left: 0.5rem;
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid var(--gray-200);
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--gray-600);
            transition: 0.3s;
            position: relative;
        }

        .btn-icon:hover {
            border-color: var(--primary-500);
            color: var(--primary-600);
            transform: rotate(10deg);
        }

        .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--gold-500);
            color: var(--white);
            font-size: 0.65rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: 0.35rem 0.35rem 0.35rem 1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.3s;
        }

        .profile-btn:hover {
            border-color: var(--primary-500);
            box-shadow: var(--shadow-sm);
        }

        .profile-info {
            text-align: right;
            line-height: 1.2;
        }

        .profile-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--gray-900);
            display: block;
        }

        .profile-role {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .profile-img {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--gold-500);
        }

        /* --- DASHBOARD CONTENT GRID (BENTO) --- */
        .content-wrapper {
            padding: 1rem 2.5rem 2.5rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .bento-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            grid-auto-rows: minmax(180px, auto);
        }

        /* --- CARDS & WIDGETS --- */
        .card {
            background: var(--bg-panel);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        /* --- Welcome Banner --- */
        .card-welcome {
            grid-column: span 2;
            background: linear-gradient(120deg, var(--primary-700), var(--primary-600));
            color: var(--white);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
            position: relative;
        }

        .welcome-content {
            z-index: 1;
        }

        .welcome-content h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .welcome-content span {
            color: var(--gold-500);
        }

        .welcome-content p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
        }

        .welcome-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.2);
            object-fit: cover;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        /* Decor circles */
        .card-welcome::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        /* --- Stat Cards --- */
        .card-stat {
            grid-column: span 1;
            justify-content: center;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--primary-100);
            color: var(--primary-600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-700);
            line-height: 1.1;
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* --- Action Quick Links --- */
        .card-actions {
            grid-column: span 4;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            background: var(--white);
            padding: 1.25rem 2rem;
        }

        .action-list {
            display: flex;
            gap: 1rem;
        }

        .btn-action {
            background: var(--gray-100);
            color: var(--gray-600);
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: 0.3s;
        }

        .btn-action:hover {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .btn-action i {
            color: var(--gold-700);
        }


        /* --- Bar Chart --- */
        .bar-chart-container {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: flex-end;
        }

        .bar-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 100%;
            width: 100%;
        }

        @keyframes growBar {
            from {
                transform: scaleY(0);
            }

            to {
                transform: scaleY(1);
            }
        }

        .bar {
            width: 12%;
            background-image: linear-gradient(to top, var(--primary-700), var(--primary-500));
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: all 0.3s ease;
            transform-origin: bottom;
            animation: growBar 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        .bar:hover {
            opacity: 0.9;
            transform: scaleY(1.05);
        }

        .bar::before {
            content: attr(data-value);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--gray-900);
            opacity: 0;
            transition: 0.3s;
        }

        .bar:hover::before {
            opacity: 1;
            top: -30px;
        }

        .bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--gray-500);
            white-space: nowrap;
        }

        /* --- Profile Section --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Upvote Button Animations */
        .upvote-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid var(--gray-300);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            color: var(--gray-600);
        }

        .upvote-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .upvote-btn:active {
            transform: translateY(1px) scale(0.95);
        }

        .upvote-btn i {
            transition: transform 0.3s ease;
        }

        .upvote-btn:hover i {
            transform: scale(1.2) rotate(-10deg);
        }

        .upvote-btn.active-upvote {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(114, 14, 14, 0.3);
        }

        .upvote-btn.active-upvote:hover {
            color: white;
        }

        .profile-header-large {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 2rem;
        }

        .profile-page-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--white);
            box-shadow: var(--shadow-md);
        }

        .profile-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            background: var(--gray-100);
            color: var(--gray-900);
            font-family: inherit;
            transition: 0.3s;
        }

        .form-group input:focus {
            background: var(--white);
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        .form-group input:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* --- About Us Section --- */
        .about-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .about-card {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .team-member {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: 0.3s;
        }

        .team-member:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .team-member img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 1rem;
            object-fit: cover;
        }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        .mobile-menu-btn {
            display: none;
        }

        .sidebar-overlay {
            display: none;
        }

        @media (max-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .card-actions {
                grid-column: span 2;
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .action-list {
                flex-wrap: wrap;
                width: 100%;
            }

            .btn-action {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                height: 100%;
                z-index: 1000;
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.3);
                transition: left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
                /* Smooth slide animation */
            }

            .sidebar.active {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                backdrop-filter: blur(4px);
                opacity: 0;
                transition: opacity 0.3s ease;
                /* Smooth fade for overlay */
                pointer-events: none;
                /* Prevent clicks when hidden */
            }

            .sidebar-overlay.show {
                display: block;
                opacity: 1;
                pointer-events: all;
            }

            .mobile-menu-btn {
                display: block;
                background: transparent;
                border: none;
                font-size: 1.5rem;
                color: var(--gray-700);
            }

            .header {
                padding: 0 1rem;
                justify-content: space-between;
                position: sticky;
                top: 0;
                z-index: 900;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(8px);
            }

            .content-wrapper {
                padding: 1rem;
                padding-bottom: 6rem;
            }

            /* --- Refined Mobile Bento Grid --- */
            .bento-grid {
                /* Keep 2 columns even on mobile for stats */
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            /* Welcome Card: Full Width */
            .card-welcome {
                grid-column: span 2 !important;
                flex-direction: column-reverse;
                text-align: center;
                gap: 1.5rem;
                padding: 1.5rem;
            }

            .welcome-content h2 {
                font-size: 1.5rem;
            }

            .welcome-img {
                width: 100px;
                height: 100px;
            }

            /* Stats: 1 Column each (default behavior, so 2 per row) */
            .card-stat {
                padding: 1rem;
                /* No grid-column override needed, they take 1 slot */
            }

            /* Actions: Full Width */
            .card-actions {
                grid-column: span 2 !important;
                flex-direction: column;
                align-items: flex-start;
            }

            .action-list {
                /* Make buttons 2x2 grid or scrollable? Let's do stacked or grid */
                display: grid;
                grid-template-columns: 1fr 1fr;
                width: 100%;
                gap: 0.5rem;
            }

            .btn-action {
                justify-content: center;
                font-size: 0.85rem;
            }

            /* Chart: Full Width */
            .card[style*="grid-column: span 2"] {
                grid-column: span 2 !important;
                min-height: 250px !important;
            }
        }

        /* --- NOTIFICATION DROPDOWN --- */
        .notification-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            width: 320px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            z-index: 1000;
            display: none;
            overflow: hidden;
            flex-direction: column;
        }

        .notification-dropdown.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            font-size: 1rem;
            color: var(--primary-700);
            margin: 0;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-body);
        }

        .notification-item.unread {
            background: #fff8f8;
            border-left: 3px solid var(--primary-500);
        }

        .notification-footer {
            padding: 0.75rem;
            text-align: center;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-100);
        }

        .view-all-btn {
            color: var(--primary-600);
            font-size: 0.85rem;
            font-weight: 600;
            background: none;
            border: none;
        }

        /* --- CHAT BOT FLOATING UI --- */
        .chat-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: var(--white);
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 15px rgba(114, 14, 14, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .chat-fab:hover {
            transform: scale(1.1);
        }

        .chat-container {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 350px;
            height: 500px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            z-index: 999;
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: 0.3s ease;
            border: 1px solid var(--border-light);
        }

        .chat-container.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .chat-header {
            background: var(--primary-700);
            color: var(--white);
            padding: 1rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--bg-body);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary-600);
            color: var(--white);
            border-bottom-right-radius: 2px;
        }

        .bot-message {
            align-self: flex-start;
            background: var(--white);
            border: 1px solid var(--gray-200);
            color: var(--gray-900);
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.5rem;
            background: var(--white);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 20px;
            font-family: inherit;
        }

        .chat-send {
            background: var(--primary-600);
            color: var(--white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        /* --- FUTURE ABSENCE FORM --- */
        .future-absence-form {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-top: 1.5rem;
        }

        /* --- IDEAS UI IMPROVEMENTS --- */
        .supiri-btn {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-700));
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
        }

        .supiri-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.6);
        }

        .idea-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: 0.3s;
        }

        .idea-item:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary-100);
        }

        /* --- ABOUT US & TEAM SECTION --- */
        .about-grid,
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .about-card,
        .team-member {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }

        .about-card:hover,
        .team-member:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-200);
        }

        .team-member img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 3px solid var(--primary-100);
            padding: 3px;
            background: white;
            transition: 0.3s;
        }

        .team-member:hover img {
            border-color: var(--gold-500);
            transform: scale(1.05);
        }

        .team-member h4 {
            margin: 0;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
            color: var(--gray-800);
        }

        /* Mobile Responsiveness for About Us */
        @media (max-width: 768px) {

            .about-grid,
            .team-grid {
                grid-template-columns: 1fr;
                /* Stack vertically on mobile */
            }

            .about-card,
            .team-member {
                padding: 1.25rem;
                /* Slightly compact on mobile */
            }
        }

        /* --- GLOBAL MOBILE RESPONSIVENESS FIXES --- */
        @media (max-width: 768px) {

            /* Profile Section: Stack Form & Key Info */
            .profile-form-grid {
                grid-template-columns: 1fr;
            }

            .profile-header-large {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .profile-header-info {
                align-items: center;
            }

            /* Chat Widget: Adjust Size & Position */
            .chat-container {
                width: 90% !important;
                right: 5% !important;
                left: 5% !important;
                bottom: 90px !important;
                height: 60vh !important;
            }

            .chat-fab {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            /* Notification Dropdown: Full Width */
            .notification-dropdown {
                width: 92% !important;
                right: 4% !important;
                left: 4% !important;
                top: 70px !important;
            }

            /* Tables & Lists: Stack Content */
            .stats-list li {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .stats-list li>div:last-child {
                align-self: flex-end;
            }

            /* Card Inner Spacing */
            .idea-item,
            .dashboard-card,
            .card {
                padding: 1rem !important;
            }

            .idea-item>div:first-child {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            /* Main Content Padding/Margins */
            .content-wrapper {
                padding: 1rem 1rem 6rem;
            }

            .header {
                padding: 0 1rem;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <img src="meroon Transparent logo prefect.png" alt="Logo">
            <div class="brand-text">
                <h1>ECCPMS</h1>
                <span>Prefects' Guild</span>
            </div>
        </div>

        <nav class="nav-menu">
            <a href="#overview" class="nav-item active">
                <i class="fas fa-grid-2"></i>
                <span>Overview</span>
            </a>
            <a href="#events" class="nav-item">
                <i class="fas fa-calendar-alt"></i>
                <span>Events</span>
            </a>
            <a href="#ideas" class="nav-item">
                <i class="fas fa-lightbulb"></i>
                <span>Ideas</span>
            </a>
            <a href="#notifications" class="nav-item">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
            </a>
            <a href="#attendance" class="nav-item">
                <i class="fas fa-check-circle"></i>
                <span>Attendance</span>
            </a>
            <a href="#points" class="nav-item">
                <i class="fas fa-star"></i>
                <span>Points</span>
            </a>
            <a href="#performance" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Performance</span>
            </a>
            <a href="#profile" class="nav-item">
                <i class="fas fa-user-circle"></i>
                <span>Profile</span>
            </a>
            <a href="#about" class="nav-item">
                <i class="fas fa-info-circle"></i>
                <span>About Us</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Log Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="page-title">
                    <h2>Dashboard <span>Overview</span></h2>
                </div>
            </div>

            <div class="header-actions">
                <button class="btn-icon" id="header-notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notification-badge-count">0</span>
                </button>

                <div class="notification-dropdown" id="notification-dropdown-panel">
                    <div class="notification-header">
                        <h4>Notifications</h4>
                        <span class="badge"
                            style="position:static; transform:none; background:var(--primary-100); color:var(--primary-700); font-size:0.75rem; padding:2px 8px; border-radius:12px; width:auto; height:auto; border:none;">New</span>
                    </div>
                    <div class="notification-list" id="notification-dropdown-list">
                        <!-- Notifications will be loaded here -->
                        <div style="padding:1rem; text-align:center; color:var(--gray-500);">Loading...</div>
                    </div>
                    <div class="notification-footer">
                        <button class="view-all-btn" id="view-all-notifications-btn">View All Notifications</button>
                    </div>
                </div>



                <button class="profile-btn">
                    <div class="profile-info">
                        <span class="profile-name" id="header-profile-name">Prefect Name</span>
                        <span class="profile-role" id="header-profile-role">Senior Prefect</span>
                    </div>
                    <img src="meroon Transparent logo prefect.png" alt="Profile" class="profile-img"
                        id="header-profile-img">
                </button>
            </div>
        </header>

        <!-- Content Grid -->
        <!-- Content Grid -->
        <div class="content-wrapper">

            <!-- Overview Section -->
            <section id="overview" class="content-section active">
                <div class="bento-grid">

                    <!-- Welcome Card -->
                    <div class="card card-welcome">
                        <div class="welcome-content">
                            <h2>Hello, <span id="welcome-name">Prefect!</span></h2>
                            <p>Ready to lead by example today? Check your upcoming duties and notifications.</p>
                        </div>
                        <img src="meroon Transparent logo prefect.png" alt="Profile" class="welcome-img"
                            id="welcome-profile-img">
                    </div>

                    <!-- Points Stat -->
                    <div class="card card-stat">
                        <div class="stat-icon"><i class="fas fa-star"></i></div>
                        <div class="stat-value" id="total-points">0</div>
                        <div class="stat-label">Total Points</div>
                    </div>

                    <!-- Absences Stat -->
                    <div class="card card-stat">
                        <div class="stat-icon" style="background: #fff0f0; color: #d63031;"><i
                                class="fas fa-user-times"></i></div>
                        <div class="stat-value" style="color: #d63031;" id="total-absences">0</div>
                        <div class="stat-label">Absences</div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card card-actions">
                        <h4>Quick Actions</h4>
                        <div class="action-list">
                            <button class="btn-action"><i class="fas fa-calendar-plus"></i> New Event</button>
                            <button class="btn-action"><i class="fas fa-lightbulb"></i> Submit Idea</button>
                            <button class="btn-action"><i class="fas fa-file-medical"></i> Report Absence</button>
                        </div>
                    </div>

                    <!-- Chart Placeholder -->
                    <div class="card" style="grid-column: span 2; min-height: 300px;">
                        <div style="padding: 1rem; height: 100%; display: flex; flex-direction: column;">
                            <h4 style="margin-bottom: 1rem; color: var(--gray-700);">Weekly Attendance</h4>
                            <div class="bar-chart-container" style="flex: 1; min-height: 200px;">
                                <div class="bar-chart" id="weekly-attendance-chart">
                                    <!-- Bars will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Late Arrivals -->
                    <div class="card card-stat">
                        <div class="stat-icon" style="background: #fff8e1; color: #fbc02d;"><i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-value" style="color: #fbc02d;" id="total-late">0</div>
                        <div class="stat-label">Late Arrivals</div>
                    </div>

                    <!-- Profile Edit -->
                    <div class="card card-stat">
                        <div class="stat-icon" style="background: #e3f2fd; color: #1e88e5;"><i
                                class="fas fa-user-edit"></i>
                        </div>
                        <button style="border: none; background: transparent; font-weight: 600; color: #1e88e5;"
                            id="dashboard-edit-profile-btn">Edit
                            Profile</button>
                    </div>

                </div>
            </section>

            <!-- Placeholders for other sections -->
            <section id="events" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Upcoming Events</h2>
                <div class="card">
                    <div id="events-list">
                        <!-- Events will be populated here -->
                        <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            <i class="fas fa-spinner fa-spin"></i> Loading events...
                        </div>
                    </div>
                </div>
            </section>

            <section id="ideas" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Ideas & Proposals</h2>

                <div class="bento-grid" style="grid-template-columns: 1fr;">
                    <!-- Submit Idea Form -->
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 1rem; color: var(--primary-700);">Submit an Idea
                        </h3>
                        <form id="idea-form">
                            <div class="form-group">
                                <label for="idea-title">Title</label>
                                <input type="text" id="idea-title" placeholder="Title of your idea" required>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="idea-description">Description</label>
                                <textarea id="idea-description" rows="4" placeholder="Describe your idea in detail..."
                                    required
                                    style="width: 100%; padding: 0.85rem 1rem; border: 1px solid var(--gray-200); border-radius: var(--radius-lg); background: var(--gray-100); color: var(--gray-900); font-family: inherit; transition: 0.3s;"></textarea>
                            </div>
                            <button type="submit" id="idea-submit-btn" class="supiri-btn"
                                style="margin-top: 1rem; width: 100%;">
                                <i class="fas fa-paper-plane"></i> Submit for Approval
                            </button>
                            <p id="submit-message" style="margin-top: 1rem; font-size: 0.9rem; text-align: center;"></p>
                        </form>
                    </div>

                    <!-- My Submissions (Hidden because dashboard.html didn't have it and it causes permission errors) -->
                    <div class="card" style="display: none;">
                        <h3 class="card-title" style="margin-bottom: 1rem;">My Submissions</h3>
                        <div id="my-ideas-list" class="ideas-list">
                            <p style="color: var(--gray-500);">Loading your ideas...</p>
                        </div>
                    </div>

                    <!-- Public Proposals -->
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 1rem;">Public Proposals</h3>
                        <div id="public-ideas-list" class="ideas-list">
                            <p style="color: var(--gray-500);">Loading public proposals...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="notifications" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Notifications</h2>
                <div class="card">
                    <div id="notifications-list" class="notification-list" style="max-height:none;">
                        <p style="color:var(--gray-500);">Loading announcements...</p>
                    </div>
                </div>
            </section>

            <section id="attendance" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Attendance Record</h2>
                <div id="absent-reason-container" style="margin-bottom: 2rem;">
                    <!-- Absence Reason Form (Dynamically Injected) -->
                </div>
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem; color:var(--primary-600);">Request Future Absence
                        / Duty Handover</h3>
                    <p style="color:var(--gray-600); margin-bottom:1rem; font-size:0.9rem;">Plan your absence in advance
                        and assign a replacement.</p>
                    <form id="future-absence-form" class="future-absence-form">
                        <div class="profile-form-grid">
                            <div class="form-group">
                                <label>Date of Absence</label>
                                <input type="date" id="future-absence-date" required>
                            </div>
                            <div class="form-group">
                                <label>Replacement Prefect</label>
                                <select id="replacement-prefect-select" required>
                                    <option value="">Select Prefect</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:1rem;">
                            <label>Reason / Handover Note</label>
                            <textarea id="future-absence-reason" rows="2"
                                placeholder="Explain reason and duty details..." required></textarea>
                        </div>
                        <button type="submit" id="future-absence-submit-btn" class="supiri-btn"
                            style="width:auto; margin-top:1rem;">Submit Request</button>
                        <p id="future-absence-message" style="margin-top:0.5rem; font-size:0.9rem;"></p>
                    </form>
                </div>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;">Recent Attendance</h3>
                    <div id="recent-attendance-list">
                        <p style="color: var(--gray-500);">Loading attendance...</p>
                    </div>
                </div>
            </section>

            <section id="points" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Points History</h2>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;">Recent Points</h3>
                    <div id="recent-points-list">
                        <p style="color: var(--gray-500);">Loading points history...</p>
                    </div>
                </div>
            </section>

            <section id="performance" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Performance & Duty</h2>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem; color:#d63031;">Performance Issues</h3>
                    <div id="bad-work-list">
                        <p style="color: var(--gray-500);">Loading records...</p>
                    </div>
                </div>
            </section>

            <section id="profile" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">My Profile</h2>
                <div class="card">
                    <div class="profile-header-large">
                        <img id="profile-page-picture" src="meroon Transparent logo prefect.png" alt="Profile Picture"
                            class="profile-page-img">
                        <div class="profile-header-info">
                            <h3 id="profile-page-name" style="font-size: 1.5rem; margin-bottom: 0.25rem;">Prefect Name
                            </h3>
                            <p id="profile-page-role-display" style="color: var(--gold-700); font-weight: 600;">Senior
                                Prefect</p>
                            <small id="profile-prefect-id" style="color: var(--gray-500);">ID: -</small>
                        </div>
                    </div>

                    <div class="profile-form-grid">
                        <div class="form-group">
                            <label for="profile-email">Email</label>
                            <input type="email" id="profile-email" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-phone">Phone</label>
                            <input type="tel" id="profile-phone" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-class-static">Class</label>
                            <input type="text" id="profile-class-static" value="-" disabled>
                        </div>

                        <div class="form-group">
                            <label for="profile-section">Section</label>
                            <input type="text" id="profile-section" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-index">Index Number</label>
                            <input type="text" id="profile-index" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-parents-phone">Parents' Phone</label>
                            <input type="tel" id="profile-parents-phone" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-current-duty">Current Duty</label>
                            <input type="text" id="profile-current-duty" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-total-points">Total Points</label>
                            <input type="text" id="profile-total-points" value="0" disabled>
                        </div>
                    </div>
                </div>
            </section>

            <section id="about" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">About Us</h2>

                <div class="card" style="margin-bottom: 2rem;">
                    <div class="about-header" style="text-align: center; max-width: 800px; margin: 0 auto;">
                        <h2 style="color: var(--primary-700); margin-bottom: 1rem;">About Our Mission</h2>
                        <p style="color: var(--gray-600); line-height: 1.6;">We are a team of passionate and innovative
                            students from Eheliyagoda Central College, brought
                            together by a shared vision of leveraging technology to improve our school's ecosystem.</p>
                    </div>
                </div>

                <div class="about-grid">
                    <div class="about-card">
                        <div class="stat-icon" style="margin: 0 auto 1rem;"><i class="fas fa-rocket"></i></div>
                        <h3>About The Project</h3>
                        <p style="color: var(--gray-600); margin-top: 0.5rem;">Welcome to the official portal for the
                            Eheliyagoda Central College Prefect Management
                            System (ECCPMS). Digitzing the Prefects' Guild.</p>
                    </div>
                    <div class="about-card">
                        <div class="stat-icon" style="margin: 0 auto 1rem;"><i class="fas fa-code-branch"></i></div>
                        <h3>Project Version</h3>
                        <p style="color: var(--gray-600); margin-top: 0.5rem;">Current Version: <strong>1.0.0</strong>.
                            The first official release of the ECCPMS.</p>
                    </div>
                </div>

                <h3 style="margin-bottom: 1.5rem;">Meet The Team</h3>
                <div class="team-grid">
                    <!-- Developers -->
                    <div class="team-member">
                        <img src="Developer Team/Adeesha.jpg" alt="Adeesha"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Adeesha Ravimal</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Backend & Desktop
                            App</p>
                        <p style="font-size: 0.8rem; color: var(--gray-600);">System Architect</p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/Hansaka.png" alt="Hansaka"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Hansaka Fernando</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Web & Mobile App
                        </p>
                        <p style="font-size: 0.8rem; color: var(--gray-600);">UI/UX Designer</p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/thevindu.JPG" alt="Thevindu"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Thevindu Thisev</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Data Collector</p>
                        <p style="font-size: 0.8rem; color: var(--gray-600);">Database Admin</p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/Nethmi.jpg" alt="Nethmi"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Nethmi Dhananjana</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Coordinator</p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/Rashmi.jpg" alt="Rashmi"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Rashmi Jananjana</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Student Mgmt Lead
                        </p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/Avishka.jpg" alt="Avishka"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Avishka Kalhara</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Media Partner</p>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, limit, orderBy, addDoc, doc, updateDoc, runTransaction, arrayUnion, getDoc, setDoc, writeBatch, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEvF1sD56pmtYlbno4QAY_Kr5xeFrTAvU",
            authDomain: "prefect-management-syste-e1575.firebaseapp.com",
            projectId: "prefect-management-syste-e1575",
            storageBucket: "prefect-management-syste-e1575.appspot.com",
            messagingSenderId: "973932803095",
            appId: "1:973932803095:web:a7f2db386cafb53330d852",
            measurementId: "G-FLF7R3B8J3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sidebar Navigation Logic
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('show');
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('show');
            });
        }

        // Active Link Highlighting & SPA Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const href = item.getAttribute('href');
                if (!href || !href.startsWith('#')) return;

                // Remove active class from all links
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Hide all sections and show target
                contentSections.forEach(s => {
                    s.style.display = 'none';
                    s.classList.remove('active');
                });

                const targetId = href.substring(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    // Small delay to allow display to apply before opacity transition if we add one
                    setTimeout(() => targetSection.classList.add('active'), 10);
                }

                // Update Header Title
                const pageTitle = document.querySelector('.page-title h2 span');
                const linkText = item.querySelector('span').textContent;
                if (pageTitle) pageTitle.textContent = linkText;

                // On mobile, close sidebar on click
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('show');
                }
            });
        });

        // Logout Logic
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error("Logout Error:", error);
                });
            });
        }

        // Auth & Data Loading
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User logged in:", user.uid);

                // Fetch Prefect Profile
                const prefectsRef = collection(db, "prefects");
                const q = query(prefectsRef, where("uid", "==", user.uid));

                try {
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const prefectDoc = querySnapshot.docs[0];
                        const prefectData = prefectDoc.data();
                        const prefectId = prefectDoc.id;

                        // Update UI with Profile Data
                        updateProfileUI(prefectData);

                        // Fetch Stats
                        await fetchKeyStats(prefectId);
                        await fetchRecentPoints(prefectId);
                        await fetchWeeklyAttendanceChart(prefectId);
                        await fetchRecentAttendance(prefectId);
                        await checkForAbsenceReason(prefectId);
                        await fetchBadWork(prefectId);

                        // Load Events & Ideas
                        loadEvents();
                        initializeIdeas();
                        loadAnnouncements();
                        initializeChat(user);
                        try { initializeFutureAbsenceForm(user); } catch (e) { console.error(e); }

                    } else {
                        console.log("No prefect profile found for this user.");
                    }
                } catch (error) {
                    console.error("Error fetching data:", error);
                }

            } else {
                console.log("No user logged in, redirecting...");
                // window.location.href = 'login.html'; // Uncomment for production
            }
        });

        function updateProfileUI(data) {
            const defaultImg = "meroon Transparent logo prefect.png";
            const imageUrl = data.picture || defaultImg;
            const name = data.name || "Prefect";
            const role = data.destiny || "Member";

            // Update Header Name/Role (Mobile & Desktop)
            const headerName = document.getElementById('header-profile-name');
            const headerRole = document.getElementById('header-profile-role');
            const headerImg = document.getElementById('header-profile-img');

            if (headerName) headerName.textContent = name;
            if (headerRole) headerRole.textContent = role;
            if (headerImg) headerImg.src = imageUrl;

            // Update Welcome Card
            const welcomeName = document.getElementById('welcome-name');
            const welcomeImg = document.getElementById('welcome-profile-img');

            if (welcomeName) welcomeName.textContent = name;
            if (welcomeImg) welcomeImg.src = imageUrl;

            // Update Profile Page Details
            const profilePageName = document.getElementById('profile-page-name');
            const profilePageRole = document.getElementById('profile-page-role-display');
            const profilePageImg = document.getElementById('profile-page-picture');
            const profileId = document.getElementById('profile-prefect-id');

            if (profilePageName) profilePageName.textContent = name;
            if (profilePageRole) profilePageRole.textContent = role;
            if (profilePageImg) profilePageImg.src = imageUrl;
            if (profileId) profileId.textContent = `ID: ${data.school_index_number || '-'}`;

            // Form Fields
            const fieldMap = {
                'profile-email': data.email,
                'profile-phone': data.phone,
                'profile-class-static': data.class,
                'profile-section': data.section,
                'profile-index': data.school_index_number,
                'profile-parents-phone': data.parents_phone,
                'profile-current-duty': data.current_duty,
                'profile-total-points': data.total_points || 0
            };

            for (const [id, value] of Object.entries(fieldMap)) {
                const el = document.getElementById(id);
                if (el) el.value = value || '-';
            }
        }

        async function fetchKeyStats(prefectId) {
            // Points - Using real-time listener
            const pointsQuery = query(collection(db, "points"), where("prefect_id", "==", prefectId));
            onSnapshot(pointsQuery, (pointsSnapshot) => {
                let totalPoints = 0;
                pointsSnapshot.forEach(doc => { totalPoints += doc.data().points || 0; });

                const pointsEl = document.getElementById('total-points');
                if (pointsEl) pointsEl.textContent = totalPoints;
            }, (error) => {
                console.error("Error listening to points:", error);
            });

            // Attendance (Absences & Late) - Using real-time listener
            const attendanceQuery = query(collection(db, "attendance"), where("prefect_id", "==", prefectId));
            onSnapshot(attendanceQuery, (attendanceSnapshot) => {
                let totalAbsences = 0;
                let totalLate = 0;

                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    const status = (record.status || '').toLowerCase(); // Case-insensitive comparison
                    if (status === 'absent') totalAbsences++;
                    else if (status === 'late') totalLate++;
                });

                const absencesEl = document.getElementById('total-absences');
                const lateEl = document.getElementById('total-late');

                if (absencesEl) absencesEl.textContent = totalAbsences;
                if (lateEl) lateEl.textContent = totalLate;
            }, (error) => {
                console.error("Error listening to attendance:", error);
            });
        }

        async function fetchWeeklyAttendanceChart(prefectId) {
            const chartContainer = document.getElementById('weekly-attendance-chart');
            if (!chartContainer) return;

            try {
                // Use real-time listener for attendance data
                const attendanceQuery = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), limit(20));

                onSnapshot(attendanceQuery, (querySnapshot) => {
                    if (querySnapshot.empty) {
                        chartContainer.innerHTML = '<p style="color:var(--gray-500); font-size:0.9rem; text-align:center;">No attendance data available</p>';
                        return;
                    }

                    let attendanceData = [];
                    querySnapshot.forEach(doc => {
                        attendanceData.push(doc.data());
                    });

                    // Client-side sort by date (most recent first)
                    attendanceData.sort((a, b) => {
                        const dateA = a.date?.seconds ? a.date.seconds : new Date(a.date).getTime() / 1000;
                        const dateB = b.date?.seconds ? b.date.seconds : new Date(b.date).getTime() / 1000;
                        return dateB - dateA;
                    });

                    // Take last 7 records
                    attendanceData = attendanceData.slice(0, 7);

                    // Create bars based on attendance status
                    let chartHtml = '';
                    attendanceData.reverse().forEach((record) => {
                        // Assign height and color based on status (case-insensitive)
                        let barHeight = 0;
                        let barColor = 'var(--gray-400)';
                        let statusLabel = 'N/A';
                        const status = (record.status || '').toLowerCase();

                        if (status === 'present') {
                            barHeight = 100;
                            barColor = '#4caf50'; // Green
                            statusLabel = 'Present';
                        } else if (status === 'late') {
                            barHeight = 60;
                            barColor = '#fbc02d'; // Yellow/Orange
                            statusLabel = 'Late';
                        } else if (status === 'absent') {
                            barHeight = 30;
                            barColor = '#d63031'; // Red
                            statusLabel = 'Absent';
                        }

                        const dateLabel = formatDate(record.date);
                        chartHtml += `<div class="bar" style="height: ${barHeight}%; background-image: linear-gradient(to top, ${barColor}, ${barColor}dd);" data-label="${dateLabel}" data-value="${statusLabel}"></div>`;
                    });

                    chartContainer.innerHTML = chartHtml;
                }, (error) => {
                    console.error("Error listening to attendance chart data:", error);
                    chartContainer.innerHTML = '<p style="color:red; font-size:0.8rem; text-align:center;">Error loading attendance chart.</p>';
                });

            } catch (error) {
                console.error("Error fetching attendance chart:", error);
                if (chartContainer) chartContainer.innerHTML = '<p style="color:red; font-size:0.8rem; text-align:center;">Error loading chart.</p>';
            }
        }

        async function fetchRecentPoints(prefectId) {
            const recentPointsChart = document.getElementById('recent-points-chart');
            if (!recentPointsChart) return;

            try {
                // Removed orderBy to prevent index error
                const q = query(collection(db, "points"), where("prefect_id", "==", prefectId), limit(20));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    recentPointsChart.innerHTML = '<p style="color:var(--gray-500); font-size:0.9rem;">No data available</p>';
                    return;
                }

                let pointsData = [];
                querySnapshot.forEach(doc => {
                    pointsData.push(doc.data());
                });

                // Client-side sort (date desc)
                pointsData.sort((a, b) => {
                    const dateA = a.date?.seconds || 0;
                    const dateB = b.date?.seconds || 0;
                    return dateB - dateA;
                });
                // Take top 5
                pointsData = pointsData.slice(0, 5);

                const maxPoints = Math.max(...pointsData.map(p => p.points || 0));
                let chartHtml = '';

                pointsData.reverse().forEach((point) => {
                    const barHeight = maxPoints > 0 ? ((point.points || 0) / maxPoints) * 100 : 0;
                    chartHtml += `<div class="bar" style="height: ${barHeight}%;" data-label="${formatDate(point.date)}" data-value="${point.points || 0}"></div>`;
                });

                if (recentPointsChart) recentPointsChart.innerHTML = chartHtml;

                // --- NEW: Populate Points History List (Points Section) ---
                const pointsList = document.getElementById('recent-points-list');
                if (pointsList) {
                    let listHtml = '<ul class="stats-list" style="list-style:none; padding:0;">';
                    // Reuse pointsData (sorted desc)
                    pointsData.reverse(); // It was reversed for chart (asc), reverse back for list (desc)
                    // Actually pointsData was sliced top 5. We might want ALL fetched (20).
                    // Let's use the original `querySnapshot` for the list to show more info.

                    let allPoints = [];
                    querySnapshot.forEach(doc => allPoints.push(doc.data()));
                    allPoints.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

                    if (allPoints.length === 0) {
                        pointsList.innerHTML = '<p class="text-muted">No points recorded.</p>';
                    } else {
                        allPoints.forEach(point => {
                            listHtml += `<li style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem 0; border-bottom:1px solid var(--gray-100);">
                                <div>
                                    <div style="font-weight:600; color:var(--gray-800);">${point.reason || 'Points Awarded'}</div>
                                    <div style="font-size:0.85rem; color:var(--gray-500);">${formatDate(point.date)}</div>
                                </div>
                                <div style="font-weight:700; color:${(point.points || 0) > 0 ? 'green' : 'red'}; background:${(point.points || 0) > 0 ? '#e8f5e9' : '#ffebee'}; padding:4px 10px; border-radius:12px;">
                                    ${(point.points || 0) > 0 ? '+' : ''}${point.points || 0}
                                </div>
                            </li>`;
                        });
                        listHtml += '</ul>';
                        pointsList.innerHTML = listHtml;
                    }
                }

            } catch (error) {
                console.error("Error fetching points:", error);
                if (recentPointsChart) recentPointsChart.innerHTML = '<p style="color:red; font-size:0.8rem;">Error loading points.</p>';
                const pointsList = document.getElementById('recent-points-list');
                if (pointsList) pointsList.innerHTML = `<p class='text-error'>Error: ${error.message}</p>`;
            }
        }

        function formatDate(date) {
            if (!date) return '-';
            if (date.seconds) return new Date(date.seconds * 1000).toLocaleDateString();
            const d = new Date(date);
            return isNaN(d.getTime()) ? '-' : d.toLocaleDateString();
        }

        /* --- ATTENDANCE LOGIC --- */
        async function fetchRecentAttendance(prefectId) {
            const attendanceList = document.getElementById('recent-attendance-list');
            if (!attendanceList) return;

            try {
                // Removed orderBy to prevent index error
                const q = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), limit(20));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    attendanceList.innerHTML = '<p class="text-muted">No recent attendance records.</p>';
                    return;
                }

                let records = [];
                querySnapshot.forEach(doc => records.push(doc.data()));

                // Client-side sort
                records.sort((a, b) => {
                    // Handle string dates or timestamp objects
                    const dateA = a.date?.seconds ? a.date.seconds : new Date(a.date).getTime() / 1000;
                    const dateB = b.date?.seconds ? b.date.seconds : new Date(b.date).getTime() / 1000;
                    return dateB - dateA;
                });

                let html = '<ul class="stats-list" style="list-style:none; padding:0;">';
                records.forEach(record => {
                    let statusColor = 'gray';
                    if (record.status === 'present') statusColor = 'green';
                    if (record.status === 'absent') statusColor = 'red';
                    if (record.status === 'late') statusColor = 'orange';

                    html += `<li style="display:flex; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid var(--gray-100);">
                        <span>${formatDate(record.date)}</span> 
                        <span style="color:${statusColor}; font-weight:500; text-transform:capitalize;">${record.status || 'N/A'}</span>
                    </li>`;
                });
                html += '</ul>';
                attendanceList.innerHTML = html;
            } catch (e) {
                console.error("Error fetching attendance:", e);
                attendanceList.innerHTML = '<p class="text-error">Error loading records.</p>';
            }
        }

        async function checkForAbsenceReason(prefectId) {
            const absentReasonContainer = document.getElementById('absent-reason-container');
            if (!absentReasonContainer) return;

            const q = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), where("status", "==", "Absent"), where("reason", "==", null), orderBy("date", "desc"), limit(1));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const latestAttendance = querySnapshot.docs[0];
                const data = latestAttendance.data();

                absentReasonContainer.innerHTML = `
                    <div class="dashboard-card" style="border-left: 4px solid #d63031; padding: 1.5rem; background: #fff0f0;">
                        <h3 style="color: #d63031; margin-top:0;">Action Required: Absence Reason</h3>
                        <p>You were marked ABSENT on <strong>${formatDate(data.date)}</strong>. Please provide a reason.</p>
                        <form id="absence-reason-form" style="margin-top:1rem;">
                            <select id="absence-reason-select" style="padding:0.5rem; border-radius:4px; border:1px solid #ccc; width:100%; margin-bottom:0.5rem;">
                                <option value="" disabled selected>Select Reason</option>
                                <option value="Sick">Sick / Medical</option>
                                <option value="Family Emergency">Family Emergency</option>
                                <option value="Exam / Tuition">Exam / Tuition</option>
                                <option value="Transport Issue">Transport Issue</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="text" id="absence-reason-other" placeholder="Specify reason..." style="display:none; padding:0.5rem; border-radius:4px; border:1px solid #ccc; width:100%; margin-bottom:0.5rem;">
                            <button type="submit" id="absence-submit-btn" style="background:#d63031; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer;">Submit Reason</button>
                        </form>
                    </div>
                `;

                const absenceReasonSelect = document.getElementById('absence-reason-select');
                const absenceReasonOther = document.getElementById('absence-reason-other');
                const form = document.getElementById('absence-reason-form');

                absenceReasonSelect.addEventListener('change', () => {
                    absenceReasonOther.style.display = absenceReasonSelect.value === 'Other' ? 'block' : 'none';
                });

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    let reason = absenceReasonSelect.value;
                    if (reason === 'Other') reason = absenceReasonOther.value.trim();
                    if (!reason) return alert('Please provide a reason.');

                    try {
                        await updateDoc(doc(db, "attendance", latestAttendance.id), { reason: reason });
                        absentReasonContainer.innerHTML = '<div class="dashboard-card" style="padding:1.5rem; background:#e8f5e9; color:#2e7d32;"><i class="fas fa-check-circle"></i> Reason submitted successfully.</div>';
                    } catch (err) {
                        alert("Error: " + err.message);
                    }
                });
            } else {
                absentReasonContainer.innerHTML = ''; // Clear if no pending absences
            }
        }

        /* --- PERFORMANCE LOGIC --- */
        async function fetchBadWork(prefectId) {
            const badWorkList = document.getElementById('bad-work-list');
            if (!badWorkList) return;

            try {
                // Removed orderBy
                const q = query(collection(db, "bad_work"), where("prefect_id", "==", prefectId), limit(20));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    badWorkList.innerHTML = '<p class="text-muted">No performance issues recorded. Keep it up!</p>';
                    return;
                }

                let records = [];
                querySnapshot.forEach(doc => records.push(doc.data()));

                // Client sort
                records.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

                let html = '<ul class="stats-list" style="list-style:none; padding:0;">';
                records.forEach(record => {
                    html += `<li style="padding:0.5rem 0; border-bottom:1px solid var(--gray-100);">
                        <div style="font-weight:600; color:#d63031;">${formatDate(record.date)}</div>
                        <div style="color:var(--gray-700);">${record.description}</div>
                    </li>`;
                });
                html += '</ul>';
                badWorkList.innerHTML = html;
            } catch (error) {
                console.error("Error fetching bad work:", error);
                badWorkList.innerHTML = '<p class="text-error">Error loading records.</p>';
            }
        }

        /* --- EVENTS LOGIC --- */
        function loadEvents() {
            const eventsListDiv = document.getElementById('events-list');
            const eventsQuery = query(collection(db, 'events'), orderBy("date", "desc"), limit(10));
            onSnapshot(eventsQuery, (snapshot) => {
                const list = document.getElementById('events-list');
                if (!list) return;

                list.innerHTML = snapshot.empty ? '<p style="padding:1rem;">No events scheduled.</p>' : '';
                snapshot.forEach(eventDoc => {
                    const event = { id: eventDoc.id, ...eventDoc.data() };
                    list.appendChild(createEventCard(event));
                });
            }, (error) => {
                console.error("Error loading events:", error);
                const list = document.getElementById('events-list');
                if (list) list.innerHTML = '<p style="padding:1rem; color:red;">Error loading events.</p>';
            });
        }

        function createEventCard(event) {
            const card = document.createElement('div');
            card.className = 'dashboard-card'; // Use existing card class or custom
            card.style.marginBottom = '1rem';
            card.style.borderLeft = '4px solid var(--primary-color)';
            card.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                        <h3 style="margin:0; font-size:1.1rem;">${event.title}</h3>
                        <span style="font-size:0.85rem; color:var(--gray-500);">${formatDate(event.date)}</span>
                    </div>
                    <p style="color:var(--gray-600); font-size:0.95rem; margin-bottom:1rem;">${event.description || 'No description.'}</p>
                    <button onclick="toggleDuties('${event.id}')" style="background: var(--primary-100); color: var(--primary-700); border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight:500; font-size:0.9rem;">
                        <i class="fas fa-tasks"></i> View Duties
                    </button>
                    <ul id="duties-for-${event.id}" style="display: none; margin-top: 1rem; padding-left: 1rem; border-top:1px solid var(--gray-200); padding-top:1rem;"></ul>
                </div>`;
            return card;
        }

        window.toggleDuties = function (eventId) {
            const dutiesList = document.getElementById(`duties-for-${eventId}`);
            if (dutiesList.style.display === 'none') {
                dutiesList.style.display = 'block';
                if (dutiesList.innerHTML === '') {
                    dutiesList.innerHTML = '<li style="color:var(--gray-500);">Loading duties...</li>';
                    loadDutiesForEvent(eventId);
                }
            } else {
                dutiesList.style.display = 'none';
            }
        };

        function loadDutiesForEvent(eventId) {
            const dutiesList = document.getElementById(`duties-for-${eventId}`);
            const dutiesQuery = query(collection(db, 'event_duties'), where('eventId', '==', eventId));
            onSnapshot(dutiesQuery, (snapshot) => {
                dutiesList.innerHTML = snapshot.empty ? "<li style='color:var(--gray-500);'>No duties listed.</li>" : '';
                snapshot.forEach(dutyDoc => {
                    const duty = { id: dutyDoc.id, ...dutyDoc.data() };
                    dutiesList.appendChild(createDutyItem(duty));
                });
            });
        }

        function createDutyItem(duty) {
            const item = document.createElement('li');
            item.style.marginBottom = '0.5rem';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';

            const isTaken = !!duty.assignedPrefectName;

            item.innerHTML = `
                <span style="font-weight:500;">${duty.title}</span>
                <div>
                    ${isTaken ? `<span style="font-size:0.85rem; background:#e8f5e9; color:#2e7d32; padding:2px 8px; border-radius:4px;">Taken by: ${duty.assignedPrefectName}</span>`
                    : `<button class="take-duty-btn" style="background:var(--primary-600); color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem;">Take Duty</button>`}
                </div>`;

            if (!isTaken) {
                item.querySelector('.take-duty-btn').addEventListener('click', () => takeDuty(duty.id));
            }
            return item;
        }

        async function takeDuty(dutyId) {
            const user = auth.currentUser;
            if (!user) return alert("Please login first.");

            // We need currentPrefect data. It should be fetched in global scope or cached.
            // For now, let's fetch it again or assume we can get it from DOM or a global var.
            // In dashboard.html there was a global 'currentPrefect'. I should add that to onAuthStateChanged.

            // Simplification: Fetch prefect ID from DOM (hidden input or similar) or re-query.
            // Better: define currentPrefect globally.

            // Quick fix: query prefects by uid
            const prefectsRef = collection(db, "prefects");
            const q = query(prefectsRef, where("uid", "==", user.uid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return alert("Prefect profile not found.");
            const prefectData = snapshot.docs[0].data();
            const prefectId = snapshot.docs[0].id;

            const dutyRef = doc(db, 'event_duties', dutyId);
            try {
                const dutySnap = await getDoc(dutyRef);
                if (dutySnap.exists() && dutySnap.data().assignedPrefectId) {
                    return alert("Sorry, this duty was just taken!");
                }
                await updateDoc(dutyRef, {
                    assignedPrefectId: prefectId,
                    assignedPrefectName: prefectData.name
                });
                alert("Duty assigned to you successfully!");
            } catch (error) {
                console.error("Error taking duty: ", error);
                alert(`Error: ${error.message}`);
            }
        }

        /* --- IDEAS LOGIC --- */
        let currentPrefectGlobal = null; // Store for easy access

        function initializeIdeas() {
            setupForm();
            // loadMyIdeas(); // Disabled to match dashboard.html and avoid permission errors
            loadPublicIdeas();
        }

        function setupForm() {
            const form = document.getElementById('idea-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                // Ensure we have prefect data
                if (!currentPrefectGlobal) {
                    const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) {
                        currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    } else {
                        return alert("Profile error.");
                    }
                }

                const submitBtn = document.getElementById('idea-submit-btn');
                const messageEl = document.getElementById('submit-message');
                submitBtn.disabled = true;
                messageEl.textContent = 'Submitting...';

                try {
                    await addDoc(collection(db, 'ideas_proposals'), {
                        prefectId: currentPrefectGlobal.id,
                        prefectName: currentPrefectGlobal.name,
                        title: document.getElementById('idea-title').value,
                        description: document.getElementById('idea-description').value,
                        status: 'Pending_Approval',
                        timestamp: serverTimestamp(),
                        upvotes: 0,
                        upvotedBy: []
                    });
                    form.reset();
                    messageEl.textContent = 'Submitted successfully!';
                    messageEl.style.color = 'green';
                } catch (error) {
                    messageEl.textContent = `Error: ${error.message}`;
                    messageEl.style.color = 'red';
                }
                submitBtn.disabled = false;
                setTimeout(() => messageEl.textContent = '', 4000);
            });
        }

        function loadMyIdeas() {
            const user = auth.currentUser;
            if (!user) return;
            // Need prefectID. Let's wait or retry if global not set? 
            // Better: call this after global is set in onAuthStateChanged

            // For now, assume global IS set because we call this inside onAuth
            setTimeout(async () => {
                if (!currentPrefectGlobal) {
                    const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                }

                if (!currentPrefectGlobal) {
                    console.error("CurrentPrefectGlobal is missing inside timeout!");
                    return;
                }
                console.log("Loading ideas for Prefect ID:", currentPrefectGlobal.id);

                const myList = document.getElementById('my-ideas-list');
                // Strict match with ideas.html: orderBy timestamp desc, NO LIMIT
                const q = query(collection(db, 'ideas_proposals'), where('prefectId', '==', currentPrefectGlobal.id), orderBy('timestamp', 'desc'));

                onSnapshot(q, (snapshot) => {
                    if (!myList) return;
                    if (snapshot.empty) {
                        myList.innerHTML = "<p class='text-muted'>You haven't submitted any ideas yet.</p>";
                    } else {
                        myList.innerHTML = '';
                        // No need for client-side sort if query has orderBy, but kept for safety or remove? 
                        // ideas.html relies on query sort.
                        snapshot.forEach(doc => myList.appendChild(renderIdea({ ...doc.data(), id: doc.id }, false, doc.id)));
                    }
                }, (error) => {
                    console.error("Error loading my ideas:", error);
                    if (myList) myList.innerHTML = `<p class='text-error'>Error: ${error.message} (PrefectID: ${currentPrefectGlobal.id})</p>`;
                });
            }, 1000); // Slight delay to ensure auth
        }

        function loadPublicIdeas() {
            const publicList = document.getElementById('public-ideas-list');
            // Removed orderBy. STATUS MUST MATCH ALLOWED VALUES IN SECURITY RULES (likely 'Pending' not 'Pending_Approval')
            const q = query(collection(db, 'ideas_proposals'), where('status', 'in', ['Pending', 'Approved', 'Completed']), limit(20));
            onSnapshot(q, (snapshot) => {
                if (!publicList) return;
                if (snapshot.empty) {
                    publicList.innerHTML = "<p class='text-muted'>No public proposals.</p>";
                } else {
                    publicList.innerHTML = '';
                    let docs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    // Client-side sort: desc
                    docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                    docs.forEach(data => publicList.appendChild(renderIdea(data, true, data.id)));
                }
            }, (error) => {
                console.error("Error loading public ideas:", error);
                if (publicList) publicList.innerHTML = "<p class='text-error'>Error loading public proposals.</p>";
            });
        }


        function renderIdea(idea, isPublic, docId) {
            const item = document.createElement('div');
            item.className = 'idea-item';
            item.style.padding = '1rem';
            item.style.borderBottom = '1px solid var(--gray-200)';

            const normalizedStatus = idea.status.replace('_', ' ');
            let statusColor = 'var(--gray-600)';
            if (idea.status.includes('Approved')) statusColor = 'green';
            if (idea.status.includes('Pending')) statusColor = 'orange';

            const dateString = idea.timestamp ? new Date(idea.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';

            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <h4 style="margin:0; font-size:1rem;">${idea.title}</h4>
                    <span style="font-size:0.75rem; background:${statusColor === 'green' ? '#e8f5e9' : '#fff3e0'}; color:${statusColor}; padding:2px 8px; border-radius:12px;">${normalizedStatus}</span>
                </div>
                <p style="font-size:0.8rem; color:var(--gray-500); margin:0.25rem 0;">By ${idea.prefectName} on ${dateString}</p>
                <p style="font-size:0.9rem; color:var(--gray-700); margin-top:0.5rem;">${idea.description}</p>
                ${isPublic ? `
                <div style="margin-top:0.75rem; display:flex; gap:1rem; align-items:center;">
                    <button class="upvote-btn" data-id="${docId}">
                        <i class="fas fa-thumbs-up"></i> Upvote
                    </button>
                    <span style="font-size:0.85rem; color:var(--gray-600);">${idea.upvotes || 0} Upvotes</span>
                </div>` : ''}`;

            if (isPublic) {
                const upvoteBtn = item.querySelector('.upvote-btn');
                if (currentPrefectGlobal && idea.upvotedBy && idea.upvotedBy.includes(currentPrefectGlobal.id)) {
                    upvoteBtn.classList.add('active-upvote');
                    upvoteBtn.disabled = true;
                    upvoteBtn.innerHTML = '<i class="fas fa-heart"></i> Upvoted';
                }
                if (!upvoteBtn.disabled) {
                    upvoteBtn.addEventListener('click', () => handleUpvote(docId));
                }
            }
            return item;
        }

        async function handleUpvote(docId) {
            if (!currentPrefectGlobal) return alert("Login error");
            const ideaRef = doc(db, "ideas_proposals", docId);
            try {
                await runTransaction(db, async (transaction) => {
                    const ideaDoc = await transaction.get(ideaRef);
                    if (!ideaDoc.exists()) throw "Document does not exist!";
                    const data = ideaDoc.data();
                    const upvotedBy = data.upvotedBy || [];
                    if (upvotedBy.includes(currentPrefectGlobal.id)) return;
                    transaction.update(ideaRef, {
                        upvotes: (data.upvotes || 0) + 1,
                        upvotedBy: arrayUnion(currentPrefectGlobal.id)
                    });
                });
            } catch (e) {
                console.error("Upvote failed: ", e);
            }
        }


        // --- NOTIFICATION & ANNOUNCEMENT LOGIC ---
        let allAnnouncementsGlobal = [];

        function loadAnnouncements() {
            const notificationsList = document.getElementById('notifications-list');
            const dropdownList = document.getElementById('notification-dropdown-list');
            const badgeCount = document.getElementById('notification-badge-count');

            try {
                const q = query(collection(db, "announcements"), orderBy("timestamp", "desc"), limit(20));
                onSnapshot(q, (snapshot) => {
                    allAnnouncementsGlobal = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Update badge count
                    if (badgeCount) badgeCount.textContent = allAnnouncementsGlobal.length;

                    // Populate Sidebar List
                    if (notificationsList) {
                        if (snapshot.empty) {
                            notificationsList.innerHTML = '<p style="padding: 1rem; color:var(--gray-500);">No announcements found.</p>';
                        } else {
                            notificationsList.innerHTML = '';
                            allAnnouncementsGlobal.forEach(ann => {
                                const item = document.createElement('div');
                                item.className = 'notification-item';
                                // Simplified render for sidebar
                                item.innerHTML = `
                                    <strong>${ann.title}</strong>
                                    <p style="font-size:0.85rem; color:var(--gray-600); margin-top:0.25rem;">${ann.content}</p>
                                    <small style="color:var(--gray-400); font-size:0.7rem;">${ann.timestamp ? new Date(ann.timestamp.seconds * 1000).toLocaleDateString() : ''}</small>
                                `;
                                notificationsList.appendChild(item);
                            });
                        }
                    }

                    // Populate Header Dropdown
                    if (dropdownList) {
                        dropdownList.innerHTML = '';
                        if (snapshot.empty) {
                            dropdownList.innerHTML = '<div style="padding:1rem; text-align:center; color:var(--gray-500);">No notifications</div>';
                        } else {
                            allAnnouncementsGlobal.slice(0, 5).forEach(ann => {
                                const item = document.createElement('div');
                                item.className = 'notification-item';
                                item.innerHTML = `
                                    <h5 style="margin:0; font-size:0.9rem;">${ann.title}</h5>
                                    <p style="margin:0; font-size:0.8rem; color:var(--gray-500); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${ann.content}</p>
                                `;
                                dropdownList.appendChild(item);
                            });
                        }
                    }
                }, (error) => {
                    console.error("Error loading announcements snapshot:", error);
                    // Handle missing index or permission errors gracefully
                    if (notificationsList) notificationsList.innerHTML = '<p style="padding:1rem; color:red;">Error loading content. Check permissions/indexes.</p>';
                });
            } catch (e) {
                console.error("Error initializing announcements query:", e);
            }
        }

        // Header Notification Toggle
        const headerNotificationBtn = document.getElementById('header-notification-btn');
        const notificationDropdownPanel = document.getElementById('notification-dropdown-panel');
        if (headerNotificationBtn && notificationDropdownPanel) {
            headerNotificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationDropdownPanel.classList.toggle('active');
            });
            document.addEventListener('click', (e) => {
                if (!notificationDropdownPanel.contains(e.target) && !headerNotificationBtn.contains(e.target)) {
                    notificationDropdownPanel.classList.remove('active');
                }
            });
        }

        // --- CHAT LOGIC ---
        const chatFab = document.getElementById('chatFab');
        const chatContainer = document.getElementById('chatContainer');
        const chatClose = document.getElementById('chatClose');
        const chatSend = document.getElementById('chatSend');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');
        let isChatOpen = false;
        let chatUnsubscribe = null;

        function initializeChat(user) {
            chatFab.addEventListener('click', () => {
                isChatOpen = !isChatOpen;
                chatContainer.classList.toggle('active');
                if (isChatOpen) {
                    listenForMessages(user.uid);
                }
            });
            chatClose.addEventListener('click', () => {
                isChatOpen = false;
                chatContainer.classList.remove('active');
            });
            chatSend.addEventListener('click', () => sendMessage(user));
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(user); });
        }

        function listenForMessages(uid) {
            if (chatUnsubscribe) chatUnsubscribe();

            try {
                const messagesRef = collection(db, 'chats', uid, 'messages');
                const q = query(messagesRef, orderBy('timestamp'), limit(50));

                chatUnsubscribe = onSnapshot(q, (snapshot) => {
                    chatMessages.innerHTML = '';
                    if (snapshot.empty) chatMessages.innerHTML = '<div class="message bot-message">Hello! How can we help you today?</div>';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const div = document.createElement('div');
                        div.className = `message ${msg.senderId === uid ? 'user-message' : 'bot-message'}`;
                        div.textContent = msg.text;
                        chatMessages.appendChild(div);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, (error) => {
                    console.error("Chat Listener Error:", error);
                    chatMessages.innerHTML = '<p class="text-error" style="text-align:center; padding:1rem;">Error loading chat history.</p>';
                });
            } catch (e) {
                console.error("Error setting up chat listener:", e);
            }
        }

        async function sendMessage(user) {
            const text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = '';

            try {
                // Ensure chat doc exists
                await setDoc(doc(db, 'chats', user.uid), {
                    userEmail: user.email,
                    lastUpdate: serverTimestamp()
                }, { merge: true });

                await addDoc(collection(db, 'chats', user.uid, 'messages'), {
                    text: text,
                    senderId: user.uid,
                    timestamp: serverTimestamp(),
                    read: false
                });
            } catch (e) {
                console.error("Chat Send Error", e);
                alert("Failed to send message: " + e.message);
            }
        }

        // --- FUTURE ABSENCE LOGIC ---
        function initializeFutureAbsenceForm(user) {
            const form = document.getElementById('future-absence-form');
            const dateInput = document.getElementById('future-absence-date');
            const select = document.getElementById('replacement-prefect-select');
            const message = document.getElementById('future-absence-message');

            if (!select) {
                console.warn("Replacement select element not found!");
                return;
            }

            // Fill Prefects with error handling
            getDocs(collection(db, 'prefects')).then(snap => {
                select.innerHTML = '<option value="">Select Replacement</option>';
                if (snap.empty) {
                    const opt = document.createElement('option');
                    opt.textContent = "No other prefects found";
                    opt.disabled = true;
                    select.appendChild(opt);
                    return;
                }
                snap.forEach(doc => {
                    const d = doc.data();
                    if (doc.id !== user.uid) { // Exclude self
                        const opt = document.createElement('option');
                        opt.value = doc.id;
                        opt.textContent = d.name || d.email || "Unknown Prefect";
                        opt.dataset.name = d.name || d.email || "Unknown";
                        select.appendChild(opt);
                    }
                });
            }).catch(err => {
                console.error("Error fetching prefects:", err);
                select.innerHTML = '<option value="">Error loading list</option>';
            });

            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentPrefectGlobal) return alert("System refreshing... please try again in a moment.");

                    const btn = document.getElementById('future-absence-submit-btn');
                    btn.disabled = true;
                    btn.textContent = "Submitting...";

                    try {
                        const selectedOption = select.options[select.selectedIndex];
                        if (!selectedOption || !selectedOption.value) throw new Error("Please select a replacement prefect.");

                        const replacementName = selectedOption.dataset.name;

                        await addDoc(collection(db, 'future_absences'), {
                            prefect_id: currentPrefectGlobal.id,
                            prefect_name: currentPrefectGlobal.name,
                            absence_date: dateInput.value,
                            replacement_prefect_id: select.value,
                            replacement_prefect_name: replacementName,
                            reason: document.getElementById('future-absence-reason').value,
                            status: 'pending',
                            timestamp: serverTimestamp()
                        });
                        message.textContent = "Request submitted successfully!";
                        message.style.color = "green";
                        form.reset();
                    } catch (err) {
                        console.error("Absence Request Error:", err);
                        message.textContent = "Error: " + err.message;
                        message.style.color = "red";
                    }
                    btn.disabled = false;
                    btn.textContent = "Submit Request";
                });
            }
        }
    </script>

    <button class="chat-fab" id="chatFab">
        <i class="fas fa-comments"></i>
        <div id="chat-notification-badge" class="badge"
            style="display: none; position:absolute; top:0; right:0; background:red;">!</div>
    </button>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h3>Prefect Support</h3>
            <button class="chat-close" id="chatClose"
                style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">Hello! How can we help you today?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message...">
            <button class="chat-send" id="chatSend"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</body>

</html>
