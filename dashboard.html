<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Prefects' Guild | New Era</title>
    <link rel="icon" href="meroon Transparent logo prefect.png" type="image/png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- DESIGN SYSTEM : MAROON & GOLD PREMIUM --- */
        :root {
            /* Core Colors */
            --primary-700: #58120c;
            /* Deep Maroon */
            --primary-600: #720e0e;
            /* Standard Maroon */
            --primary-500: #942b2b;
            /* Light Maroon */
            --primary-100: #fce8e8;
            /* Pale Maroon */

            --gold-700: #9c7c25;
            --gold-500: #D4AF37;
            /* Metallic Gold */
            --gold-300: #f0d676;
            --gold-100: #fbf5dc;

            /* Neutrals */
            --gray-900: #1a1a1a;
            --gray-600: #5c5c5c;
            --gray-500: #808080;
            --gray-200: #e5e5e5;
            --gray-100: #f5f5f5;
            --white: #ffffff;

            /* Backgrounds (CLEAN THEME) */
            --bg-body: #f3f4f6;
            /* Soft Gray */
            --bg-body-gradient: none;

            --bg-surface: #ffffff;
            --bg-panel: #ffffff;

            /* Effects (CLEAN) */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-glass: none;
            --glass-blur: none;
            --border-glass: 1px solid #e5e7eb;
            /* Light Gray Border */

            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;

            /* Sizing */
            --sidebar-width: 280px;
            --header-height: 80px;
            --radius-xl: 24px;
            --radius-lg: 16px;
        }

        /* --- RESET & BASE --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-body);
            /* Removed Gradient */
            color: var(--gray-900);
            height: 100dvh;
            /* Use dynamic viewport height */
            width: 100%;
            overflow: hidden;
            /* Prevent body scroll entirely */
            display: flex;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: 0.3s;
        }

        ul {
            list-style: none;
        }

        button {
            font-family: inherit;
            cursor: pointer;
        }

        /* --- LAYOUT GRID --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100dvh;
            /* Full viewport fixed */
            overflow: hidden;
        }

        /* --- SIDEBAR (MODERN) --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #ffffff;
            /* Solid White */
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            position: relative;
            z-index: 50;
            box-shadow: none;
            /* Clean look */
            /* Subtle separation */
            transition: transform 0.3s ease;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2.5rem;
            padding: 0 0.5rem;
        }

        .brand img {
            height: 48px;
            filter: drop-shadow(0 4px 6px rgba(114, 14, 14, 0.2));
        }

        .brand-text h1 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-600);
            line-height: 1;
            letter-spacing: -0.5px;
        }

        .brand-text span {
            font-size: 0.75rem;
            color: var(--gold-700);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.85rem 1rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--gray-600);
            font-weight: 500;
            font-size: 0.95rem;
            position: relative;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
            color: var(--gray-500);
            transition: 0.3s;
        }

        .nav-item:hover {
            background-color: var(--primary-100);
            color: var(--primary-700);
        }

        .nav-item:hover i {
            color: var(--primary-600);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: var(--white);
            box-shadow: 0 8px 20px rgba(114, 14, 14, 0.25);
        }

        .nav-item.active i {
            color: var(--gold-500);
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: var(--border-light);
            padding-top: 1.5rem;
        }

        .logout-btn {
            width: 100%;
            padding: 1rem;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, #2d3436, #000000);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-body);
            position: relative;
            height: 100dvh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* --- HEADER --- */
        .header {
            height: var(--header-height);
            padding: 0 2.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 90;
            background: rgba(244, 246, 249, 0.85);
            /* Matches bg-body with opacity */
            backdrop-filter: blur(10px);
        }

        .page-title h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .page-title span {
            color: var(--gray-500);
            font-weight: 400;
            margin-left: 0.5rem;
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid var(--gray-200);
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--gray-600);
            transition: 0.3s;
            position: relative;
        }

        .btn-icon:hover {
            border-color: var(--primary-500);
            color: var(--primary-600);
            transform: rotate(10deg);
        }

        .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--gold-500);
            color: var(--white);
            font-size: 0.65rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: 0.35rem 0.35rem 0.35rem 1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.3s;
        }

        .profile-btn:hover {
            border-color: var(--primary-500);
            box-shadow: var(--shadow-sm);
        }

        .profile-info {
            text-align: right;
            line-height: 1.2;
        }

        .profile-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--gray-900);
            display: block;
        }

        .profile-role {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .profile-img {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--gold-500);
        }

        /* --- DASHBOARD CONTENT GRID (BENTO) --- */
        .content-wrapper {
            padding: 1rem 2.5rem 2.5rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- SMART DASHBOARD LAYOUT (NEW) --- */
        .smart-dashboard-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            height: calc(100vh - 140px);
            overflow: hidden;
        }

        .main-feed {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            padding-right: 0.5rem;
            /* Space for scrollbar */
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        /* Smart Hero */
        .smart-hero {
            background: #ffffff;
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            border: 1px solid #f1f5f9;
        }

        .hero-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .hero-profile-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f1f5f9;
            /* Soft border */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .hero-text h1 {
            font-family: var(--font-display);
            font-size: 1.8rem;
            /* Reduced from 2.5rem to fit long names */
            color: var(--gray-900);
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }

        .hero-text p {
            font-size: 1rem;
            color: var(--gray-500);
        }

        .hero-status {
            text-align: right;
        }

        .status-badge {
            background: #ecfdf5;
            color: #059669;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .status-badge.busy {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Metrics Hub */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .smart-metric {
            background: #fff;
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 160px;
            box-shadow: var(--shadow-sm);
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .smart-metric:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: #f8fafc;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            font-size: 1.2rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-display);
            color: var(--gray-900);
            line-height: 1;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        /* Action Dock */
        .action-dock {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: auto;
        }

        .dock-item {
            background: #fff;
            border: 1px solid #f1f5f9;
            border-radius: 20px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .dock-item:hover {
            background: var(--primary-600);
            border-color: var(--primary-600);
            box-shadow: 0 10px 25px rgba(114, 14, 14, 0.3);
        }

        .dock-item i {
            font-size: 1.8rem;
            color: var(--primary-600);
            transition: 0.3s;
        }

        .dock-item span {
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .dock-item:hover i,
        .dock-item:hover span {
            color: #fff;
        }

        /* Leaderboard Widget */
        .leaderboard-widget {
            background: #fff;
            border-radius: 24px;
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            box-shadow: var(--shadow-sm);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .leader-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #f8fafc;
        }

        .leader-item:last-child {
            border-bottom: none;
        }

        .leader-rank {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--gray-400);
            width: 25px;
        }

        .leader-rank.top-1 {
            color: var(--gold-500);
        }

        @media (max-width: 1024px) {
            .smart-dashboard-layout {
                grid-template-columns: 1fr;
                height: auto;
                overflow: visible;
            }

            .smart-dashboard-layout {
                padding-bottom: 2rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .smart-hero {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .hero-status {
                text-align: center;
            }

            .smart-hero::after {
                width: 100%;
                height: 6px;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .action-dock {
                grid-template-columns: repeat(2, 1fr);
            }
        }


        /* --- Bar Chart --- */
        .bar-chart-container {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: flex-end;
        }

        .bar-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 100%;
            width: 100%;
        }

        @keyframes growBar {
            from {
                transform: scaleY(0);
            }

            to {
                transform: scaleY(1);
            }
        }

        .bar {
            width: 12%;
            background-image: linear-gradient(to top, var(--primary-700), var(--primary-500));
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: all 0.3s ease;
            transform-origin: bottom;
            animation: growBar 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        .bar:hover {
            opacity: 0.9;
            transform: scaleY(1.05);
        }

        .bar::before {
            content: attr(data-value);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--gray-900);
            opacity: 0;
            transition: 0.3s;
        }

        .bar:hover::before {
            opacity: 1;
            top: -30px;
        }

        .bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--gray-500);
            white-space: nowrap;
        }

        /* --- Profile Section --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Upvote Button Animations */
        .upvote-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid var(--gray-300);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            color: var(--gray-600);
        }

        .upvote-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .upvote-btn:active {
            transform: translateY(1px) scale(0.95);
        }

        .upvote-btn i {
            transition: transform 0.3s ease;
        }

        .upvote-btn:hover i {
            transform: scale(1.2) rotate(-10deg);
        }

        .upvote-btn.active-upvote {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(114, 14, 14, 0.3);
        }

        .upvote-btn.active-upvote:hover {
            color: white;
        }

        .profile-header-large {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 2rem;
        }

        .profile-page-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--white);
            box-shadow: var(--shadow-md);
        }

        .profile-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            background: var(--gray-100);
            color: var(--gray-900);
            font-family: inherit;
            transition: 0.3s;
        }

        .form-group input:focus {
            background: var(--white);
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        .form-group input:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* --- About Us Section --- */
        .about-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .about-card {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .team-member {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: 0.3s;
        }

        .team-member:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .team-member img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 1rem;
            object-fit: cover;
        }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        .mobile-menu-btn {
            display: none;
        }

        .sidebar-overlay {
            display: none;
        }

        @media (max-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .card-actions {
                grid-column: span 2;
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .action-list {
                flex-wrap: wrap;
                width: 100%;
            }

            .btn-action {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                height: 100%;
                z-index: 1000;
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.3);
                transition: left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
                /* Smooth slide animation */
            }

            .sidebar.active {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                backdrop-filter: blur(4px);
                opacity: 0;
                transition: opacity 0.3s ease;
                /* Smooth fade for overlay */
                pointer-events: none;
                /* Prevent clicks when hidden */
            }

            .sidebar-overlay.show {
                display: block;
                opacity: 1;
                pointer-events: all;
            }

            .mobile-menu-btn {
                display: block;
                background: transparent;
                border: none;
                font-size: 1.5rem;
                color: var(--gray-700);
            }

            .header {
                padding: 0 1rem;
                justify-content: space-between;
                position: sticky;
                top: 0;
                z-index: 900;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(8px);
            }

            .content-wrapper {
                padding: 1rem;
                padding-bottom: 6rem;
            }

            /* --- Refined Mobile Bento Grid --- */
            .bento-grid {
                /* Keep 2 columns even on mobile for stats */
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            /* Welcome Card: Full Width */
            .card-welcome {
                grid-column: span 2 !important;
                flex-direction: column-reverse;
                text-align: center;
                gap: 1.5rem;
                padding: 1.5rem;
            }

            .welcome-content h2 {
                font-size: 1.5rem;
            }

            .welcome-img {
                width: 100px;
                height: 100px;
            }

            /* Stats: 1 Column each (default behavior, so 2 per row) */
            .card-stat {
                padding: 1rem;
                /* No grid-column override needed, they take 1 slot */
            }

            /* Actions: Full Width */
            .card-actions {
                grid-column: span 2 !important;
                flex-direction: column;
                align-items: flex-start;
            }

            .action-list {
                /* Make buttons 2x2 grid or scrollable? Let's do stacked or grid */
                display: grid;
                grid-template-columns: 1fr 1fr;
                width: 100%;
                gap: 0.5rem;
            }

            .btn-action {
                justify-content: center;
                font-size: 0.85rem;
            }

            /* Chart: Full Width */
            .card[style*="grid-column: span 2"] {
                grid-column: span 2 !important;
                min-height: 250px !important;
            }
        }

        /* --- NOTIFICATION DROPDOWN --- */
        .notification-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            width: 320px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            z-index: 1000;
            display: none;
            overflow: hidden;
            flex-direction: column;
        }

        .notification-dropdown.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            font-size: 1rem;
            color: var(--primary-700);
            margin: 0;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-body);
        }

        .notification-item.unread {
            background: #fff8f8;
            border-left: 3px solid var(--primary-500);
        }

        .notification-footer {
            padding: 0.75rem;
            text-align: center;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-100);
        }

        .view-all-btn {
            color: var(--primary-600);
            font-size: 0.85rem;
            font-weight: 600;
            background: none;
            border: none;
        }

        /* --- CHAT BOT FLOATING UI --- */
        .chat-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: var(--white);
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 15px rgba(114, 14, 14, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .chat-fab:hover {
            transform: scale(1.1);
        }

        .chat-container {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 350px;
            height: 500px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            z-index: 999;
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: 0.3s ease;
            border: 1px solid var(--border-light);
        }

        .chat-container.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .chat-header {
            background: var(--primary-700);
            color: var(--white);
            padding: 1rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--bg-body);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary-600);
            color: var(--white);
            border-bottom-right-radius: 2px;
        }

        .bot-message {
            align-self: flex-start;
            background: var(--white);
            border: 1px solid var(--gray-200);
            color: var(--gray-900);
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.5rem;
            background: var(--white);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 20px;
            font-family: inherit;
        }

        .chat-send {
            background: var(--primary-600);
            color: var(--white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        /* --- FUTURE ABSENCE FORM --- */
        .future-absence-form {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-top: 1.5rem;
        }

        /* --- IDEAS UI IMPROVEMENTS --- */
        .supiri-btn {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-700));
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
        }

        .supiri-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.6);
        }

        .idea-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: 0.3s;
        }

        .idea-item:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary-100);
        }

        /* --- ABOUT US & TEAM SECTION --- */
        .about-grid,
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .about-card,
        .team-member {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }

        .about-card:hover,
        .team-member:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-200);
        }

        .team-member img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 3px solid var(--primary-100);
            padding: 3px;
            background: white;
            transition: 0.3s;
        }

        .team-member:hover img {
            border-color: var(--gold-500);
            transform: scale(1.05);
        }

        .team-member h4 {
            margin: 0;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
            color: var(--gray-800);
        }

        /* Mobile Responsiveness for About Us */
        @media (max-width: 768px) {

            .about-grid,
            .team-grid {
                grid-template-columns: 1fr;
                /* Stack vertically on mobile */
            }

            .about-card,
            .team-member {
                padding: 1.25rem;
                /* Slightly compact on mobile */
            }
        }

        /* --- GLOBAL MOBILE RESPONSIVENESS FIXES --- */
        @media (max-width: 768px) {

            /* Profile Section: Stack Form & Key Info */
            .profile-form-grid {
                grid-template-columns: 1fr;
            }

            .profile-header-large {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .profile-header-info {
                align-items: center;
            }

            /* Chat Widget: Adjust Size & Position */
            .chat-container {
                width: 90% !important;
                right: 5% !important;
                left: 5% !important;
                bottom: 90px !important;
                height: 60vh !important;
            }

            .chat-fab {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            /* Notification Dropdown: Full Width */
            .notification-dropdown {
                width: 92% !important;
                right: 4% !important;
                left: 4% !important;
                top: 70px !important;
            }

            /* Tables & Lists: Stack Content */
            .stats-list li {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .stats-list li>div:last-child {
                align-self: flex-end;
            }

            /* Card Inner Spacing */
            .idea-item,
            .dashboard-card,
            .card {
                padding: 1rem !important;
            }

            .idea-item>div:first-child {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            /* Main Content Padding/Margins */
            .content-wrapper {
                padding: 1rem 1rem 6rem;
            }

            .header {
                padding: 0 1rem;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- ATTENDANCE LIST STYLES (NEW) --- */
        .attendance-list-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .attendance-card-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }

        .attendance-card-item:hover {
            transform: translateX(4px);
            border-color: var(--primary-200);
            box-shadow: var(--shadow-sm);
        }

        .attendance-card-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--gray-300);
        }

        .attendance-card-item.present::before {
            background: #4caf50;
        }

        .attendance-card-item.late::before {
            background: #ffc107;
        }

        .attendance-card-item.absent::before {
            background: #f44336;
        }

        .attendance-info-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .attendance-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            color: var(--gray-500);
            font-size: 1.1rem;
        }

        .attendance-card-item.present .attendance-icon-wrapper {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .attendance-card-item.late .attendance-icon-wrapper {
            background: #fff8e1;
            color: #fbc02d;
        }

        .attendance-card-item.absent .attendance-icon-wrapper {
            background: #ffebee;
            color: #c62828;
        }

        .attendance-date-text {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95rem;
            display: block;
        }

        .attendance-time-text {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .attendance-status-badge {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 12px;
            letter-spacing: 0.5px;
        }

        .attendance-card-item.present .attendance-status-badge {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .attendance-card-item.late .attendance-status-badge {
            background: #fff8e1;
            color: #fbc02d;
        }

        .attendance-card-item.absent .attendance-status-badge {
            background: #ffebee;
            color: #c62828;
        }

        /* Download Report Card Style */
        .card-download-report {
            grid-column: 1 / -1;
            /* Full width always */
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--white), #f8f9fa);
            padding: 1.5rem;
        }

        /* Disabled Countdown State */
        .supiri-btn:disabled,
        .supiri-btn.disabled-countdown {
            background: var(--gray-200);
            color: var(--gray-600);
            cursor: not-allowed;
            border: 1px solid var(--gray-300);
            box-shadow: none;
        }

        /* DIGITAL ID STYLES */
        .digital-id-card {
            width: 300px;
            background: linear-gradient(135deg, #fff, #f9f9f9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
            border: 1px solid #ddd;
            margin: auto;
        }

        .id-header {
            background: var(--primary-700);
            padding: 15px;
            text-align: center;
            color: white;
        }

        .id-body {
            padding: 20px;
            text-align: center;
        }

        .id-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--gold-500);
            margin: -40px auto 10px;
            /* Pull up into header */
            background: white;
            object-fit: cover;
            position: relative;
            z-index: 2;
        }

        .id-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: #333;
            margin: 5px 0;
        }

        .id-role {
            color: var(--primary-600);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .id-details {
            font-size: 0.8rem;
            color: #555;
            margin: 15px 0;
            line-height: 1.6;
        }

        .id-qr {
            width: 100px;
            height: 100px;
            margin: 10px auto;
        }

        .id-footer {
            background: #eee;
            padding: 10px;
            text-align: center;
            font-size: 0.7rem;
            color: #666;
            letter-spacing: 1px;
        }

        /* BIRTHDAY OVERLAY */
        #birthday-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }

        .bday-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
            animation: popIn 0.5s ease;
            max-width: 90%;
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- SMART CHAT WIDGET --- */
        #chatContainer {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 360px;
            height: 500px;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            /* Strong shadow */
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            animation: slideUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #chatContainer.active {
            display: flex;
        }

        .chat-header {
            background: var(--primary-700);
            color: #fff;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-family: var(--font-display);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .message {
            max-width: 80%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .bot-message {
            background: #fff;
            color: var(--gray-800);
            align-self: flex-start;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 2px;
        }

        .user-message {
            background: var(--primary-600);
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .chat-input-area {
            padding: 1rem;
            background: #fff;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.8rem 1rem;
            border-radius: 25px;
            border: 1px solid #cbd5e1;
            outline: none;
            font-family: var(--font-body);
        }

        .chat-input-area input:focus {
            border-color: var(--primary-500);
        }

        .chat-input-area button {
            background: var(--primary-600);
            color: #fff;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            /* Center icon */
            align-items: center;
            justify-content: center;
        }

        .chat-input-area button:hover {
            background: var(--primary-700);
            transform: scale(1.05);
        }

        .chat-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-600);
            color: #fff;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 1000;
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-fab:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 10px 25px rgba(114, 14, 14, 0.4);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Global Scrolls */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <img src="meroon Transparent logo prefect.png" alt="Logo">
            <div class="brand-text">
                <h1>ECCPMS</h1>
                <span>Prefects' Guild</span>
            </div>
        </div>

        <nav class="nav-menu">
            <a href="#overview" class="nav-item active">
                <i class="fas fa-th-large"></i>
                <span>Overview</span>
            </a>
            <a href="#events" class="nav-item">
                <i class="fas fa-calendar-alt"></i>
                <span>Events</span>
            </a>
            <a href="#ideas" class="nav-item">
                <i class="fas fa-lightbulb"></i>
                <span>Ideas</span>
            </a>
            <a href="#notifications" class="nav-item">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
            </a>
            <a href="#attendance" class="nav-item">
                <i class="fas fa-check-circle"></i>
                <span>Attendance</span>
            </a>
            <a href="#points" class="nav-item">
                <i class="fas fa-star"></i>
                <span>Points</span>
            </a>
            <a href="#performance" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Performance</span>
            </a>
            <a href="#profile" class="nav-item">
                <i class="fas fa-user-circle"></i>
                <span>Profile</span>
            </a>
            <a href="#about" class="nav-item">
                <i class="fas fa-info-circle"></i>
                <span>About Us</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Log Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="page-title">
                    <h2>Dashboard <span>Overview</span></h2>
                </div>
            </div>

            <div class="header-actions">
                <button class="btn-icon" id="header-notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notification-badge-count">0</span>
                </button>

                <div class="notification-dropdown" id="notification-dropdown-panel">
                    <div class="notification-header">
                        <h4>Notifications</h4>
                        <span class="badge"
                            style="position:static; transform:none; background:var(--primary-100); color:var(--primary-700); font-size:0.75rem; padding:2px 8px; border-radius:12px; width:auto; height:auto; border:none;">New</span>
                    </div>
                    <div class="notification-list" id="notification-dropdown-list">
                        <!-- Notifications will be loaded here -->
                        <div style="padding:1rem; text-align:center; color:var(--gray-500);">Loading...</div>
                    </div>
                    <div class="notification-footer">
                        <button class="view-all-btn" id="view-all-notifications-btn">View All Notifications</button>
                    </div>
                </div>



                <button class="profile-btn">
                    <div class="profile-info">
                        <span class="profile-name" id="header-profile-name">Prefect Name</span>
                        <span class="profile-role" id="header-profile-role">Senior Prefect</span>
                    </div>
                    <img src="meroon Transparent logo prefect.png" alt="Profile" class="profile-img"
                        id="header-profile-img">
                </button>
            </div>
        </header>

        <!-- Content Grid -->
        <!-- Content Grid -->
        <div class="content-wrapper">

            <!-- SMART OVERVIEW SECTION -->
            <section id="overview" class="content-section active">
                <div class="smart-dashboard-layout">

                    <!-- Main Feed (Center) -->
                    <div class="main-feed">

                        <!-- Smart Hero -->
                        <div class="smart-hero">
                            <div class="hero-left">
                                <img id="welcome-profile-img" src="meroon Transparent logo prefect.png"
                                    class="hero-profile-img" alt="Profile">
                                <div class="hero-text">
                                    <h1>Welcome Back,<br><span id="welcome-name"
                                            style="color:var(--primary-600)">Prefect</span></h1>
                                    <p>You have <strong style="color:var(--gray-900)">2 pending</strong> reports today.
                                    </p>
                                </div>
                            </div>
                            <div class="hero-status">
                                <div class="status-badge"><i class="fas fa-check-circle"></i> On Duty</div>
                                <div style="font-size:0.8rem; color:var(--gray-500);">Next: Gate Duty at 14:00</div>
                            </div>
                        </div>

                        <!-- Metrics Hub -->
                        <div class="metrics-grid">
                            <!-- Points -->
                            <div class="smart-metric">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div class="metric-icon"><i class="fas fa-star"></i></div>
                                    <span
                                        style="font-size:0.8rem; background:#fffbf0; color:#d97706; padding:0.2rem 0.5rem; border-radius:10px;">High</span>
                                </div>
                                <div>
                                    <div class="metric-value" id="total-points">0</div>
                                    <div class="metric-label">Total Points</div>
                                </div>
                                <div
                                    style="height:4px; width:100%; background:#f1f5f9; border-radius:2px; margin-top:0.5rem;">
                                    <div style="height:100%; width:75%; background:#d97706; border-radius:2px;"></div>
                                </div>
                            </div>

                            <!-- Attendance Health -->
                            <div class="smart-metric">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div class="metric-icon" style="color:#059669"><i class="fas fa-heartbeat"></i>
                                    </div>
                                </div>
                                <div>
                                    <div class="metric-value">98%</div>
                                    <div class="metric-label">Attendance Health</div>
                                </div>
                                <div
                                    style="height:4px; width:100%; background:#f1f5f9; border-radius:2px; margin-top:0.5rem;">
                                    <div style="height:100%; width:98%; background:#059669; border-radius:2px;"></div>
                                </div>
                            </div>

                            <!-- Absences -->
                            <div class="smart-metric">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div class="metric-icon" style="color:#dc2626"><i
                                            class="fas fa-exclamation-circle"></i></div>
                                </div>
                                <div>
                                    <div class="metric-value" id="total-absences">0</div>
                                    <div class="metric-label">Total Absences</div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Dock -->
                        <div class="action-dock">
                            <button class="dock-item" id="btn-quick-event">
                                <i class="fas fa-calendar-plus"></i>
                                <span>Events</span>
                            </button>
                            <button class="dock-item" id="btn-quick-idea">
                                <i class="fas fa-lightbulb"></i>
                                <span>Idealize</span>
                            </button>
                            <button class="dock-item" id="btn-download-report">
                                <i class="fas fa-file-download"></i>
                                <span>Report</span>
                            </button>
                            <button class="dock-item" id="btn-quick-absence">
                                <i class="fas fa-user-clock"></i>
                                <span>Absence</span>
                            </button>
                        </div>
                    </div>

                    <!-- Side Panel (Right) -->
                    <div class="side-panel">
                        <!-- Rank Widget -->
                        <div class="leaderboard-widget">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                                <h3 style="font-family:var(--font-display); font-size:1.2rem;">Top Leaders</h3>
                                <a href="#" style="font-size:0.85rem; color:var(--primary-600); font-weight:600;">View
                                    All</a>
                            </div>
                            <div id="leaderboard-list">
                                <div style="text-align:center; color:var(--gray-400); padding:2rem;">Loading...</div>
                            </div>
                        </div>

                        <!-- Chart Placeholder (Mini) -->
                        <div class="card" style="padding:1.5rem; flex:1;">
                            <h4 style="margin-bottom:1rem; color:var(--gray-600);">Weekly Insight</h4>
                            <div style="flex:1; position:relative;">
                                <canvas id="attendanceBarChart"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Placeholders for other sections -->
            <section id="events" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Upcoming Events</h2>
                <div class="card">
                    <div id="events-list">
                        <!-- Events will be populated here -->
                        <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            <i class="fas fa-spinner fa-spin"></i> Loading events...
                        </div>
                    </div>
                </div>
            </section>

            <section id="ideas" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Ideas & Proposals</h2>

                <div class="bento-grid" style="grid-template-columns: 1fr;">
                    <!-- Submit Idea Form -->
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 1rem; color: var(--primary-700);">Submit an Idea
                        </h3>
                        <form id="idea-form">
                            <div class="form-group">
                                <label for="idea-title">Title</label>
                                <input type="text" id="idea-title" placeholder="Title of your idea" required>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="idea-description">Description</label>
                                <textarea id="idea-description" rows="4" placeholder="Describe your idea in detail..."
                                    required
                                    style="width: 100%; padding: 0.85rem 1rem; border: 1px solid var(--gray-200); border-radius: var(--radius-lg); background: var(--gray-100); color: var(--gray-900); font-family: inherit; transition: 0.3s;"></textarea>
                            </div>
                            <button type="submit" id="idea-submit-btn" class="supiri-btn"
                                style="margin-top: 1rem; width: 100%;">
                                <i class="fas fa-paper-plane"></i> Submit for Approval
                            </button>
                            <p id="submit-message" style="margin-top: 1rem; font-size: 0.9rem; text-align: center;"></p>
                        </form>
                    </div>

                    <!-- My Submissions (Hidden because dashboard.html didn't have it and it causes permission errors) -->
                    <div class="card" style="display: none;">
                        <h3 class="card-title" style="margin-bottom: 1rem;">My Submissions</h3>
                        <div id="my-ideas-list" class="ideas-list">
                            <p style="color: var(--gray-500);">Loading your ideas...</p>
                        </div>
                    </div>

                    <!-- Public Proposals -->
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 1rem;">Public Proposals</h3>
                        <div id="public-ideas-list" class="ideas-list">
                            <p style="color: var(--gray-500);">Loading public proposals...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="notifications" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Notifications</h2>
                <div class="card">
                    <div id="notifications-list" class="notification-list" style="max-height:none;">
                        <p style="color:var(--gray-500);">Loading announcements...</p>
                    </div>
                </div>
            </section>

            <section id="attendance" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Attendance Record</h2>
                <div id="absent-reason-container" style="margin-bottom: 2rem;">
                    <!-- Absence Reason Form (Dynamically Injected) -->
                </div>
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem; color:var(--primary-600);">Request Future Absence
                        / Duty Handover</h3>
                    <p style="color:var(--gray-600); margin-bottom:1rem; font-size:0.9rem;">Plan your absence in advance
                        and assign a replacement.</p>
                    <form id="future-absence-form" class="future-absence-form">
                        <div class="profile-form-grid">
                            <div class="form-group">
                                <label>Date of Absence</label>
                                <input type="date" id="future-absence-date" required>
                            </div>
                            <div class="form-group">
                                <label>Replacement Prefect</label>
                                <select id="replacement-prefect-select" required>
                                    <option value="">Select Prefect</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:1rem;">
                            <label>Reason / Handover Note</label>
                            <textarea id="future-absence-reason" rows="2"
                                placeholder="Explain reason and duty details..." required></textarea>
                        </div>
                        <button type="submit" id="future-absence-submit-btn" class="supiri-btn"
                            style="width:auto; margin-top:1rem;">Submit Request</button>
                        <p id="future-absence-message" style="margin-top:0.5rem; font-size:0.9rem;"></p>
                    </form>
                </div>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;">Recent Attendance</h3>
                    <div id="recent-attendance-list">
                        <p style="color: var(--gray-500);">Loading attendance...</p>
                    </div>
                </div>
            </section>

            <section id="points" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Points History</h2>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;">Recent Points</h3>
                    <div id="recent-points-list">
                        <p style="color: var(--gray-500);">Loading points history...</p>
                    </div>
                </div>
            </section>

            <section id="performance" class="content-section" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0; font-family: var(--font-display);">Performance & Duty</h2>
                    <button class="supiri-btn"
                        style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background: #c0392b;"
                        onclick="generateWarningPDF()">
                        <i class="fas fa-exclamation-circle"></i> Download Record
                    </button>
                </div>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem; color:#d63031;">Performance Issues</h3>
                    <div id="bad-work-list">
                        <p style="color: var(--gray-500);">Loading records...</p>
                    </div>
                </div>
            </section>

            <section id="profile" class="content-section" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0; font-family: var(--font-display);">My Profile</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="supiri-btn"
                            style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background: var(--primary-600);"
                            onclick="openDigitalID()">
                            <i class="fas fa-id-card"></i> View ID
                        </button>
                        <button class="supiri-btn"
                            style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background: var(--gray-600);"
                            onclick="generateServiceLetterPDF()">
                            <i class="fas fa-file-download"></i> Download CV
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="profile-header-large">
                        <img id="profile-page-picture" src="meroon Transparent logo prefect.png" alt="Profile Picture"
                            class="profile-page-img">
                        <div class="profile-header-info">
                            <h3 id="profile-page-name" style="font-size: 1.5rem; margin-bottom: 0.25rem;">Prefect Name
                            </h3>
                            <p id="profile-page-role-display" style="color: var(--gold-700); font-weight: 600;">Senior
                                Prefect</p>
                            <small id="profile-prefect-id" style="color: var(--gray-500);">ID: -</small>
                        </div>
                    </div>

                    <div class="profile-form-grid">
                        <div class="form-group">
                            <label for="profile-email">Email</label>
                            <input type="email" id="profile-email" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-phone">Phone</label>
                            <input type="tel" id="profile-phone" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-class-static">Class</label>
                            <input type="text" id="profile-class-static" value="-" disabled>
                        </div>

                        <div class="form-group">
                            <label for="profile-section">Section</label>
                            <input type="text" id="profile-section" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-index">Index Number</label>
                            <input type="text" id="profile-index" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-parents-phone">Parents' Phone</label>
                            <input type="tel" id="profile-parents-phone" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-current-duty">Current Duty</label>
                            <input type="text" id="profile-current-duty" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-total-points">Total Points</label>
                            <input type="text" id="profile-total-points" value="0" disabled>
                        </div>
                    </div>
                </div>
            </section>

            <section id="about" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">About Us</h2>

                <div class="card" style="margin-bottom: 2rem;">
                    <div class="about-header" style="text-align: center; max-width: 800px; margin: 0 auto;">
                        <h2 style="color: var(--primary-700); margin-bottom: 1rem;">About Our Mission</h2>
                        <p style="color: var(--gray-600); line-height: 1.6;">We are a team of passionate and innovative
                            students from Eheliyagoda Central College, brought
                            together by a shared vision of leveraging technology to improve our school's ecosystem.</p>
                    </div>
                </div>

                <div class="about-grid">
                    <div class="about-card">
                        <div class="stat-icon" style="margin: 0 auto 1rem;"><i class="fas fa-rocket"></i></div>
                        <h3>About The Project</h3>
                        <p style="color: var(--gray-600); margin-top: 0.5rem;">Welcome to the official portal for the
                            Eheliyagoda Central College Prefect Management
                            System (ECCPMS). Digitzing the Prefects' Guild.</p>
                    </div>
                    <div class="about-card">
                        <div class="stat-icon" style="margin: 0 auto 1rem;"><i class="fas fa-code-branch"></i></div>
                        <h3>Project Version</h3>
                        <p style="color: var(--gray-600); margin-top: 0.5rem;">Current Version: <strong>1.0.0</strong>.
                            The first official release of the ECCPMS.</p>
                    </div>
                </div>

                <h3 style="margin-bottom: 1.5rem;">Meet The Team</h3>
                <div class="team-grid">
                    <!-- Developers -->
                    <div class="team-member">
                        <img src="Developer Team/Adeesha.jpg" alt="Adeesha"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Adeesha Ravimal</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Backend & Desktop
                            App</p>
                        <p style="font-size: 0.8rem; color: var(--gray-600);">System Architect</p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/Hansaka.png" alt="Hansaka"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Hansaka Fernando</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Web & Mobile App
                        </p>
                        <p style="font-size: 0.8rem; color: var(--gray-600);">UI/UX Designer</p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/thevindu.JPG" alt="Thevindu"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Thevindu Thisev</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Data Collector</p>
                        <p style="font-size: 0.8rem; color: var(--gray-600);">Database Admin</p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/Nethmi.jpg" alt="Nethmi"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Nethmi Dhananjana</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Coordinator</p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/Rashmi.jpg" alt="Rashmi"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Rashmi Jananjana</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Student Mgmt Lead
                        </p>
                    </div>
                    <div class="team-member">
                        <img src="Developer Team/Avishka.jpg" alt="Avishka"
                            onerror="this.src='meroon Transparent logo prefect.png'">
                        <h4>Avishka Kalhara</h4>
                        <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Media Partner</p>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, limit, orderBy, addDoc, doc, updateDoc, runTransaction, arrayUnion, getDoc, setDoc, writeBatch, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEvF1sD56pmtYlbno4QAY_Kr5xeFrTAvU",
            authDomain: "prefect-management-syste-e1575.firebaseapp.com",
            projectId: "prefect-management-syste-e1575",
            storageBucket: "prefect-management-syste-e1575.appspot.com",
            messagingSenderId: "973932803095",
            appId: "1:973932803095:web:a7f2db386cafb53330d852",
            measurementId: "G-FLF7R3B8J3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sidebar Navigation Logic
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('show');
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('show');
            });
        }

        // Active Link Highlighting & SPA Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const href = item.getAttribute('href');
                if (!href || !href.startsWith('#')) return;

                // Remove active class from all links
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Hide all sections and show target
                contentSections.forEach(s => {
                    s.style.display = 'none';
                    s.classList.remove('active');
                });

                const targetId = href.substring(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    // Small delay to allow display to apply before opacity transition if we add one
                    setTimeout(() => targetSection.classList.add('active'), 10);
                }

                // Update Header Title
                const pageTitle = document.querySelector('.page-title h2 span');
                const linkText = item.querySelector('span').textContent;
                if (pageTitle) pageTitle.textContent = linkText;

                // On mobile, close sidebar on click
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('show');
                }
            });
        });


        // Quick Actions Logic
        const btnQuickEvent = document.getElementById('btn-quick-event');
        const btnQuickIdea = document.getElementById('btn-quick-idea');
        const btnQuickAbsence = document.getElementById('btn-quick-absence');

        if (btnQuickEvent) {
            btnQuickEvent.addEventListener('click', () => {
                document.querySelector('.nav-item[href="#events"]').click();
            });
        }

        if (btnQuickIdea) {
            btnQuickIdea.addEventListener('click', () => {
                document.querySelector('.nav-item[href="#ideas"]').click();
                setTimeout(() => {
                    const titleInput = document.getElementById('idea-title');
                    if (titleInput) titleInput.focus();
                }, 100);
            });
        }

        if (btnQuickAbsence) {
            btnQuickAbsence.addEventListener('click', () => {
                document.querySelector('.nav-item[href="#attendance"]').click();
            });
        }

        const btnQuickEditProfile = document.getElementById('btn-quick-edit-profile');
        if (btnQuickEditProfile) {
            btnQuickEditProfile.addEventListener('click', () => {
                document.querySelector('.nav-item[href="#profile"]').click();
            });
        }

        // Download Report Logic
        const btnDownloadReport = document.getElementById('btn-download-report');

        function updateDownloadButtonState() {
            if (!btnDownloadReport) return;

            const today = new Date();
            const currentDay = today.getDate();
            const allowedDays = [27, 28, 29, 30];

            if (allowedDays.includes(currentDay)) {
                // Enabled State
                if (btnDownloadReport.innerHTML.includes('Generating')) return; // Don't override loading state
                btnDownloadReport.disabled = false;
                btnDownloadReport.classList.remove('disabled-countdown');
                btnDownloadReport.innerHTML = '<i class="fas fa-file-download"></i> Download Monthly Report';
            } else {
                // Disabled State with Countdown
                btnDownloadReport.disabled = true;
                btnDownloadReport.classList.add('disabled-countdown');

                let targetDate = new Date();
                if (currentDay > 30) {
                    targetDate.setMonth(targetDate.getMonth() + 1);
                }
                targetDate.setDate(27);
                targetDate.setHours(0, 0, 0, 0);

                if (targetDate < today) {
                    // This handles edge cases where today is < 27, target is set to today's month 27th
                    // Logic checks out.
                }

                const timeDiff = targetDate.getTime() - today.getTime();
                if (timeDiff > 0) {
                    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                    // Optional: Seconds
                    // const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

                    let timeString = "";
                    if (days > 0) timeString += `${days}d `;
                    timeString += `${hours}h ${minutes}m`;

                    btnDownloadReport.innerHTML = `<i class="fas fa-clock"></i> Next Report: ${timeString}`;
                }
            }
        }

        // Initialize and Update Every Minute
        if (btnDownloadReport) {
            updateDownloadButtonState();
            setInterval(updateDownloadButtonState, 60000); // Update every minute

            btnDownloadReport.addEventListener('click', async () => {
                if (!currentPrefectGlobal) return alert("Please wait for profile to load.");

                // Double check date just in case (though button is disabled)
                const d = new Date().getDate();
                if (![27, 28, 29, 30].includes(d)) return;

                const originalText = btnDownloadReport.innerHTML;
                btnDownloadReport.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                btnDownloadReport.disabled = true;

                try {
                    await generateMonthlyReportPDF(currentPrefectGlobal);
                } catch (error) {
                    console.error("PDF Error:", error);
                    alert("Failed to generate PDF: " + error.message);
                } finally {
                    btnDownloadReport.innerHTML = originalText;
                    btnDownloadReport.disabled = false;
                }
            });
        }

        async function generateMonthlyReportPDF(prefect) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // --- DATA FETCHING ---
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthName = now.toLocaleString('default', { month: 'long' });

            // 1. Fetch Month's Attendance
            // Note: In a real app, you'd query by date range. Client-side filter for simplicity here.
            const attendanceRef = collection(db, "attendance");
            const attQ = query(attendanceRef, where("prefect_id", "==", prefect.id));
            const attSnap = await getDocs(attQ);
            let attendanceRecords = [];
            let totalAbsencesMonth = 0;
            let totalLateMonth = 0;

            attSnap.forEach(d => {
                const data = d.data();
                // Parse date string "YYYY-MM-DD" or timestamp
                let dateObj = null;
                if (data.date && data.date.seconds) dateObj = new Date(data.date.seconds * 1000);
                else if (typeof data.date === 'string') dateObj = new Date(data.date);

                if (dateObj && dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear) {
                    attendanceRecords.push(data);
                    const status = (data.status || '').toLowerCase();
                    if (status === 'absent') totalAbsencesMonth++;
                    if (status === 'late') totalLateMonth++;
                }
            });
            // Sort by Date
            attendanceRecords.sort((a, b) => new Date(a.date) - new Date(b.date));

            // 2. Fetch Month's Points
            const pointsRef = collection(db, "points");
            const pointsQ = query(pointsRef, where("prefect_id", "==", prefect.id));
            const pointsSnap = await getDocs(pointsQ);
            let pointsRecords = [];
            let totalPointsMonth = 0;

            pointsSnap.forEach(d => {
                const data = d.data();
                let dateObj = null;
                if (data.date && data.date.seconds) dateObj = new Date(data.date.seconds * 1000);
                else if (typeof data.date === 'string') dateObj = new Date(data.date);

                if (dateObj && dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear) {
                    pointsRecords.push(data);
                    totalPointsMonth += (data.points || 0);
                }
            });
            pointsRecords.sort((a, b) => new Date(a.date) - new Date(b.date));


            // --- PDF GENERATION ---
            // Colors
            const colorPrimary = [114, 14, 14]; // Maroon
            const colorGold = [212, 175, 55]; // Gold
            const colorGray = [100, 100, 100];

            // Header
            doc.setFillColor(...colorPrimary);
            doc.rect(0, 0, 210, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Eheliyagoda Central College", 105, 20, { align: "center" });

            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text("Prefects' Guild - Monthly Performance Report", 105, 30, { align: "center" });

            // Prefect Info
            let yPos = 55;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.text(`Prefect Name: ${prefect.name}`, 14, yPos);
            doc.text(`Month: ${monthName} ${currentYear}`, 150, yPos);

            yPos += 7;
            doc.text(`Prefect ID: ${prefect.school_index_number || '-'}`, 14, yPos);
            doc.text(`Generated On: ${now.toLocaleDateString()}`, 150, yPos);

            yPos += 15;

            // Summary Box
            doc.setFillColor(245, 245, 245);
            doc.roundedRect(14, yPos, 182, 25, 3, 3, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.roundedRect(14, yPos, 182, 25, 3, 3, 'S');

            doc.setFont("helvetica", "bold");
            doc.text("Monthly Summary", 20, yPos + 8);

            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.text(`Total Points Earned: ${totalPointsMonth}`, 20, yPos + 18);
            doc.text(`Days Absent: ${totalAbsencesMonth}`, 80, yPos + 18);
            doc.text(`Late Arrivals: ${totalLateMonth}`, 140, yPos + 18);

            yPos += 40;

            // Table 1: Attendance
            doc.setFontSize(14);
            doc.setTextColor(...colorPrimary);
            doc.text("Attendance Log", 14, yPos);
            yPos += 5;

            const attendanceRows = attendanceRecords.map(r => [
                r.date || '-',
                (r.status || 'N/A').toUpperCase(),
                r.time_in || '-',
                r.reason || '-'
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['Date', 'Status', 'Time In', 'Reason / Note']],
                body: attendanceRows,
                theme: 'grid',
                headStyles: { fillColor: colorPrimary, textColor: 255 },
                styles: { fontSize: 9 },
                alternateRowStyles: { fillColor: [250, 240, 240] }
            });

            yPos = doc.lastAutoTable.finalY + 20;

            // Table 2: Points
            doc.setFontSize(14);
            doc.setTextColor(...colorPrimary);
            doc.text("Points History", 14, yPos);
            yPos += 5;

            const pointsRows = pointsRecords.map(r => [
                r.date && r.date.seconds ? new Date(r.date.seconds * 1000).toLocaleDateString() : r.date,
                r.reason || 'Points Awarded',
                (r.points > 0 ? '+' : '') + r.points
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['Date', 'Description', 'Points']],
                body: pointsRows,
                theme: 'grid',
                headStyles: { fillColor: colorGold, textColor: 0 }, // Gold header for points
                styles: { fontSize: 9 },
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('ECCPMS - System Generated Report', 105, 290, { align: 'center' });
            }

            // Save
            doc.save(`Monthly_Report_${monthName}_${prefect.name.replace(/\s+/g, '_')}.pdf`);
        }

        // Logout Logic
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error("Logout Error:", error);
                });
            });
        }

        // Auth & Data Loading
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User logged in:", user.uid);

                // Fetch Prefect Profile
                const prefectsRef = collection(db, "prefects");
                const q = query(prefectsRef, where("uid", "==", user.uid));

                try {
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const prefectDoc = querySnapshot.docs[0];
                        const prefectData = prefectDoc.data();
                        const prefectId = prefectDoc.id;

                        // Set Global Var for PDF & other functions
                        currentPrefectGlobal = { id: prefectId, ...prefectData };

                        // Update UI with Profile Data
                        updateProfileUI(prefectData);

                        // Fetch Stats
                        await fetchKeyStats(prefectId);
                        await fetchRecentPoints(prefectId);
                        await fetchWeeklyAttendanceChart(prefectId);
                        await fetchRecentAttendance(prefectId);
                        await checkForAbsenceReason(prefectId);
                        await fetchBadWork(prefectId);

                        // Load Events & Ideas
                        loadEvents();
                        initializeIdeas();
                        loadAnnouncements();
                        initializeChat(user);
                        try { initializeFutureAbsenceForm(user); } catch (e) { console.error(e); }

                    } else {
                        console.log("No prefect profile found for this user.");
                    }
                } catch (error) {
                    console.error("Error fetching data:", error);
                }

            } else {
                console.log("No user logged in, redirecting...");
                // window.location.href = 'login.html'; // Uncomment for production
            }
        });

        function updateProfileUI(data) {
            const defaultImg = "meroon Transparent logo prefect.png";
            const imageUrl = data.picture || defaultImg;
            const name = data.name || "Prefect";
            const role = data.destiny || "Member";

            // Update Header Name/Role (Mobile & Desktop)
            const headerName = document.getElementById('header-profile-name');
            const headerRole = document.getElementById('header-profile-role');
            const headerImg = document.getElementById('header-profile-img');

            if (headerName) headerName.textContent = name;
            if (headerRole) headerRole.textContent = role;
            if (headerImg) headerImg.src = imageUrl;

            // Update Welcome Card
            const welcomeName = document.getElementById('welcome-name');
            const welcomeImg = document.getElementById('welcome-profile-img');

            if (welcomeName) welcomeName.textContent = name;
            if (welcomeImg) welcomeImg.src = imageUrl;

            // Update Profile Page Details
            const profilePageName = document.getElementById('profile-page-name');
            const profilePageRole = document.getElementById('profile-page-role-display');
            const profilePageImg = document.getElementById('profile-page-picture');
            const profileId = document.getElementById('profile-prefect-id');

            if (profilePageName) profilePageName.textContent = name;
            if (profilePageRole) profilePageRole.textContent = role;
            if (profilePageImg) profilePageImg.src = imageUrl;
            if (profileId) profileId.textContent = `ID: ${data.school_index_number || '-'}`;

            // Form Fields
            const fieldMap = {
                'profile-email': data.email,
                'profile-phone': data.phone,
                'profile-class-static': data.class,
                'profile-section': data.section,
                'profile-index': data.school_index_number,
                'profile-parents-phone': data.parents_phone,
                'profile-current-duty': data.current_duty,
                'profile-total-points': data.total_points || 0
            };

            // Check for Birthday
            if (data.dob) {
                checkBirthday(data.dob);
            }

            // Fetch Leaderboard once profile is loaded (to highlight current user)
            fetchLeaderboard();

            for (const [id, value] of Object.entries(fieldMap)) {
                const el = document.getElementById(id);
                if (el) el.value = value || '-';
            }
        }

        async function fetchKeyStats(prefectId) {
            // Points - Using real-time listener
            const pointsQuery = query(collection(db, "points"), where("prefect_id", "==", prefectId));
            onSnapshot(pointsQuery, (pointsSnapshot) => {
                let totalPoints = 0;
                pointsSnapshot.forEach(doc => { totalPoints += doc.data().points || 0; });

                const pointsEl = document.getElementById('total-points');
                if (pointsEl) pointsEl.textContent = totalPoints;
            }, (error) => {
                console.error("Error listening to points:", error);
            });

            // Attendance (Absences & Late) - Using real-time listener
            const attendanceQuery = query(collection(db, "attendance"), where("prefect_id", "==", prefectId));
            onSnapshot(attendanceQuery, (attendanceSnapshot) => {
                let totalAbsences = 0;
                let totalLate = 0;

                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    const status = (record.status || '').toLowerCase(); // Case-insensitive comparison
                    if (status === 'absent') totalAbsences++;
                    else if (status === 'late') totalLate++;
                });

                const absencesEl = document.getElementById('total-absences');
                const lateEl = document.getElementById('total-late');

                if (absencesEl) absencesEl.textContent = totalAbsences;
                if (lateEl) lateEl.textContent = totalLate;
            }, (error) => {
                console.error("Error listening to attendance:", error);
            });
        }

        let weeklyChartInstance = null;
        let breakdownChartInstance = null;

        async function fetchWeeklyAttendanceChart(prefectId) {
            // --- 1. Bar Chart: Weekly Attendance ---
            const ctxBar = document.getElementById('attendanceBarChart');
            if (!ctxBar) return;

            try {
                // Fetch last 10 records for better trend
                const attendanceQuery = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), limit(20));

                onSnapshot(attendanceQuery, (querySnapshot) => {
                    if (querySnapshot.empty) return; // Handle empty state visually if needed

                    let attendanceData = [];
                    querySnapshot.forEach(doc => attendanceData.push(doc.data()));

                    // Sort: Oldest to Newest for Chart
                    attendanceData.sort((a, b) => {
                        const dateA = a.date?.seconds ? a.date.seconds : new Date(a.date).getTime() / 1000;
                        const dateB = b.date?.seconds ? b.date.seconds : new Date(b.date).getTime() / 1000;
                        return dateA - dateB;
                    });

                    // Take last 7 for the week view
                    const recentData = attendanceData.slice(-7);

                    const labels = recentData.map(d => formatDate(d.date).split('/')[0] + '/' + formatDate(d.date).split('/')[1]); // DD/MM
                    const statusValues = recentData.map(d => {
                        const s = (d.status || '').toLowerCase();
                        if (s === 'present') return 10; // Visualization height
                        if (s === 'late') return 6;
                        if (s === 'absent') return 2;
                        return 0;
                    });
                    const statusColors = recentData.map(d => {
                        const s = (d.status || '').toLowerCase();
                        if (s === 'present') return '#4caf50';
                        if (s === 'late') return '#fbc02d';
                        if (s === 'absent') return '#d63031';
                        return '#ccc';
                    });

                    // Render Chart.js
                    if (weeklyChartInstance) weeklyChartInstance.destroy();

                    const config = {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Attendance Status',
                                data: statusValues,
                                backgroundColor: statusColors,
                                borderRadius: 8,
                                barThickness: 25,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const val = context.raw;
                                            if (val === 10) return 'Present';
                                            if (val === 6) return 'Late';
                                            if (val === 2) return 'Absent';
                                            return 'Unknown';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    display: false,
                                    max: 12
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { family: "'Plus Jakarta Sans', sans-serif" } }
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeOutQuart'
                            }
                        }
                    };

                    weeklyChartInstance = new Chart(ctxBar, config);

                    // --- 2. Doughnut Chart: Overall Breakdown ---
                    // Calculate totals from ALL fetched data (up to 20 or more if we queried more)
                    // For better stats, we might want to query more or use the existing aggregates from fetchKeyStats

                    // Let's use the local `attendanceData` (last 20) as a sample
                    let p = 0, l = 0, a = 0;
                    attendanceData.forEach(d => {
                        const s = (d.status || '').toLowerCase();
                        if (s === 'present') p++;
                        else if (s === 'late') l++;
                        else if (s === 'absent') a++;
                    });

                    renderBreakdownChart(p, l, a);

                }, (error) => {
                    console.error("Chart Error:", error);
                });

            } catch (error) {
                console.error("Chart Init Error:", error);
            }
        }

        function renderBreakdownChart(present, late, absent) {
            const ctxDoughnut = document.getElementById('attendanceDoughnutChart');
            if (!ctxDoughnut) return;

            if (breakdownChartInstance) breakdownChartInstance.destroy();

            // Handle empty data case
            if (present === 0 && late === 0 && absent === 0) {
                // Maybe show a grey placeholder?
                present = 1; // Dummy
            }

            breakdownChartInstance = new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Late', 'Absent'],
                    datasets: [{
                        data: [present, late, absent],
                        backgroundColor: [
                            '#4caf50', // Present
                            '#fbc02d', // Late
                            '#d63031'  // Absent
                        ],
                        hoverOffset: 10,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    family: "'Plus Jakarta Sans', sans-serif",
                                    size: 12
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        async function fetchRecentPoints(prefectId) {
            const recentPointsChart = document.getElementById('recent-points-chart');
            if (!recentPointsChart) return;

            try {
                // Removed orderBy to prevent index error
                const q = query(collection(db, "points"), where("prefect_id", "==", prefectId), limit(20));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    recentPointsChart.innerHTML = '<p style="color:var(--gray-500); font-size:0.9rem;">No data available</p>';
                    return;
                }

                let pointsData = [];
                querySnapshot.forEach(doc => {
                    pointsData.push(doc.data());
                });

                // Client-side sort (date desc)
                pointsData.sort((a, b) => {
                    const dateA = a.date?.seconds || 0;
                    const dateB = b.date?.seconds || 0;
                    return dateB - dateA;
                });
                // Take top 5
                pointsData = pointsData.slice(0, 5);

                const maxPoints = Math.max(...pointsData.map(p => p.points || 0));
                let chartHtml = '';

                pointsData.reverse().forEach((point) => {
                    const barHeight = maxPoints > 0 ? ((point.points || 0) / maxPoints) * 100 : 0;
                    chartHtml += `<div class="bar" style="height: ${barHeight}%;" data-label="${formatDate(point.date)}" data-value="${point.points || 0}"></div>`;
                });

                if (recentPointsChart) recentPointsChart.innerHTML = chartHtml;

                // --- NEW: Populate Points History List (Points Section) ---
                const pointsList = document.getElementById('recent-points-list');
                if (pointsList) {
                    let listHtml = '<ul class="stats-list" style="list-style:none; padding:0;">';
                    // Reuse pointsData (sorted desc)
                    pointsData.reverse(); // It was reversed for chart (asc), reverse back for list (desc)
                    // Actually pointsData was sliced top 5. We might want ALL fetched (20).
                    // Let's use the original `querySnapshot` for the list to show more info.

                    let allPoints = [];
                    querySnapshot.forEach(doc => allPoints.push(doc.data()));
                    allPoints.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

                    if (allPoints.length === 0) {
                        pointsList.innerHTML = '<p class="text-muted">No points recorded.</p>';
                    } else {
                        allPoints.forEach(point => {
                            listHtml += `<li style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem 0; border-bottom:1px solid var(--gray-100);">
                                <div>
                                    <div style="font-weight:600; color:var(--gray-800);">${point.reason || 'Points Awarded'}</div>
                                    <div style="font-size:0.85rem; color:var(--gray-500);">${formatDate(point.date)}</div>
                                </div>
                                <div style="font-weight:700; color:${(point.points || 0) > 0 ? 'green' : 'red'}; background:${(point.points || 0) > 0 ? '#e8f5e9' : '#ffebee'}; padding:4px 10px; border-radius:12px;">
                                    ${(point.points || 0) > 0 ? '+' : ''}${point.points || 0}
                                </div>
                            </li>`;
                        });
                        listHtml += '</ul>';
                        pointsList.innerHTML = listHtml;
                    }
                }

            } catch (error) {
                console.error("Error fetching points:", error);
                if (recentPointsChart) recentPointsChart.innerHTML = '<p style="color:red; font-size:0.8rem;">Error loading points.</p>';
                const pointsList = document.getElementById('recent-points-list');
                if (pointsList) pointsList.innerHTML = `<p class='text-error'>Error: ${error.message}</p>`;
            }
        }

        function formatDate(date) {
            if (!date) return '-';
            if (date.seconds) return new Date(date.seconds * 1000).toLocaleDateString();
            const d = new Date(date);
            return isNaN(d.getTime()) ? '-' : d.toLocaleDateString();
        }

        /* --- ATTENDANCE LOGIC --- */
        async function fetchRecentAttendance(prefectId) {
            const attendanceList = document.getElementById('recent-attendance-list');
            if (!attendanceList) return;

            try {
                // Removed orderBy to prevent index error
                const q = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), limit(20));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    attendanceList.innerHTML = '<p class="text-muted">No recent attendance records.</p>';
                    return;
                }

                let records = [];
                querySnapshot.forEach(doc => records.push(doc.data()));

                // Client-side sort
                records.sort((a, b) => {
                    // Handle string dates or timestamp objects
                    const dateA = a.date?.seconds ? a.date.seconds : new Date(a.date).getTime() / 1000;
                    const dateB = b.date?.seconds ? b.date.seconds : new Date(b.date).getTime() / 1000;
                    return dateB - dateA;
                });

                let html = '<div class="attendance-list-container">';
                records.forEach(record => {
                    let statusClass = 'neutral';
                    let iconClass = 'fa-circle';
                    let statusText = record.status || 'N/A';
                    const statusLower = (record.status || '').toLowerCase();

                    if (statusLower === 'present') {
                        statusClass = 'present';
                        iconClass = 'fa-check-circle';
                    } else if (statusLower === 'late') {
                        statusClass = 'late';
                        iconClass = 'fa-clock'; // or fa-business-time
                    } else if (statusLower === 'absent') {
                        statusClass = 'absent';
                        iconClass = 'fa-times-circle';
                    }

                    // Format Time (if available) - Assuming time_in is a string like "07:30 AM" or timestamp
                    let timeDisplay = record.time_in || '';
                    if (!timeDisplay && statusLower === 'absent') timeDisplay = record.reason || 'No reason';

                    html += `
                    <div class="attendance-card-item ${statusClass}">
                        <div class="attendance-info-group">
                            <div class="attendance-icon-wrapper">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div>
                                <span class="attendance-date-text">${formatDate(record.date)}</span>
                                <span class="attendance-time-text">${timeDisplay}</span>
                            </div>
                        </div>
                        <div class="attendance-status-badge">${statusText}</div>
                    </div>
                    `;
                });
                html += '</div>';
                attendanceList.innerHTML = html;
            } catch (e) {
                console.error("Error fetching attendance:", e);
                attendanceList.innerHTML = '<p class="text-error">Error loading records.</p>';
            }
        }

        async function checkForAbsenceReason(prefectId) {
            const absentReasonContainer = document.getElementById('absent-reason-container');
            if (!absentReasonContainer) return;

            // Get Today's Date
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;

            const q = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), where("date", "==", todayString), limit(1));

            try {
                const querySnapshot = await getDocs(q);
                let status = 'none'; // 'none', 'present', 'absent'
                let recordData = {};

                if (!querySnapshot.empty) {
                    recordData = querySnapshot.docs[0].data();
                    status = (recordData.status || '').toLowerCase();
                }

                // Determine UI State
                let isDisabled = false;
                let cardColor = '#fff';
                let borderColor = '#ccc';
                let titleColor = '#333';
                let titleText = 'Absence Reporting';
                let messageText = `If you are absent today (<strong>${todayString}</strong>), please report it here.`;
                let icon = 'fas fa-info-circle';
                let showSpinner = false;

                if (status === 'present') {
                    isDisabled = true;
                    cardColor = '#f1f8e9'; // Greenish
                    borderColor = '#66bb6a';
                    titleColor = '#2e7d32';
                    titleText = 'Present Today';
                    messageText = `You have been marked <strong>Present</strong> at ${recordData.time_in || 'Unknown Time'}.`;
                    icon = 'fas fa-check-circle';
                } else if (status === 'absent') {
                    // Marked Absent (either self or admin)
                    isDisabled = false; // Allow editing
                    cardColor = '#fff0f0'; // Reddish
                    borderColor = '#d63031';
                    titleColor = '#d63031';
                    titleText = 'Marked Absent';
                    const existingReason = recordData.reason || 'No reason provided';
                    messageText = `You are marked <strong>Absent</strong>. Reason: <strong>${existingReason}</strong>. You can update this below.`;
                    icon = 'fas fa-user-times';
                } else {
                    // No Record (None) -> Treat as potential absence
                    isDisabled = false;
                    cardColor = '#ffffff'; // White/Neutral
                    borderColor = '#ffa726'; // Orange warning
                    titleColor = '#ef6c00';
                    titleText = 'Not Checked In';
                    messageText = `You have not scanned in for today (<strong>${todayString}</strong>). If you are absent, please submit a reason.`;
                    icon = 'fas fa-exclamation-triangle';
                }

                // Render ALWAYS
                absentReasonContainer.innerHTML = `
                    <div class="dashboard-card" style="border-left: 4px solid ${borderColor}; padding: 1.5rem; background: ${cardColor}; margin-bottom: 2rem; transition: all 0.3s ease;">
                        <h3 style="color: ${titleColor}; margin-top:0; font-size: 1.1rem;"><i class="${icon}"></i> ${titleText}</h3>
                        <p style="margin-bottom: 1rem; color: #444; font-size: 0.95rem;">${messageText}</p>
                        
                        <form id="today-absence-form" style="opacity: ${isDisabled ? '0.6' : '1'}; pointer-events: ${isDisabled ? 'none' : 'all'};">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select id="today-absence-reason-select" style="flex: 1; padding: 0.6rem; border-radius: 8px; border: 1px solid #ccc; background: white;" ${isDisabled ? 'disabled' : 'required'}>
                                    <option value="" disabled selected>Select Reason for Absence</option>
                                    <option value="Sick">Sick / Medical</option>
                                    <option value="Family Emergency">Family Emergency</option>
                                    <option value="Exam / Tuition">Exam / Tuition</option>
                                    <option value="Transport Issue">Transport Issue</option>
                                    <option value="Official Duty">Official Duty</option>
                                    <option value="Other">Other</option>
                                </select>
                                <button type="submit" id="today-absence-submit-btn" style="background: ${isDisabled ? '#999' : '#d63031'}; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600;" ${isDisabled ? 'disabled' : ''}>
                                    <i class="fas fa-save"></i> ${status === 'absent' ? 'Update' : 'Mark Absent'}
                                </button>
                            </div>
                            <input type="text" id="today-absence-reason-other" placeholder="Please specify reason..." style="display:none; width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ccc; margin-top: 10px;" ${isDisabled ? 'disabled' : ''}>
                        </form>
                    </div>
                `;

                // Event Listeners
                const reasonSelect = document.getElementById('today-absence-reason-select');
                const reasonOther = document.getElementById('today-absence-reason-other');
                const form = document.getElementById('today-absence-form');

                if (reasonSelect && reasonOther) {
                    reasonSelect.addEventListener('change', () => {
                        reasonOther.style.display = reasonSelect.value === 'Other' ? 'block' : 'none';
                        if (reasonSelect.value === 'Other') reasonOther.required = true;
                        else reasonOther.required = false;
                    });
                }

                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        if (isDisabled) return;

                        if (!confirm("Confirm absence reporting?")) return;

                        const btn = document.getElementById('today-absence-submit-btn');
                        const originalText = btn.innerHTML;
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                        let reason = reasonSelect.value;
                        if (reason === 'Other') reason = reasonOther.value.trim();

                        try {
                            if (status === 'none') {
                                // Create new record
                                const userDoc = await getDoc(doc(db, "prefects", prefectId));
                                const prefectName = userDoc.exists() ? userDoc.data().name || "Unknown" : "Unknown";

                                await addDoc(collection(db, "attendance"), {
                                    prefect_id: prefectId,
                                    name: prefectName,
                                    date: todayString,
                                    time_in: null,
                                    time_out: null,
                                    status: "Absent",
                                    reason: reason,
                                    created_at: serverTimestamp()
                                });
                            } else if (status === 'absent') {
                                // Update existing record
                                const docId = querySnapshot.docs[0].id;
                                await updateDoc(doc(db, "attendance", docId), {
                                    reason: reason
                                });
                            }

                            // Refresh UI
                            await checkForAbsenceReason(prefectId);
                            fetchKeyStats(prefectId);

                        } catch (err) {
                            console.error("Error saving absence:", err);
                            alert("Error: " + err.message);
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }
                    });
                }

            } catch (error) {
                console.error("Error checking absence status:", error);
                absentReasonContainer.innerHTML = '<p style="color:red">Error loading status.</p>';
            }
        }

        /* --- PERFORMANCE LOGIC --- */
        async function fetchBadWork(prefectId) {
            const badWorkList = document.getElementById('bad-work-list');
            if (!badWorkList) return;

            try {
                // Removed orderBy
                const q = query(collection(db, "bad_work"), where("prefect_id", "==", prefectId), limit(20));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    badWorkList.innerHTML = '<p class="text-muted">No performance issues recorded. Keep it up!</p>';
                    return;
                }

                let records = [];
                querySnapshot.forEach(doc => records.push(doc.data()));

                // Client sort
                records.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

                let html = '<ul class="stats-list" style="list-style:none; padding:0;">';
                records.forEach(record => {
                    html += `<li style="padding:0.5rem 0; border-bottom:1px solid var(--gray-100);">
                        <div style="font-weight:600; color:#d63031;">${formatDate(record.date)}</div>
                        <div style="color:var(--gray-700);">${record.description}</div>
                    </li>`;
                });
                html += '</ul>';
                badWorkList.innerHTML = html;
            } catch (error) {
                console.error("Error fetching bad work:", error);
                badWorkList.innerHTML = '<p class="text-error">Error loading records.</p>';
            }
        }

        /* --- EVENTS LOGIC --- */
        function loadEvents() {
            const eventsListDiv = document.getElementById('events-list');
            const eventsQuery = query(collection(db, 'events'), orderBy("date", "desc"), limit(10));
            onSnapshot(eventsQuery, (snapshot) => {
                const list = document.getElementById('events-list');
                if (!list) return;

                list.innerHTML = snapshot.empty ? '<p style="padding:1rem;">No events scheduled.</p>' : '';
                snapshot.forEach(eventDoc => {
                    const event = { id: eventDoc.id, ...eventDoc.data() };
                    list.appendChild(createEventCard(event));
                });
            }, (error) => {
                console.error("Error loading events:", error);
                const list = document.getElementById('events-list');
                if (list) list.innerHTML = '<p style="padding:1rem; color:red;">Error loading events.</p>';
            });
        }

        function createEventCard(event) {
            const card = document.createElement('div');
            card.className = 'dashboard-card'; // Use existing card class or custom
            card.style.marginBottom = '1rem';
            card.style.borderLeft = '4px solid var(--primary-color)';
            card.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                        <h3 style="margin:0; font-size:1.1rem;">${event.title}</h3>
                        <span style="font-size:0.85rem; color:var(--gray-500);">${formatDate(event.date)}</span>
                    </div>
                    <p style="color:var(--gray-600); font-size:0.95rem; margin-bottom:1rem;">${event.description || 'No description.'}</p>
                    <button onclick="toggleDuties('${event.id}')" style="background: var(--primary-100); color: var(--primary-700); border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight:500; font-size:0.9rem;">
                        <i class="fas fa-tasks"></i> View Duties
                    </button>
                    <ul id="duties-for-${event.id}" style="display: none; margin-top: 1rem; padding-left: 1rem; border-top:1px solid var(--gray-200); padding-top:1rem;"></ul>
                </div>`;
            return card;
        }

        window.toggleDuties = function (eventId) {
            const dutiesList = document.getElementById(`duties-for-${eventId}`);
            if (dutiesList.style.display === 'none') {
                dutiesList.style.display = 'block';
                if (dutiesList.innerHTML === '') {
                    dutiesList.innerHTML = '<li style="color:var(--gray-500);">Loading duties...</li>';
                    loadDutiesForEvent(eventId);
                }
            } else {
                dutiesList.style.display = 'none';
            }
        };

        function loadDutiesForEvent(eventId) {
            const dutiesList = document.getElementById(`duties-for-${eventId}`);
            const dutiesQuery = query(collection(db, 'event_duties'), where('eventId', '==', eventId));
            onSnapshot(dutiesQuery, (snapshot) => {
                dutiesList.innerHTML = snapshot.empty ? "<li style='color:var(--gray-500);'>No duties listed.</li>" : '';
                snapshot.forEach(dutyDoc => {
                    const duty = { id: dutyDoc.id, ...dutyDoc.data() };
                    dutiesList.appendChild(createDutyItem(duty));
                });
            });
        }

        function createDutyItem(duty) {
            const item = document.createElement('li');
            item.style.marginBottom = '0.5rem';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';

            const isTaken = !!duty.assignedPrefectName;

            item.innerHTML = `
                <span style="font-weight:500;">${duty.title}</span>
                <div>
                    ${isTaken ? `<span style="font-size:0.85rem; background:#e8f5e9; color:#2e7d32; padding:2px 8px; border-radius:4px;">Taken by: ${duty.assignedPrefectName}</span>`
                    : `<button class="take-duty-btn" style="background:var(--primary-600); color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem;">Take Duty</button>`}
                </div>`;

            if (!isTaken) {
                item.querySelector('.take-duty-btn').addEventListener('click', () => takeDuty(duty.id));
            }
            return item;
        }

        async function takeDuty(dutyId) {
            const user = auth.currentUser;
            if (!user) return alert("Please login first.");

            // We need currentPrefect data. It should be fetched in global scope or cached.
            // For now, let's fetch it again or assume we can get it from DOM or a global var.
            // In dashboard.html there was a global 'currentPrefect'. I should add that to onAuthStateChanged.

            // Simplification: Fetch prefect ID from DOM (hidden input or similar) or re-query.
            // Better: define currentPrefect globally.

            // Quick fix: query prefects by uid
            const prefectsRef = collection(db, "prefects");
            const q = query(prefectsRef, where("uid", "==", user.uid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return alert("Prefect profile not found.");
            const prefectData = snapshot.docs[0].data();
            const prefectId = snapshot.docs[0].id;

            const dutyRef = doc(db, 'event_duties', dutyId);
            try {
                const dutySnap = await getDoc(dutyRef);
                if (dutySnap.exists() && dutySnap.data().assignedPrefectId) {
                    return alert("Sorry, this duty was just taken!");
                }
                await updateDoc(dutyRef, {
                    assignedPrefectId: prefectId,
                    assignedPrefectName: prefectData.name
                });
                alert("Duty assigned to you successfully!");
            } catch (error) {
                console.error("Error taking duty: ", error);
                alert(`Error: ${error.message}`);
            }
        }

        /* --- IDEAS LOGIC --- */
        let currentPrefectGlobal = null; // Store for easy access

        function initializeIdeas() {
            setupForm();
            // loadMyIdeas(); // Disabled to match dashboard.html and avoid permission errors
            loadPublicIdeas();
        }

        function setupForm() {
            const form = document.getElementById('idea-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                // Ensure we have prefect data
                if (!currentPrefectGlobal) {
                    const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) {
                        currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    } else {
                        return alert("Profile error.");
                    }
                }

                const submitBtn = document.getElementById('idea-submit-btn');
                const messageEl = document.getElementById('submit-message');
                submitBtn.disabled = true;
                messageEl.textContent = 'Submitting...';

                try {
                    await addDoc(collection(db, 'ideas_proposals'), {
                        prefectId: currentPrefectGlobal.id,
                        prefectName: currentPrefectGlobal.name,
                        title: document.getElementById('idea-title').value,
                        description: document.getElementById('idea-description').value,
                        status: 'Pending_Approval',
                        timestamp: serverTimestamp(),
                        upvotes: 0,
                        upvotedBy: []
                    });
                    form.reset();
                    messageEl.textContent = 'Submitted successfully!';
                    messageEl.style.color = 'green';
                } catch (error) {
                    messageEl.textContent = `Error: ${error.message}`;
                    messageEl.style.color = 'red';
                }
                submitBtn.disabled = false;
                setTimeout(() => messageEl.textContent = '', 4000);
            });
        }

        function loadMyIdeas() {
            const user = auth.currentUser;
            if (!user) return;
            // Need prefectID. Let's wait or retry if global not set? 
            // Better: call this after global is set in onAuthStateChanged

            // For now, assume global IS set because we call this inside onAuth
            setTimeout(async () => {
                if (!currentPrefectGlobal) {
                    const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                }

                if (!currentPrefectGlobal) {
                    console.error("CurrentPrefectGlobal is missing inside timeout!");
                    return;
                }
                console.log("Loading ideas for Prefect ID:", currentPrefectGlobal.id);

                const myList = document.getElementById('my-ideas-list');
                // Strict match with ideas.html: orderBy timestamp desc, NO LIMIT
                const q = query(collection(db, 'ideas_proposals'), where('prefectId', '==', currentPrefectGlobal.id), orderBy('timestamp', 'desc'));

                onSnapshot(q, (snapshot) => {
                    if (!myList) return;
                    if (snapshot.empty) {
                        myList.innerHTML = "<p class='text-muted'>You haven't submitted any ideas yet.</p>";
                    } else {
                        myList.innerHTML = '';
                        // No need for client-side sort if query has orderBy, but kept for safety or remove? 
                        // ideas.html relies on query sort.
                        snapshot.forEach(doc => myList.appendChild(renderIdea({ ...doc.data(), id: doc.id }, false, doc.id)));
                    }
                }, (error) => {
                    console.error("Error loading my ideas:", error);
                    if (myList) myList.innerHTML = `<p class='text-error'>Error: ${error.message} (PrefectID: ${currentPrefectGlobal.id})</p>`;
                });
            }, 1000); // Slight delay to ensure auth
        }

        function loadPublicIdeas() {
            const publicList = document.getElementById('public-ideas-list');
            // Removed orderBy. STATUS MUST MATCH ALLOWED VALUES IN SECURITY RULES (likely 'Pending' not 'Pending_Approval')
            const q = query(collection(db, 'ideas_proposals'), where('status', 'in', ['Pending', 'Approved', 'Completed']), limit(20));
            onSnapshot(q, (snapshot) => {
                if (!publicList) return;
                if (snapshot.empty) {
                    publicList.innerHTML = "<p class='text-muted'>No public proposals.</p>";
                } else {
                    publicList.innerHTML = '';
                    let docs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    // Client-side sort: desc
                    docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                    docs.forEach(data => publicList.appendChild(renderIdea(data, true, data.id)));
                }
            }, (error) => {
                console.error("Error loading public ideas:", error);
                if (publicList) publicList.innerHTML = "<p class='text-error'>Error loading public proposals.</p>";
            });
        }


        function renderIdea(idea, isPublic, docId) {
            const item = document.createElement('div');
            item.className = 'idea-item';
            item.style.padding = '1rem';
            item.style.borderBottom = '1px solid var(--gray-200)';

            const normalizedStatus = idea.status.replace('_', ' ');
            let statusColor = 'var(--gray-600)';
            if (idea.status.includes('Approved')) statusColor = 'green';
            if (idea.status.includes('Pending')) statusColor = 'orange';

            const dateString = idea.timestamp ? new Date(idea.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';

            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <h4 style="margin:0; font-size:1rem;">${idea.title}</h4>
                    <span style="font-size:0.75rem; background:${statusColor === 'green' ? '#e8f5e9' : '#fff3e0'}; color:${statusColor}; padding:2px 8px; border-radius:12px;">${normalizedStatus}</span>
                </div>
                <p style="font-size:0.8rem; color:var(--gray-500); margin:0.25rem 0;">By ${idea.prefectName} on ${dateString}</p>
                <p style="font-size:0.9rem; color:var(--gray-700); margin-top:0.5rem;">${idea.description}</p>
                ${isPublic ? `
                <div style="margin-top:0.75rem; display:flex; gap:1rem; align-items:center;">
                    <button class="upvote-btn" data-id="${docId}">
                        <i class="fas fa-thumbs-up"></i> Upvote
                    </button>
                    <span style="font-size:0.85rem; color:var(--gray-600);">${idea.upvotes || 0} Upvotes</span>
                </div>` : ''}`;

            if (isPublic) {
                const upvoteBtn = item.querySelector('.upvote-btn');
                if (currentPrefectGlobal && idea.upvotedBy && idea.upvotedBy.includes(currentPrefectGlobal.id)) {
                    upvoteBtn.classList.add('active-upvote');
                    upvoteBtn.disabled = true;
                    upvoteBtn.innerHTML = '<i class="fas fa-heart"></i> Upvoted';
                }
                if (!upvoteBtn.disabled) {
                    upvoteBtn.addEventListener('click', () => handleUpvote(docId));
                }
            }
            return item;
        }

        async function handleUpvote(docId) {
            if (!currentPrefectGlobal) return alert("Login error");
            const ideaRef = doc(db, "ideas_proposals", docId);
            try {
                await runTransaction(db, async (transaction) => {
                    const ideaDoc = await transaction.get(ideaRef);
                    if (!ideaDoc.exists()) throw "Document does not exist!";
                    const data = ideaDoc.data();
                    const upvotedBy = data.upvotedBy || [];
                    if (upvotedBy.includes(currentPrefectGlobal.id)) return;
                    transaction.update(ideaRef, {
                        upvotes: (data.upvotes || 0) + 1,
                        upvotedBy: arrayUnion(currentPrefectGlobal.id)
                    });
                });
            } catch (e) {
                console.error("Upvote failed: ", e);
            }
        }


        // --- NOTIFICATION & ANNOUNCEMENT LOGIC ---
        let allAnnouncementsGlobal = [];

        function loadAnnouncements() {
            const notificationsList = document.getElementById('notifications-list');
            const dropdownList = document.getElementById('notification-dropdown-list');
            const badgeCount = document.getElementById('notification-badge-count');

            try {
                const q = query(collection(db, "announcements"), orderBy("timestamp", "desc"), limit(20));
                onSnapshot(q, (snapshot) => {
                    allAnnouncementsGlobal = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Update badge count
                    if (badgeCount) badgeCount.textContent = allAnnouncementsGlobal.length;

                    // Populate Sidebar List
                    if (notificationsList) {
                        if (snapshot.empty) {
                            notificationsList.innerHTML = '<p style="padding: 1rem; color:var(--gray-500);">No announcements found.</p>';
                        } else {
                            notificationsList.innerHTML = '';
                            allAnnouncementsGlobal.forEach(ann => {
                                const item = document.createElement('div');
                                item.className = 'notification-item';
                                // Simplified render for sidebar
                                item.innerHTML = `
                                    <strong>${ann.title}</strong>
                                    <p style="font-size:0.85rem; color:var(--gray-600); margin-top:0.25rem;">${ann.content}</p>
                                    <small style="color:var(--gray-400); font-size:0.7rem;">${ann.timestamp ? new Date(ann.timestamp.seconds * 1000).toLocaleDateString() : ''}</small>
                                `;
                                notificationsList.appendChild(item);
                            });
                        }
                    }

                    // Populate Header Dropdown
                    if (dropdownList) {
                        dropdownList.innerHTML = '';
                        if (snapshot.empty) {
                            dropdownList.innerHTML = '<div style="padding:1rem; text-align:center; color:var(--gray-500);">No notifications</div>';
                        } else {
                            allAnnouncementsGlobal.slice(0, 5).forEach(ann => {
                                const item = document.createElement('div');
                                item.className = 'notification-item';
                                item.innerHTML = `
                                    <h5 style="margin:0; font-size:0.9rem;">${ann.title}</h5>
                                    <p style="margin:0; font-size:0.8rem; color:var(--gray-500); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${ann.content}</p>
                                `;
                                dropdownList.appendChild(item);
                            });
                        }
                    }
                }, (error) => {
                    console.error("Error loading announcements snapshot:", error);
                    // Handle missing index or permission errors gracefully
                    if (notificationsList) notificationsList.innerHTML = '<p style="padding:1rem; color:red;">Error loading content. Check permissions/indexes.</p>';
                });
            } catch (e) {
                console.error("Error initializing announcements query:", e);
            }
        }

        // Header Notification Toggle
        const headerNotificationBtn = document.getElementById('header-notification-btn');
        const notificationDropdownPanel = document.getElementById('notification-dropdown-panel');
        if (headerNotificationBtn && notificationDropdownPanel) {
            headerNotificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationDropdownPanel.classList.toggle('active');
            });
            document.addEventListener('click', (e) => {
                if (!notificationDropdownPanel.contains(e.target) && !headerNotificationBtn.contains(e.target)) {
                    notificationDropdownPanel.classList.remove('active');
                }
            });
        }

        // --- CHAT LOGIC ---
        const chatFab = document.getElementById('chatFab');
        const chatContainer = document.getElementById('chatContainer');
        const chatClose = document.getElementById('chatClose');
        const chatSend = document.getElementById('chatSend');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');
        let isChatOpen = false;
        let chatUnsubscribe = null;

        function initializeChat(user) {
            chatFab.addEventListener('click', () => {
                isChatOpen = !isChatOpen;
                chatContainer.classList.toggle('active');
                if (isChatOpen) {
                    listenForMessages(user.uid);
                }
            });
            chatClose.addEventListener('click', () => {
                isChatOpen = false;
                chatContainer.classList.remove('active');
            });
            chatSend.addEventListener('click', () => sendMessage(user));
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(user); });
        }

        function listenForMessages(uid) {
            if (chatUnsubscribe) chatUnsubscribe();

            try {
                const messagesRef = collection(db, 'chats', uid, 'messages');
                const q = query(messagesRef, orderBy('timestamp'), limit(50));

                chatUnsubscribe = onSnapshot(q, (snapshot) => {
                    chatMessages.innerHTML = '';
                    if (snapshot.empty) chatMessages.innerHTML = '<div class="message bot-message">Hello! How can we help you today?</div>';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const div = document.createElement('div');
                        div.className = `message ${msg.senderId === uid ? 'user-message' : 'bot-message'}`;
                        div.textContent = msg.text;
                        chatMessages.appendChild(div);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, (error) => {
                    console.error("Chat Listener Error:", error);
                    chatMessages.innerHTML = '<p class="text-error" style="text-align:center; padding:1rem;">Error loading chat history.</p>';
                });
            } catch (e) {
                console.error("Error setting up chat listener:", e);
            }
        }

        async function sendMessage(user) {
            const text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = '';

            try {
                // Ensure chat doc exists
                await setDoc(doc(db, 'chats', user.uid), {
                    userEmail: user.email,
                    lastUpdate: serverTimestamp()
                }, { merge: true });

                await addDoc(collection(db, 'chats', user.uid, 'messages'), {
                    text: text,
                    senderId: user.uid,
                    timestamp: serverTimestamp(),
                    read: false
                });
            } catch (e) {
                console.error("Chat Send Error", e);
                alert("Failed to send message: " + e.message);
            }
        }

        // --- FUTURE ABSENCE LOGIC ---
        function initializeFutureAbsenceForm(user) {
            const form = document.getElementById('future-absence-form');
            const dateInput = document.getElementById('future-absence-date');
            const select = document.getElementById('replacement-prefect-select');
            const message = document.getElementById('future-absence-message');

            if (!select) {
                console.warn("Replacement select element not found!");
                return;
            }

            // Fill Prefects with error handling
            getDocs(collection(db, 'prefects')).then(snap => {
                select.innerHTML = '<option value="">Select Replacement</option>';
                if (snap.empty) {
                    const opt = document.createElement('option');
                    opt.textContent = "No other prefects found";
                    opt.disabled = true;
                    select.appendChild(opt);
                    return;
                }
                snap.forEach(doc => {
                    const d = doc.data();
                    if (doc.id !== user.uid) { // Exclude self
                        const opt = document.createElement('option');
                        opt.value = doc.id;
                        opt.textContent = d.name || d.email || "Unknown Prefect";
                        opt.dataset.name = d.name || d.email || "Unknown";
                        select.appendChild(opt);
                    }
                });
            }).catch(err => {
                console.error("Error fetching prefects:", err);
                select.innerHTML = '<option value="">Error loading list</option>';
            });

            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentPrefectGlobal) return alert("System refreshing... please try again in a moment.");

                    const btn = document.getElementById('future-absence-submit-btn');
                    btn.disabled = true;
                    btn.textContent = "Submitting...";

                    try {
                        const selectedOption = select.options[select.selectedIndex];
                        if (!selectedOption || !selectedOption.value) throw new Error("Please select a replacement prefect.");

                        const replacementName = selectedOption.dataset.name;

                        await addDoc(collection(db, 'future_absences'), {
                            prefect_id: currentPrefectGlobal.id,
                            prefect_name: currentPrefectGlobal.name,
                            absence_date: dateInput.value,
                            replacement_prefect_id: select.value,
                            replacement_prefect_name: replacementName,
                            reason: document.getElementById('future-absence-reason').value,
                            status: 'pending',
                            timestamp: serverTimestamp()
                        });
                        message.textContent = "Request submitted successfully!";
                        message.style.color = "green";
                        form.reset();
                    } catch (err) {
                        console.error("Absence Request Error:", err);
                        message.textContent = "Error: " + err.message;
                        message.style.color = "red";
                    }
                    btn.disabled = false;
                    btn.textContent = "Submit Request";
                });
            }
        }



        // --- FEATURE: GENERATE SERVICE LETTER (CV) ---
        window.generateServiceLetterPDF = async function () {
            const currentPrefect = currentPrefectGlobal; // Use global var
            if (!currentPrefect) {
                alert("Profile data not loaded yet.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Colors
            const maroon = [140, 28, 19];
            const gold = [212, 175, 55];
            const darkText = [30, 41, 59];
            const lightText = [100, 116, 139];

            // --- DECORATIVE HEADER ---
            // Top Bar
            doc.setFillColor(...maroon);
            doc.rect(0, 0, 210, 45, 'F');

            // Gold Accent
            doc.setDrawColor(...gold);
            doc.setLineWidth(1.5);
            doc.line(0, 43, 210, 43);

            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("EHELIYAGODA CENTRAL COLLEGE", 105, 22, { align: "center" });

            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.setCharSpace(2);
            doc.text("PREFECTS' GUILD | OFFICIAL SERVICE RECORD", 105, 32, { align: "center" });

            // --- PROFILE SECTION ---
            doc.setTextColor(...darkText);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text((currentPrefect.name || "Prefect").toUpperCase(), 20, 65);

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(...lightText);
            doc.text(`Role: ${currentPrefect.destiny || "Member"}`, 20, 72);
            doc.text(`Index: ${currentPrefect.school_index_number || "-"}`, 20, 78);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 84);

            // --- STATS HIGHLIGHTS (Right Side) ---
            const points = document.getElementById('total-points') ? document.getElementById('total-points').textContent : "0";
            const absences = document.getElementById('total-absences') ? document.getElementById('total-absences').textContent : "0";

            // Box 1: Points
            doc.setFillColor(255, 248, 240); // Light Gold bg
            doc.setDrawColor(...gold);
            doc.roundedRect(120, 55, 35, 30, 3, 3, 'FD');
            doc.setFontSize(9);
            doc.text("TOTAL POINTS", 137.5, 63, { align: "center" });
            doc.setFontSize(18);
            doc.setTextColor(...maroon);
            doc.setFont("helvetica", "bold");
            doc.text(points, 137.5, 76, { align: "center" });

            // Box 2: Absences
            doc.setFillColor(241, 245, 249); // Light Gray bg
            doc.setDrawColor(200, 200, 200);
            doc.roundedRect(160, 55, 35, 30, 3, 3, 'FD');
            doc.setFontSize(9);
            doc.setTextColor(...lightText);
            doc.text("ABSENCES", 177.5, 63, { align: "center" });
            doc.setFontSize(18);
            doc.setTextColor(220, 38, 38); // Red
            doc.text(absences, 177.5, 76, { align: "center" });

            // --- CERTIFICATION TEXT ---
            doc.setTextColor(...darkText);
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            const today = new Date().toLocaleDateString();

            const bodyText = `This document certifies the service record of ${currentPrefect.name}, a member of the Prefects' Guild at Eheliyagoda Central College.
        
Throughout their tenure, they have demonstrated commitment to school discipline and leadership. The statistics above reflect their active participation and conduct derived from the digital management system (ECCPMS).

This record is generated automatically and serves as a proof of their standing within the guild as of ${today}.`;

            const splitText = doc.splitTextToSize(bodyText, 170);
            doc.text(splitText, 20, 110);

            // --- FOOTER ---
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text("Generated by ECCPMS - Prefect Management System", 105, 280, { align: "center" });

            doc.save(`Service_Letter_${currentPrefect.name.replace(/\s+/g, '_')}.pdf`);
        }

        // --- FEATURE: GENERATE WARNING RECORD ---
        window.generateWarningPDF = async function () {
            const currentPrefect = currentPrefectGlobal;
            if (!currentPrefect) {
                alert("Profile data not loaded yet.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Colors
            const dangerColor = [220, 53, 69]; // Red
            const darkText = [50, 50, 50];

            // --- HEADER ---
            doc.setFillColor(...dangerColor);
            doc.rect(0, 0, 210, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("DISCIPLINARY RECORD SHEET", 105, 25, { align: "center" });

            // --- INFO ---
            doc.setTextColor(...darkText);
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");

            doc.text(`Prefect: ${currentPrefect.name}`, 20, 55);
            doc.text(`Date Issued: ${new Date().toLocaleDateString()}`, 20, 63);

            // Fetch Bad Work Items

            const badWorkRef = collection(db, "bad_work");
            const q = query(badWorkRef, where("prefect_id", "==", currentPrefect.id));

            try {
                const querySnapshot = await getDocs(q);
                const badWorks = [];
                querySnapshot.forEach((doc) => {
                    badWorks.push(doc.data());
                });

                // Sort by date
                badWorks.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (badWorks.length === 0) {
                    doc.setTextColor(40, 167, 69); // Green
                    doc.setFontSize(14);
                    doc.text("No disciplinary issues recorded. Good conduct!", 105, 80, { align: 'center' });
                } else {
                    // Table
                    const tableData = badWorks.map(item => [
                        item.date,
                        item.description || "Unspecified Issue"
                    ]);

                    doc.autoTable({
                        startY: 75,
                        head: [['Date', 'Infraction Description']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: dangerColor },
                    });

                    const finalY = doc.lastAutoTable.finalY + 20;
                    doc.setFontSize(10);
                    doc.setTextColor(...dangerColor);
                    doc.text("Note: This document lists all recorded 'bad work' entries.", 20, finalY);
                }

                doc.save(`Warning_Record_${currentPrefect.name.replace(/\s+/g, '_')}.pdf`);

            } catch (error) {
                console.error("Error fetching warnings", error);
                alert("Could not fetch warning data. See console.");
            }
        }

        // --- 1. LEADERBOARD LOGIC ---
        window.fetchLeaderboard = async function () {
            const leaderboardList = document.getElementById('leaderboard-list');
            if (!leaderboardList) return;

            try {
                // Query Top 5 by Points
                const q = query(collection(db, "prefects"), orderBy("total_points", "desc"), limit(5));
                const querySnapshot = await getDocs(q);

                leaderboardList.innerHTML = "";
                let rank = 1;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const isMe = currentPrefectGlobal && currentPrefectGlobal.id === doc.id;
                    const color = rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : rank === 3 ? '#CD7F32' : '#333';
                    const bg = isMe ? 'background: #fff8e1; border: 1px solid #ffecb3;' : 'background: #f8f9fa;';

                    const item = `
                        <div style="display: flex; align-items: center; padding: 0.5rem; border-radius: 8px; ${bg}">
                            <div style="width: 25px; font-weight: bold; color: ${color}; font-size: 1.1rem;">#${rank}</div>
                            <img src="${data.picture || 'https://ui-avatars.com/api/?name=' + data.name}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin: 0 10px;">
                            <div style="flex: 1; font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${data.name}</div>
                            <div style="font-weight: bold; color: var(--primary-600); font-size: 0.9rem;">${data.total_points || 0}</div>
                        </div>
                    `;
                    leaderboardList.innerHTML += item;
                    rank++;
                });
            } catch (e) {
                console.error("Leaderboard Error:", e);
                leaderboardList.innerHTML = "<small style='color:red;'>Failed to load leaders.</small>";
            }
        }

        // Call this when dashboard loads (e.g., inside onAuthStateChanged or after profile load)
        // ideally call it once auth is ready
        setTimeout(fetchLeaderboard, 2000);

        // --- 2. DIGITAL ID LOGIC ---
        window.openDigitalID = function () {
            if (!currentPrefectGlobal) return;
            const currentPrefect = currentPrefectGlobal;

            document.getElementById('id-card-name').textContent = currentPrefect.name;
            document.getElementById('id-card-role').textContent = currentPrefect.destiny || "Member";
            document.getElementById('id-card-photo').src = currentPrefect.picture || "meroon Transparent logo prefect.png";
            document.getElementById('id-card-id').textContent = currentPrefect.prefect_unique_id || "-";
            document.getElementById('id-card-index').textContent = currentPrefect.school_index_number || "-";

            // Generate QR Code
            const qrData = `${currentPrefect.name}|${currentPrefect.prefect_unique_id}|Active`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
            document.getElementById('id-card-qr').src = qrUrl;

            document.getElementById('digital-id-modal').style.display = 'flex';
        }

        // --- 3. BIRTHDAY LOGIC ---
        window.checkBirthday = function (dobString) {
            if (!dobString) return;
            const today = new Date();
            const dob = new Date(dobString);
            if (today.getMonth() === dob.getMonth() && today.getDate() === dob.getDate()) {
                document.getElementById('birthday-overlay').style.display = 'flex';
            }
        }

    </script>

    <button class="chat-fab" id="chatFab">
        <i class="fas fa-comments"></i>
        <div id="chat-notification-badge" class="badge"
            style="display: none; position:absolute; top:0; right:0; background:red;">!</div>
    </button>

    </div>

    <!-- CHAT CONTAINER (Restored) -->
    <div id="chatContainer">
        <div class="chat-header">
            <h3>Prefect Support</h3>
            <button id="chatClose"
                style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i
                    class="fas fa-times"></i></button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">Hello! This is an AI assistant connected to ECCPMS. How can I help you
                today?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button id="chatSend"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- DIGITAL ID MODAL -->
    <div id="digital-id-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
        <div style="position:relative;">
            <button onclick="document.getElementById('digital-id-modal').style.display='none'"
                style="position:absolute; top:-10px; right:-10px; background:white; border-radius:50%; width:30px; height:30px; border:none; font-weight:bold; cursor:pointer; z-index:3;">&times;</button>
            <div class="digital-id-card">
                <div class="id-header">
                    <div style="font-size: 10px; letter-spacing: 2px;">EHELIYAGODA CENTRAL COLLEGE</div>
                    <div style="font-weight: bold; margin-top: 5px;">PREFECTS' GUILD</div>
                    <div style="height: 20px;"></div> <!-- Spacer -->
                </div>
                <img id="id-card-photo" src="" class="id-photo">
                <div class="id-body">
                    <div class="id-name" id="id-card-name">Student Name</div>
                    <div class="id-role" id="id-card-role">Prefect</div>
                    <div class="id-details">
                        ID: <span id="id-card-id">0000</span><br>
                        INDEX: <span id="id-card-index">0000</span>
                    </div>
                    <hr style="border:0; border-top:1px dashed #ccc; margin: 10px 0;">
                    <img id="id-card-qr" src="" class="id-qr">
                </div>
                <div class="id-footer">OFFICIAL IDENTITY CARD</div>
            </div>
        </div>
    </div>

    <!-- BIRTHDAY OVERLAY -->
    <div id="birthday-overlay">
        <canvas id="confetti-canvas"
            style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
        <div class="bday-content">
            <h1 style="color: #8C1C13; font-size: 3rem; margin-bottom: 10px;"> Happy Birthday! </h1>
            <p style="font-size: 1.2rem; color: #555;">Wishing you a fantastic day filled with joy!</p>
            <img src="meroon Transparent logo prefect.png" style="height: 100px; margin: 20px auto; display:block;">
            <button class="supiri-btn" onclick="document.getElementById('birthday-overlay').style.display='none'">Thank
                You!</button>
        </div>
    </div>

    <!-- Scirpts End -->
</body>

</html>
