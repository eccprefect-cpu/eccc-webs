<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Prefects' Guild | New Era</title>
    <link rel="icon" href="meroon Transparent logo prefect.png" type="image/png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- DESIGN SYSTEM : MAROON & GOLD PREMIUM --- */
        :root {
            /* Core Colors */
            --primary-700: #58120c;
            /* Deep Maroon */
            --primary-600: #720e0e;
            /* Standard Maroon */
            --primary-500: #942b2b;
            /* Light Maroon */
            --primary-100: #fce8e8;
            /* Pale Maroon */

            --gold-700: #9c7c25;
            --gold-500: #D4AF37;
            /* Metallic Gold */
            --gold-300: #f0d676;
            --gold-100: #fbf5dc;

            /* Neutrals */
            --gray-900: #1a1a1a;
            --gray-600: #5c5c5c;
            --gray-500: #808080;
            --gray-200: #e5e5e5;
            --gray-100: #f5f5f5;
            --white: #ffffff;

            /* Backgrounds (CLEAN THEME) */
            --bg-body: #f3f4f6;
            /* Soft Gray */
            --bg-body-gradient: none;

            --bg-surface: #ffffff;
            --bg-panel: #ffffff;

            /* Effects (CLEAN) */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-glass: none;
            --glass-blur: none;
            --border-glass: 1px solid #e5e7eb;
            /* Light Gray Border */

            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;

            /* Sizing */
            --sidebar-width: 280px;
            --header-height: 80px;
            --radius-xl: 24px;
            --radius-lg: 16px;
        }

        /* --- RESET & BASE --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-body);
            /* Removed Gradient */
            color: var(--gray-900);
            height: 100dvh;
            /* Use dynamic viewport height */
            width: 100%;
            overflow: hidden;
            /* Prevent body scroll entirely */
            display: flex;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: 0.3s;
        }

        ul {
            list-style: none;
        }

        button {
            font-family: inherit;
            cursor: pointer;
        }

        /* --- BADGE SYSTEM CSS --- */
        .badge-container {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: help;
        }

        .role-badge:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .role-badge i {
            font-size: 0.85rem;
        }

        /* --- TIER STYLES --- */
        .badge-rookie {
            background: #f0f0f0;
            color: #777;
            border: 1px solid #ddd;
        }

        .badge-bronze {
            background: linear-gradient(135deg, #cd7f32, #b87333);
            color: #fff;
            box-shadow: 0 2px 8px rgba(205, 127, 50, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .badge-silver {
            background: linear-gradient(135deg, #C0C0C0, #E0E0E0);
            color: #444;
            box-shadow: 0 2px 8px rgba(192, 192, 192, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .badge-gold {
            background: linear-gradient(135deg, #FFD700, #FDB931);
            color: #856404;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.4);
            animation: shine 3s infinite linear;
        }

        .badge-platinum {
            background: linear-gradient(135deg, #e5e4e2, #b0c4de, #ffffff);
            color: #2c3e50;
            box-shadow: 0 2px 15px rgba(176, 196, 222, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        /* Shimmer effect for Platinum */
        .badge-platinum::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.8) 50%, rgba(255, 255, 255, 0) 100%);
            transform: skewX(-25deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            20% {
                left: 200%;
            }

            100% {
                left: 200%;
            }
        }

        @keyframes shine {
            0% {
                filter: brightness(100%);
            }

            50% {
                filter: brightness(110%);
            }

            100% {
                filter: brightness(100%);
            }
        }

        /* --- LAYOUT GRID --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100dvh;
            /* Full viewport fixed */
            overflow: hidden;
        }

        /* --- SIDEBAR (MODERN) --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #ffffff;
            /* Solid White */
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            position: relative;
            z-index: 50;
            box-shadow: none;
            /* Clean look */
            /* Subtle separation */
            transition: transform 0.3s ease;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2.5rem;
            padding: 0 0.5rem;
        }

        .brand img {
            height: 48px;
            filter: drop-shadow(0 4px 6px rgba(114, 14, 14, 0.2));
        }

        .brand-text h1 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-600);
            line-height: 1;
            letter-spacing: -0.5px;
        }

        .brand-text span {
            font-size: 0.75rem;
            color: var(--gold-700);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.85rem 1rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--gray-600);
            font-weight: 500;
            font-size: 0.95rem;
            position: relative;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
            color: var(--gray-500);
            transition: 0.3s;
        }

        .nav-item:hover {
            background-color: var(--primary-100);
            color: var(--primary-700);
        }

        .nav-item:hover i {
            color: var(--primary-600);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: var(--white);
            box-shadow: 0 8px 20px rgba(114, 14, 14, 0.25);
        }

        .nav-item.active i {
            color: var(--gold-500);
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: var(--border-light);
            padding-top: 1.5rem;
        }

        .logout-btn {
            width: 100%;
            padding: 1rem;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, #2d3436, #000000);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-body);
            position: relative;
            height: 100dvh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* --- HEADER --- */
        .header {
            height: var(--header-height);
            padding: 0 2.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 90;
            background: rgba(244, 246, 249, 0.85);
            /* Matches bg-body with opacity */
            backdrop-filter: blur(10px);
        }

        .page-title h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .page-title span {
            color: var(--gray-500);
            font-weight: 400;
            margin-left: 0.5rem;
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* FIX DATA BUTTON STYLE */
        #reset-data-btn {
            background: #e0e0e0;
            color: #333;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
        }

        #reset-data-btn:hover {
            background: #d0d0d0;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid var(--gray-200);
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--gray-600);
            transition: 0.3s;
            position: relative;
        }

        .btn-icon:hover {
            border-color: var(--primary-500);
            color: var(--primary-600);
            transform: rotate(10deg);
        }

        .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--gold-500);
            color: var(--white);
            font-size: 0.65rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: 0.35rem 0.35rem 0.35rem 1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.3s;
        }

        .profile-btn:hover {
            border-color: var(--primary-500);
            box-shadow: var(--shadow-sm);
        }

        .profile-info {
            text-align: right;
            line-height: 1.2;
        }

        .profile-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--gray-900);
            display: block;
        }

        .profile-role {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .profile-img {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--gold-500);
        }

        /* --- DASHBOARD CONTENT GRID (BENTO) --- */
        .content-wrapper {
            padding: 1rem 2.5rem 2.5rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- SMART DASHBOARD LAYOUT (NEW) --- */
        .smart-dashboard-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            height: calc(100vh - 140px);
            overflow: hidden;
        }

        .main-feed {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            padding-right: 0.5rem;
            /* Space for scrollbar */
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        /* Smart Hero */
        .smart-hero {
            background: #ffffff;
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            border: 1px solid #f1f5f9;
        }

        .hero-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .hero-profile-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f1f5f9;
            /* Soft border */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .hero-text h1 {
            font-family: var(--font-display);
            font-size: 1.8rem;
            /* Reduced from 2.5rem to fit long names */
            color: var(--gray-900);
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }

        .hero-text p {
            font-size: 1rem;
            color: var(--gray-500);
        }

        .hero-status {
            text-align: right;
        }

        .status-badge {
            background: #ecfdf5;
            color: #059669;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .status-badge.busy {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Metrics Hub */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .smart-metric {
            background: #fff;
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 160px;
            box-shadow: var(--shadow-sm);
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .smart-metric:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: #f8fafc;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            font-size: 1.2rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-display);
            color: var(--gray-900);
            line-height: 1;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        /* Action Dock */
        .action-dock {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: auto;
        }

        .dock-item {
            background: #fff;
            border: 1px solid #f1f5f9;
            border-radius: 20px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .dock-item:hover {
            background: var(--primary-600);
            border-color: var(--primary-600);
            box-shadow: 0 10px 25px rgba(114, 14, 14, 0.3);
        }

        .dock-item i {
            font-size: 1.8rem;
            color: var(--primary-600);
            transition: 0.3s;
        }

        .dock-item span {
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .dock-item:hover i,
        .dock-item:hover span {
            color: #fff;
        }

        /* Leaderboard Widget */
        .leaderboard-widget {
            background: #fff;
            border-radius: 24px;
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            box-shadow: var(--shadow-sm);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .leader-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #f8fafc;
        }

        .leader-item:last-child {
            border-bottom: none;
        }

        .leader-rank {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--gray-400);
            width: 25px;
        }

        .leader-rank.top-1 {
            color: var(--gold-500);
        }

        @media (max-width: 1024px) {
            .smart-dashboard-layout {
                grid-template-columns: 1fr;
                height: auto;
                overflow: visible;
            }

            .smart-dashboard-layout {
                padding-bottom: 2rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .smart-hero {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .hero-status {
                text-align: center;
            }

            .smart-hero::after {
                width: 100%;
                height: 6px;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .action-dock {
                grid-template-columns: repeat(2, 1fr);
            }
        }


        /* --- Bar Chart --- */
        .bar-chart-container {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: flex-end;
        }

        .bar-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 100%;
            width: 100%;
        }

        @keyframes growBar {
            from {
                transform: scaleY(0);
            }

            to {
                transform: scaleY(1);
            }
        }

        .bar {
            width: 12%;
            background-image: linear-gradient(to top, var(--primary-700), var(--primary-500));
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: all 0.3s ease;
            transform-origin: bottom;
            animation: growBar 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        .bar:hover {
            opacity: 0.9;
            transform: scaleY(1.05);
        }

        .bar::before {
            content: attr(data-value);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--gray-900);
            opacity: 0;
            transition: 0.3s;
        }

        .bar:hover::before {
            opacity: 1;
            top: -30px;
        }

        .bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--gray-500);
            white-space: nowrap;
        }

        /* --- Profile Section --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Upvote Button Animations */
        .upvote-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid var(--gray-300);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            color: var(--gray-600);
        }

        .upvote-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .upvote-btn:active {
            transform: translateY(1px) scale(0.95);
        }

        .upvote-btn i {
            transition: transform 0.3s ease;
        }

        .upvote-btn:hover i {
            transform: scale(1.2) rotate(-10deg);
        }

        .upvote-btn.active-upvote {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(114, 14, 14, 0.3);
        }

        .upvote-btn.active-upvote:hover {
            color: white;
        }

        .profile-header-large {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 2rem;
        }

        .profile-page-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--white);
            box-shadow: var(--shadow-md);
        }

        .profile-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            background: var(--gray-100);
            color: var(--gray-900);
            font-family: inherit;
            transition: 0.3s;
        }

        .form-group input:focus {
            background: var(--white);
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        .form-group input:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* --- About Us Section --- */
        .about-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .about-card {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .team-member {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: 0.3s;
        }

        .team-member:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .team-member img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 1rem;
            object-fit: cover;
        }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        .mobile-menu-btn {
            display: none;
        }

        .sidebar-overlay {
            display: none;
        }

        @media (max-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .card-actions {
                grid-column: span 2;
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .action-list {
                flex-wrap: wrap;
                width: 100%;
            }

            .btn-action {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                height: 100%;
                z-index: 1000;
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.3);
                transition: left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
                /* Smooth slide animation */
            }

            .sidebar.active {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                backdrop-filter: blur(4px);
                opacity: 0;
                transition: opacity 0.3s ease;
                /* Smooth fade for overlay */
                pointer-events: none;
                /* Prevent clicks when hidden */
            }

            .sidebar-overlay.show {
                display: block;
                opacity: 1;
                pointer-events: all;
            }

            .mobile-menu-btn {
                display: block;
                background: transparent;
                border: none;
                font-size: 1.5rem;
                color: var(--gray-700);
            }

            .header {
                padding: 0 1rem;
                justify-content: space-between;
                position: sticky;
                top: 0;
                z-index: 900;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(8px);
            }

            .content-wrapper {
                padding: 1rem;
                padding-bottom: 6rem;
            }

            /* --- Refined Mobile Bento Grid --- */
            .bento-grid {
                /* Keep 2 columns even on mobile for stats */
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            /* Welcome Card: Full Width */
            .card-welcome {
                grid-column: span 2 !important;
                flex-direction: column-reverse;
                text-align: center;
                gap: 1.5rem;
                padding: 1.5rem;
            }

            .welcome-content h2 {
                font-size: 1.5rem;
            }

            .welcome-img {
                width: 100px;
                height: 100px;
            }

            /* Stats: 1 Column each (default behavior, so 2 per row) */
            .card-stat {
                padding: 1rem;
                /* No grid-column override needed, they take 1 slot */
            }

            /* Actions: Full Width */
            .card-actions {
                grid-column: span 2 !important;
                flex-direction: column;
                align-items: flex-start;
            }

            .action-list {
                /* Make buttons 2x2 grid or scrollable? Let's do stacked or grid */
                display: grid;
                grid-template-columns: 1fr 1fr;
                width: 100%;
                gap: 0.5rem;
            }

            .btn-action {
                justify-content: center;
                font-size: 0.85rem;
            }

            /* Chart: Full Width */
            .card[style*="grid-column: span 2"] {
                grid-column: span 2 !important;
                min-height: 250px !important;
            }

            /* Hide profile name on mobile */
            .profile-info {
                display: none;
            }

            .profile-btn {
                padding: 0.35rem;
                gap: 0;
            }
        }

        /* --- NOTIFICATION DROPDOWN --- */
        .notification-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            width: 320px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            z-index: 1000;
            display: none;
            overflow: hidden;
            flex-direction: column;
        }

        .notification-dropdown.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            font-size: 1rem;
            color: var(--primary-700);
            margin: 0;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-body);
        }

        .notification-item.unread {
            background: #fff8f8;
            border-left: 3px solid var(--primary-500);
        }

        .notification-footer {
            padding: 0.75rem;
            text-align: center;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-100);
        }

        .view-all-btn {
            color: var(--primary-600);
            font-size: 0.85rem;
            font-weight: 600;
            background: none;
            border: none;
        }

        /* --- CHAT BOT FLOATING UI --- */
        .chat-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: var(--white);
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 15px rgba(114, 14, 14, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .chat-fab:hover {
            transform: scale(1.1);
        }

        .chat-container {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 350px;
            height: 500px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            z-index: 999;
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: 0.3s ease;
            border: 1px solid var(--border-light);
        }

        .chat-container.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .chat-header {
            background: var(--primary-700);
            color: var(--white);
            padding: 1rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--bg-body);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary-600);
            color: var(--white);
            border-bottom-right-radius: 2px;
        }

        .bot-message {
            align-self: flex-start;
            background: var(--white);
            border: 1px solid var(--gray-200);
            color: var(--gray-900);
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.5rem;
            background: var(--white);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 20px;
            font-family: inherit;
        }

        .chat-send {
            background: var(--primary-600);
            color: var(--white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        /* --- FUTURE ABSENCE FORM --- */
        .future-absence-form {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-top: 1.5rem;
        }

        /* --- IDEAS UI IMPROVEMENTS --- */
        .supiri-btn {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-700));
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
        }

        .supiri-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.6);
        }

        .idea-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: 0.3s;
        }

        .idea-item:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary-100);
        }

        /* --- ABOUT US & TEAM SECTION --- */
        .about-grid,
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .about-card,
        .team-member {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }

        .about-card:hover,
        .team-member:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-200);
        }

        .team-member img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 3px solid var(--primary-100);
            padding: 3px;
            background: white;
            transition: 0.3s;
        }

        .team-member:hover img {
            border-color: var(--gold-500);
            transform: scale(1.05);
        }

        .team-member h4 {
            margin: 0;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
            color: var(--gray-800);
        }

        /* Mobile Responsiveness for About Us */
        @media (max-width: 768px) {

            .about-grid,
            .team-grid {
                grid-template-columns: 1fr;
                /* Stack vertically on mobile */
            }

            .about-card,
            .team-member {
                padding: 1.25rem;
                /* Slightly compact on mobile */
            }
        }

        /* --- GLOBAL MOBILE RESPONSIVENESS FIXES --- */
        @media (max-width: 768px) {

            /* Profile Section: Stack Form & Key Info */
            .profile-form-grid {
                grid-template-columns: 1fr;
            }

            .profile-header-large {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .profile-header-info {
                align-items: center;
            }

            /* Chat Widget: Adjust Size & Position */
            .chat-container {
                width: 90% !important;
                right: 5% !important;
                left: 5% !important;
                bottom: 90px !important;
                height: 60vh !important;
            }

            .chat-fab {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            /* Notification Dropdown: Full Width */
            .notification-dropdown {
                width: 92% !important;
                right: 4% !important;
                left: 4% !important;
                top: 70px !important;
            }

            /* Tables & Lists: Stack Content */
            .stats-list li {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .stats-list li>div:last-child {
                align-self: flex-end;
            }

            /* Card Inner Spacing */
            .idea-item,
            .dashboard-card,
            .card {
                padding: 1rem !important;
            }

            .idea-item>div:first-child {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            /* Main Content Padding/Margins */
            .content-wrapper {
                padding: 1rem 1rem 6rem;
            }

            .header {
                padding: 0 1rem;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- ATTENDANCE LIST STYLES (NEW) --- */
        .attendance-list-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .attendance-card-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }

        .attendance-card-item:hover {
            transform: translateX(4px);
            border-color: var(--primary-200);
            box-shadow: var(--shadow-sm);
        }

        .attendance-card-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--gray-300);
        }

        .attendance-card-item.present::before {
            background: #4caf50;
        }

        .attendance-card-item.late::before {
            background: #ffc107;
        }

        .attendance-card-item.absent::before {
            background: #f44336;
        }

        .attendance-info-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .attendance-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            color: var(--gray-500);
            font-size: 1.1rem;
        }

        .attendance-card-item.present .attendance-icon-wrapper {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .attendance-card-item.late .attendance-icon-wrapper {
            background: #fff8e1;
            color: #fbc02d;
        }

        .attendance-card-item.absent .attendance-icon-wrapper {
            background: #ffebee;
            color: #c62828;
        }

        .attendance-date-text {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95rem;
            display: block;
        }

        .attendance-time-text {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .attendance-status-badge {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 12px;
            letter-spacing: 0.5px;
        }

        .attendance-card-item.present .attendance-status-badge {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .attendance-card-item.late .attendance-status-badge {
            background: #fff8e1;
            color: #fbc02d;
        }

        .attendance-card-item.absent .attendance-status-badge {
            background: #ffebee;
            color: #c62828;
        }

        /* Download Report Card Style */
        .card-download-report {
            grid-column: 1 / -1;
            /* Full width always */
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--white), #f8f9fa);
            padding: 1.5rem;
        }

        /* Disabled Countdown State */
        .supiri-btn:disabled,
        .supiri-btn.disabled-countdown {
            background: var(--gray-200);
            color: var(--gray-600);
            cursor: not-allowed;
            border: 1px solid var(--gray-300);
            box-shadow: none;
        }

        /* DIGITAL ID STYLES */
        .digital-id-card {
            width: 300px;
            background: linear-gradient(135deg, #fff, #f9f9f9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
            border: 1px solid #ddd;
            margin: auto;
        }

        .id-header {
            background: var(--primary-700);
            padding: 15px;
            text-align: center;
            color: white;
        }

        .id-body {
            padding: 20px;
            text-align: center;
        }

        .id-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--gold-500);
            margin: -40px auto 10px;
            /* Pull up into header */
            background: white;
            object-fit: cover;
            position: relative;
            z-index: 2;
        }

        .id-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: #333;
            margin: 5px 0;
        }

        .id-role {
            color: var(--primary-600);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .id-details {
            font-size: 0.8rem;
            color: #555;
            margin: 15px 0;
            line-height: 1.6;
        }

        .id-qr {
            width: 100px;
            height: 100px;
            margin: 10px auto;
        }

        .id-footer {
            background: #eee;
            padding: 10px;
            text-align: center;
            font-size: 0.7rem;
            color: #666;
            letter-spacing: 1px;
        }

        /* BIRTHDAY OVERLAY */
        #birthday-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }

        .bday-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
            animation: popIn 0.5s ease;
            max-width: 90%;
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- SMART CHAT WIDGET --- */
        #chatContainer {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 360px;
            height: 500px;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            /* Strong shadow */
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            animation: slideUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #chatContainer.active {
            display: flex;
        }

        .chat-header {
            background: var(--primary-700);
            color: #fff;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-family: var(--font-display);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .message {
            max-width: 80%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .bot-message {
            background: #fff;
            color: var(--gray-800);
            align-self: flex-start;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 2px;
        }

        .user-message {
            background: var(--primary-600);
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .chat-input-area {
            padding: 1rem;
            background: #fff;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.8rem 1rem;
            border-radius: 25px;
            border: 1px solid #cbd5e1;
            outline: none;
            font-family: var(--font-body);
        }

        .chat-input-area input:focus {
            border-color: var(--primary-500);
        }

        .chat-input-area button {
            background: var(--primary-600);
            color: #fff;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            /* Center icon */
            align-items: center;
            justify-content: center;
        }

        .chat-input-area button:hover {
            background: var(--primary-700);
            transform: scale(1.05);
        }

        .chat-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-600);
            color: #fff;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 1000;
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-fab:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 10px 25px rgba(114, 14, 14, 0.4);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Global Scrolls */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ===== EVENTS SECTION BEAUTIFICATION ===== */
        #events .page-header {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 1.5rem 2rem;
            border-radius: 20px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        #events .page-header h2 {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        /* Event Cards Styling */
        #all-events-list>div {
            background: #fff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        #all-events-list>div::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--gold-500) 0%, var(--primary-600) 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        #all-events-list>div:hover::before {
            transform: scaleY(1);
        }

        #all-events-list>div:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(114, 14, 14, 0.15);
            border-color: var(--primary-200);
        }

        /* Event Title Styling */
        #all-events-list h4,
        #all-events-list .event-title {
            color: var(--gray-900);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #all-events-list h4 i,
        #all-events-list .event-title i {
            color: var(--primary-600);
            font-size: 1rem;
        }

        /* Event Date Badge */
        #all-events-list [style*="color:#64748b"] {
            background: #f1f5f9;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b !important;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Status Tags Enhancement */
        #all-events-list span[style*="background:#fef3c7"],
        #all-events-list span[style*="UPCOMING"] {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
            color: #92400e !important;
            padding: 0.35rem 0.85rem !important;
            border-radius: 20px !important;
            font-weight: 700 !important;
            font-size: 0.75rem !important;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 6px rgba(146, 64, 14, 0.2);
        }

        #all-events-list span[style*="background:#f1f5f9"],
        #all-events-list span[style*="PAST"] {
            background: #f1f5f9 !important;
            color: #64748b !important;
            padding: 0.35rem 0.85rem !important;
            border-radius: 20px !important;
            font-weight: 600 !important;
            font-size: 0.75rem !important;
        }

        /* Duty Slots Section */
        #all-events-list [style*="Available Duty Slots"] {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 12px !important;
            padding: 1rem !important;
        }

        #all-events-list [style*="Available Duty Slots"]>div:first-child {
            color: var(--primary-700) !important;
            font-weight: 800 !important;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.75rem !important;
        }

        /* Duty Slot Item */
        #all-events-list button[onclick*="takeDuty"] {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(114, 14, 14, 0.25);
        }

        #all-events-list button[onclick*="takeDuty"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(114, 14, 14, 0.35);
        }

        /* My Duty Badge */
        #all-events-list span[style*="YOUR DUTY"] {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%) !important;
            color: #166534 !important;
            border: 2px solid #86efac !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px !important;
            font-weight: 800 !important;
            box-shadow: 0 4px 12px rgba(22, 101, 52, 0.15);
        }

        /* History Table Enhancements */
        #my-event-history-body tr {
            transition: all 0.2s ease;
        }

        #my-event-history-body tr:hover {
            background: #f8fafc !important;
            transform: scale(1.01);
        }

        #my-event-history-body td {
            border-bottom: 1px solid #f1f5f9 !important;
        }

        /* Status Badges inTable */
        #my-event-history-body span[style*="VERIFIED"],
        #my-event-history-body span[style*="PRESENT"] {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%) !important;
            box-shadow: 0 2px 6px rgba(22, 101, 52, 0.15);
        }

        #my-event-history-body span[style*="LATE"] {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
            box-shadow: 0 2px 6px rgba(146, 64, 14, 0.15);
        }

        #my-event-history-body span[style*="ABSENT"] {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
            box-shadow: 0 2px 6px rgba(153, 27, 27, 0.15);
        }

        /* Refresh Button Enhancement */
        #events .supiri-btn {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            box-shadow: 0 4px 12px rgba(114, 14, 14, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #events .supiri-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(114, 14, 14, 0.35);
        }

        #events .supiri-btn i {
            transition: transform 0.4s ease;
        }

        #events .supiri-btn:hover i {
            transform: rotate(180deg);
        }

        /* Card Container for Events */
        #events .card {
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        #events .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        /* Card Title with Icon */
        #events .card-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 800;
        }

        #events .card-title i {
            font-size: 1.5rem;
            color: var(--primary-600);
        }

        /* Smooth Fade-in Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #events .card,
        #all-events-list>div {
            animation: fadeInUp 0.4s ease-out;
        }

        #all-events-list>div:nth-child(1) {
            animation-delay: 0.05s;
        }

        #all-events-list>div:nth-child(2) {
            animation-delay: 0.1s;
        }

        #all-events-list>div:nth-child(3) {
            animation-delay: 0.15s;
        }

        #all-events-list>div:nth-child(4) {
            animation-delay: 0.2s;
        }

        #all-events-list>div:nth-child(5) {
            animation-delay: 0.25s;
        }
    </style>
</head>

<body>
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <img src="meroon Transparent logo prefect.png" alt="Logo">
            <div class="brand-text">
                <h1>ECCPMS</h1>
                <span>Prefects' Guild</span>
            </div>
        </div>

        <nav class="nav-menu">
            <a href="#overview" class="nav-item active">
                <i class="fas fa-th-large"></i>
                <span>Overview</span>
            </a>
            <a href="#events" class="nav-item">
                <i class="fas fa-calendar-alt"></i>
                <span>Events</span>
            </a>
            <a href="#ideas" class="nav-item">
                <i class="fas fa-lightbulb"></i>
                <span>Ideas</span>
            </a>
            <a href="#notifications" class="nav-item">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
            </a>
            <a href="#attendance" class="nav-item">
                <i class="fas fa-check-circle"></i>
                <span>Attendance</span>
            </a>
            <a href="#points" class="nav-item">
                <i class="fas fa-star"></i>
                <span>Points</span>
            </a>
            <a href="#performance" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Performance</span>
            </a>
            <a href="#profile" class="nav-item">
                <i class="fas fa-user-circle"></i>
                <span>Profile</span>
            </a>
            <a href="#about" class="nav-item">
                <i class="fas fa-info-circle"></i>
                <span>About Us</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Log Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="page-title">
                    <h2>Dashboard <span>Overview</span></h2>
                </div>
            </div>

            <div class="header-actions">
                <button class="btn-icon" id="header-notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notification-badge-count">0</span>
                </button>

                <div class="notification-dropdown" id="notification-dropdown-panel">
                    <div class="notification-header">
                        <h4>Notifications</h4>
                        <span class="badge"
                            style="position:static; transform:none; background:var(--primary-100); color:var(--primary-700); font-size:0.75rem; padding:2px 8px; border-radius:12px; width:auto; height:auto; border:none;">New</span>
                    </div>
                    <div class="notification-list" id="notification-dropdown-list">
                        <!-- Notifications will be loaded here -->
                        <div style="padding:1rem; text-align:center; color:var(--gray-500);">Loading...</div>
                    </div>
                    <div class="notification-footer">
                        <button class="view-all-btn" id="view-all-notifications-btn">View All Notifications</button>
                    </div>
                </div>



                <button class="profile-btn">
                    <div class="profile-info">
                        <div style="display: flex; align-items: center;">
                            <span class="profile-name" id="user-name">Loading...</span>
                            <div id="badge-container" class="badge-container"></div>
                        </div>
                        <span class="profile-role" id="user-role">Prefect</span>
                    </div>
                    <img src="meroon Transparent logo prefect.png" alt="Profile" class="profile-img"
                        id="header-profile-img">
                </button>
            </div>
        </header>

        <!-- Content Grid -->
        <!-- Content Grid -->
        <div class="content-wrapper">

            <!-- SMART OVERVIEW SECTION -->
            <section id="overview" class="content-section active">
                <div class="smart-dashboard-layout">

                    <!-- Main Feed (Center) -->
                    <div class="main-feed">

                        <!-- Smart Hero -->
                        <div class="smart-hero">
                            <div class="hero-left">
                                <img id="welcome-profile-img" src="meroon Transparent logo prefect.png"
                                    class="hero-profile-img" alt="Profile">
                                <div class="hero-text">
                                    <h1>Welcome Back,<br><span id="welcome-name"
                                            style="color:var(--primary-600)">Prefect</span></h1>
                                    <p id="hero-rank-display"
                                        style="font-size: 1rem; color: var(--gray-600); font-weight: 500;">
                                        Loading Rank...
                                    </p>
                                </div>
                            </div>
                            <div class="hero-status" id="hero-status-display">
                                <div class="status-badge" style="background:#f3f4f6; color:#6b7280;">
                                    <i class="fas fa-circle-notch fa-spin"></i> Checking...
                                </div>
                            </div>
                        </div>

                        <!-- Metrics Hub -->
                        <div class="metrics-grid">
                            <!-- Points -->
                            <div class="smart-metric">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div class="metric-icon"><i class="fas fa-star"></i></div>
                                    <span
                                        style="font-size:0.8rem; background:#fffbf0; color:#d97706; padding:0.2rem 0.5rem; border-radius:10px;">High</span>
                                </div>
                                <div>
                                    <div class="metric-value" id="total-points">0</div>
                                    <div class="metric-label">Total Points</div>
                                </div>
                                <div
                                    style="height:4px; width:100%; background:#f1f5f9; border-radius:2px; margin-top:0.5rem;">
                                    <div style="height:100%; width:75%; background:#d97706; border-radius:2px;"></div>
                                </div>
                            </div>

                            <!-- Attendance Health -->
                            <div class="smart-metric">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div class="metric-icon" style="color:#059669"><i class="fas fa-heartbeat"></i>
                                    </div>
                                </div>
                                <div>
                                    <div class="metric-value" id="attendance-health-value">--%</div>
                                    <div class="metric-label">Attendance Health</div>
                                </div>
                                <div
                                    style="height:4px; width:100%; background:#f1f5f9; border-radius:2px; margin-top:0.5rem;">
                                    <div id="attendance-health-bar"
                                        style="height:100%; width:0%; background:#059669; border-radius:2px; transition: width 1s ease;">
                                    </div>
                                </div>
                            </div>

                            <!-- Absences -->
                            <div class="smart-metric">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div class="metric-icon" style="color:#dc2626"><i
                                            class="fas fa-exclamation-circle"></i></div>
                                </div>
                                <div>
                                    <div class="metric-value" id="total-absences">0</div>
                                    <div class="metric-label">Total Absences</div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Dock -->
                        <div class="action-dock">
                            <button class="dock-item" id="btn-quick-event">
                                <i class="fas fa-calendar-plus"></i>
                                <span>Events</span>
                            </button>
                            <button class="dock-item" id="btn-quick-idea">
                                <i class="fas fa-lightbulb"></i>
                                <span>Idealize</span>
                            </button>
                            <button class="dock-item" id="btn-download-report">
                                <i class="fas fa-file-download"></i>
                                <span>Report</span>
                            </button>
                            <button class="dock-item" id="btn-quick-absence">
                                <i class="fas fa-user-clock"></i>
                                <span>Absence</span>
                            </button>
                        </div>
                    </div>

                    <!-- Side Panel (Right) -->
                    <div class="side-panel">
                        <!-- Rank Widget -->
                        <div class="leaderboard-widget">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                                <h3 style="font-family:var(--font-display); font-size:1.2rem;">Top Leaders</h3>
                                <a href="#" style="font-size:0.85rem; color:var(--primary-600); font-weight:600;">View
                                    All</a>
                            </div>
                            <div id="leaderboard-list">
                                <div style="text-align:center; color:var(--gray-400); padding:2rem;">Loading...</div>
                            </div>
                        </div>

                        <!-- Chart Placeholder (Mini) -->
                        <div class="card" style="padding:1.5rem; flex:1;">
                            <h4 style="margin-bottom:1rem; color:var(--gray-600);">Weekly Insight</h4>
                            <div style="flex:1; position:relative;">
                                <canvas id="attendanceBarChart"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Placeholders for other sections -->
            <!-- EVENTS SECTION (REDESIGNED V2) -->
            <section id="events" class="content-section" style="display:none;">
                <div class="page-header" style="margin-bottom: 2rem;">
                    <div>
                        <h2 style="margin: 0; font-family: var(--font-display);">Event Portal</h2>
                        <p style="color: var(--gray-500);">Manage your event participation</p>
                    </div>
                    <button class="supiri-btn" style="width: auto; padding: 0.5rem 1rem;" onclick="loadMyEvents()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="smart-dashboard-layout">
                    <!-- LEFT: My History -->
                    <div class="main-feed">
                        <div class="card">
                            <h3 class="card-title"
                                style="color: var(--primary-700); border-bottom: 2px solid #f1f5f9; padding-bottom: 0.5rem; margin-bottom: 1rem;">
                                <i class="fas fa-history"></i> My Participation History
                            </h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="text-align: left; background: #f8fafc;">
                                            <th style="padding: 1rem; border-radius: 8px 0 0 8px;">Event</th>
                                            <th style="padding: 1rem;">Date</th>
                                            <th style="padding: 1rem;">Time In</th>
                                            <th style="padding: 1rem; border-radius: 0 8px 8px 0;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-event-history-body">
                                        <!-- Populated by JS -->
                                        <tr>
                                            <td colspan="4" style="padding:1.5rem; text-align:center; color:#999;">
                                                Loading history...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Upcoming / All Events -->
                    <div class="side-panel">
                        <div class="card"
                            style="background: linear-gradient(135deg, #fff, #fffdf5); border: 1px solid #ffeeba;">
                            <h3 class="card-title" style="color: #b7791f; margin-bottom: 1rem;">
                                <i class="fas fa-calendar-star"></i> All School Events
                            </h3>
                            <div id="all-events-list" style="display: flex; flex-direction: column; gap: 1rem;">
                                <!-- Populated by JS -->
                                <p style="color:#999;font-size:0.9rem;">Loading events...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="ideas" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Ideas & Proposals</h2>

                <div class="bento-grid" style="grid-template-columns: 1fr;">
                    <!-- Submit Idea Form -->
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 1rem; color: var(--primary-700);">Submit an Idea
                        </h3>
                        <form id="idea-form">
                            <div class="form-group">
                                <label for="idea-title">Title</label>
                                <input type="text" id="idea-title" placeholder="Title of your idea" required>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="idea-description">Description</label>
                                <textarea id="idea-description" rows="4" placeholder="Describe your idea in detail..."
                                    required
                                    style="width: 100%; padding: 0.85rem 1rem; border: 1px solid var(--gray-200); border-radius: var(--radius-lg); background: var(--gray-100); color: var(--gray-900); font-family: inherit; transition: 0.3s;"></textarea>
                            </div>
                            <button type="submit" id="idea-submit-btn" class="supiri-btn"
                                style="margin-top: 1rem; width: 100%;">
                                <i class="fas fa-paper-plane"></i> Submit for Approval
                            </button>
                            <p id="submit-message" style="margin-top: 1rem; font-size: 0.9rem; text-align: center;"></p>
                        </form>
                    </div>

                    <!-- My Submissions (Hidden because dashboard.html didn't have it and it causes permission errors) -->
                    <div class="card" style="display: none;">
                        <h3 class="card-title" style="margin-bottom: 1rem;">My Submissions</h3>
                        <div id="my-ideas-list" class="ideas-list">
                            <p style="color: var(--gray-500);">Loading your ideas...</p>
                        </div>
                    </div>

                    <!-- Public Proposals -->
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 1rem;">Public Proposals</h3>
                        <div id="public-ideas-list" class="ideas-list">
                            <p style="color: var(--gray-500);">Loading public proposals...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="notifications" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Notifications</h2>
                <div class="card">
                    <div id="notifications-list" class="notification-list" style="max-height:none;">
                        <p style="color:var(--gray-500);">Loading announcements...</p>
                    </div>
                </div>
            </section>

            <section id="attendance" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Attendance Record</h2>
                <div id="absent-reason-container" style="margin-bottom: 2rem;">
                    <!-- Absence Reason Form (Dynamically Injected) -->
                </div>
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem; color:var(--primary-600);">Request Future Absence
                        / Duty Handover</h3>
                    <p style="color:var(--gray-600); margin-bottom:1rem; font-size:0.9rem;">Plan your absence in advance
                        and assign a replacement.</p>
                    <form id="future-absence-form" class="future-absence-form">
                        <div class="profile-form-grid">
                            <div class="form-group">
                                <label>Date of Absence</label>
                                <input type="date" id="future-absence-date" required>
                            </div>
                            <div class="form-group">
                                <label>Replacement Prefect</label>
                                <select id="replacement-prefect-select" required>
                                    <option value="">Select Prefect</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:1rem;">
                            <label>Reason / Handover Note</label>
                            <textarea id="future-absence-reason" rows="2"
                                placeholder="Explain reason and duty details..." required></textarea>
                        </div>
                        <button type="submit" id="future-absence-submit-btn" class="supiri-btn"
                            style="width:auto; margin-top:1rem;">Submit Request</button>
                        <p id="future-absence-message" style="margin-top:0.5rem; font-size:0.9rem;"></p>
                    </form>
                </div>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;">Recent Attendance</h3>
                    <div id="recent-attendance-list">
                        <p style="color: var(--gray-500);">Loading attendance...</p>
                    </div>
                </div>
            </section>

            <!-- EVENTS SECTION (REDESIGNED) -->
            <section id="events" class="content-section" style="display:none;">
                <div class="page-header" style="margin-bottom: 2rem;">
                    <div>
                        <h2 style="margin: 0; font-family: var(--font-display);">Event Portal</h2>
                        <p style="color: var(--gray-500);">Manage your event participation</p>
                    </div>
                    <button class="supiri-btn" style="width: auto; padding: 0.5rem 1rem;" onclick="loadMyEvents()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="smart-dashboard-layout"
                    style="display: flex !important; flex-direction: column !important; width: 100% !important;">

                    <!-- TOP: Upcoming / All Events -->
                    <div class="main-feed" style="width: 100%;">
                        <div class="card"
                            style="background: linear-gradient(135deg, #fff, #fffdf5); border: 1px solid #ffeeba;">
                            <h3 class="card-title" style="color: #b7791f; margin-bottom: 1rem;">
                                <i class="fas fa-calendar-star"></i> Upcoming School Events
                            </h3>
                            <div id="all-events-list" style="display: flex; flex-direction: column; gap: 1rem;">
                                <!-- Populated by JS -->
                                <p style="color:#999;font-size:0.9rem;">Loading events...</p>
                            </div>
                        </div>
                    </div>

                    <!-- BOTTOM: My History -->
                    <div class="main-feed" style="width: 100%;">
                        <div class="card">
                            <h3 class="card-title"
                                style="color: var(--primary-700); border-bottom: 2px solid #f1f5f9; padding-bottom: 0.5rem; margin-bottom: 1rem;">
                                <i class="fas fa-history"></i> My Participation History
                            </h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="text-align: left; background: #f8fafc;">
                                            <th style="padding: 1rem; border-radius: 8px 0 0 8px;">Event</th>
                                            <th style="padding: 1rem;">Date</th>
                                            <th style="padding: 1rem;">Time In</th>
                                            <th style="padding: 1rem; border-radius: 0 8px 8px 0;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-event-history-body">
                                        <!-- Populated by JS -->
                                        <tr>
                                            <td colspan="4" style="padding:1.5rem; text-align:center; color:#999;">
                                                Loading history...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <section id="points" class="content-section" style="display:none;">
                <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">Points History</h2>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;">Recent Points</h3>
                    <div id="recent-points-list">
                        <p style="color: var(--gray-500);">Loading points history...</p>
                    </div>
                </div>
            </section>

            <section id="performance" class="content-section" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0; font-family: var(--font-display);">Performance & Duty</h2>
                    <button class="supiri-btn"
                        style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background: #c0392b;"
                        onclick="generateWarningPDF()">
                        <i class="fas fa-exclamation-circle"></i> Download Record
                    </button>
                </div>
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem; color:#d63031;">Performance Issues</h3>
                    <div id="bad-work-list">
                        <p style="color: var(--gray-500);">Loading records...</p>
                    </div>
                </div>
            </section>

            <section id="profile" class="content-section" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0; font-family: var(--font-display);">My Profile</h2>
                    <div style="display: flex; gap: 10px;">
                        <!-- <button class="supiri-btn"
                            style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background: var(--primary-600);"
                            onclick="openDigitalID()">
                            <i class="fas fa-id-card"></i> View ID
                        </button>-->
                        <!-- <button class="supiri-btn"
                            style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background: var(--gray-600);"
                            onclick="generateServiceLetterPDF()">
                            <i class="fas fa-file-download"></i> Download CV
                        </button> -->
                    </div>
                </div>
                <div class="card">
                    <div class="profile-header-large">
                        <img id="profile-page-picture" src="meroon Transparent logo prefect.png" alt="Profile Picture"
                            class="profile-page-img">
                        <div class="profile-header-info">
                            <h3 id="profile-page-name" style="font-size: 1.5rem; margin-bottom: 0.25rem;">Prefect Name
                            </h3>
                            <p id="profile-page-role-display" style="color: var(--gold-700); font-weight: 600;">Senior
                                Prefect</p>
                            <small id="profile-prefect-id" style="color: var(--gray-500);">ID: -</small>
                        </div>
                    </div>

                    <div class="profile-form-grid">
                        <div class="form-group">
                            <label for="profile-email">Email</label>
                            <input type="email" id="profile-email" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-phone">Phone</label>
                            <input type="tel" id="profile-phone" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-class-static">Class</label>
                            <input type="text" id="profile-class-static" value="-">
                        </div>

                        <div class="form-group">
                            <label for="profile-section">Section</label>
                            <input type="text" id="profile-section" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-index">Index Number</label>
                            <input type="text" id="profile-index" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-parents-phone">Parents' Phone</label>
                            <input type="tel" id="profile-parents-phone" value="-" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-current-duty">Current Duty</label>
                            <input type="text" id="profile-current-duty" value="-">
                        </div>
                        <div class="form-group">
                            <label for="profile-role-input">Role </label>
                            <select id="profile-role-input" class="form-control"
                                style="width: 100%; padding: 0.8rem; border: 1px solid var(--gray-300); border-radius: 8px; font-family: inherit;">
                                <option value="Head Prefect">Head Prefect</option>
                                <option value="Deputy Head Prefect">Deputy Head Prefect</option>
                                <option value="Co.Cu.Head Prefect">Co.Cu.Head Prefect</option>
                                <option value="Sectional Head Prefect">Sectional Head Prefect</option>
                                <option value="Senior Prefect">Senior Prefect</option>
                                <option value="Junior Prefect">Junior Prefect</option>
                                <option value="Senior Probationary Prefect">Senior Probationary Prefect</option>
                                <option value="Junior Probationary Prefect">Junior Probationary Prefect</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile-total-points">Total Points</label>
                            <input type="text" id="profile-total-points" value="Loading..." disabled
                                style="font-weight:bold; color:var(--primary-color);">
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button class="supiri-btn" onclick="saveProfileChanges()"
                            style="width: auto; padding: 0.8rem 2rem;">
                            <i class="fas fa-save"></i> Save Profile
                        </button>
                    </div>
                </div>
        </div>
        </section>

        <!-- ABOUT US SECTION -->
        <!-- ABOUT US SECTION (PREMIUM REDESIGN) -->
        <section id="about" class="content-section" style="display:none; animation: fadeIn 0.4s ease-out;">
            <div style="max-width: 1400px; margin: 0 auto; padding: 0 20px;">

                <!-- Premium Hero Section -->
                <div class="about-hero" style="
                background: linear-gradient(135deg, #fff, #fff1f2); 
                border-radius: 24px; 
                padding: 3rem 2rem; 
                text-align: center; 
                margin-bottom: 2.5rem; 
                border: 1px solid #ffe4e6; 
                box-shadow: 0 10px 30px -10px rgba(148, 43, 43, 0.1);
                position: relative;
                overflow: hidden;">

                    <!-- Decorative Background Circle -->
                    <div
                        style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(148, 43, 43, 0.05); border-radius: 50%;">
                    </div>
                    <div
                        style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: rgba(212, 175, 55, 0.05); border-radius: 50%;">
                    </div>

                    <img src="meroon Transparent logo prefect.png"
                        style="width: 90px; margin-bottom: 1.5rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                    <h2
                        style="font-family: var(--font-display); font-size: 2.5rem; color: var(--primary-700); margin-bottom: 0.5rem;">
                        ECCPMS Prefects' Guild</h2>
                    <p
                        style="text-transform: uppercase; letter-spacing: 3px; font-weight: 700; color: var(--gold-700); font-size: 0.9rem; margin-bottom: 1.5rem;">
                        2025 / 2026 Digital Initiative</p>

                    <p
                        style="max-width: 700px; margin: 0 auto; color: var(--gray-600); font-size: 1.1rem; line-height: 1.7;">
                        Empowering the school administration with cutting-edge technology. A fully integrated digital
                        ecosystem designed to streamline prefect duties, attendance tracking, and performance analytics.
                    </p>
                </div>

                <!-- Stats Row -->
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 3.5rem;">
                    <div class="stat-card"
                        style="background: white; padding: 1.5rem; border-radius: 20px; border: 1px solid #f1f5f9; text-align: center; box-shadow: var(--shadow-sm); transition: transform 0.3s;">
                        <i class="fas fa-server"
                            style="font-size: 1.5rem; color: var(--primary-500); margin-bottom: 0.5rem; opacity: 0.8;"></i>
                        <div style="font-size: 2rem; font-weight: 800; color: var(--gray-900);">24/7</div>
                        <div
                            style="font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: var(--gray-500); letter-spacing: 1px;">
                            System Uptime</div>
                    </div>
                    <div class="stat-card"
                        style="background: white; padding: 1.5rem; border-radius: 20px; border: 1px solid #f1f5f9; text-align: center; box-shadow: var(--shadow-sm); transition: transform 0.3s;">
                        <i class="fas fa-code-branch"
                            style="font-size: 1.5rem; color: var(--gold-500); margin-bottom: 0.5rem; opacity: 0.8;"></i>
                        <div style="font-size: 2rem; font-weight: 800; color: var(--gray-900);">v3.18</div>
                        <div
                            style="font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: var(--gray-500); letter-spacing: 1px;">
                            Current Version</div>
                    </div>
                    <div class="stat-card"
                        style="background: white; padding: 1.5rem; border-radius: 20px; border: 1px solid #f1f5f9; text-align: center; box-shadow: var(--shadow-sm); transition: transform 0.3s;">
                        <i class="fas fa-shield-alt"
                            style="font-size: 1.5rem; color: #059669; margin-bottom: 0.5rem; opacity: 0.8;"></i>
                        <div style="font-size: 2rem; font-weight: 800; color: var(--gray-900);">Secure</div>
                        <div
                            style="font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: var(--gray-500); letter-spacing: 1px;">
                            Cloud Database</div>
                    </div>
                </div>

                <!-- Team Section -->
                <div style="margin-bottom: 2rem; text-align: center;">
                    <h3
                        style="font-family: var(--font-display); font-size: 1.8rem; color: var(--gray-900); margin-bottom: 0.5rem;">
                        Meet the Minds</h3>
                    <p style="color: var(--gray-500);">The development team behind the ECCPMS ecosystem</p>
                </div>

                <div class="team-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">

                    <!-- Adeesha (Lead/Backend) -->
                    <div class="team-card"
                        style="background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid #f1f5f9; box-shadow: var(--shadow-sm); transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; align-items: flex-start; gap: 1rem;">
                        <div
                            style="width: 3px; height: 100%; background: #9333ea; position: absolute; left: 0; top: 0;">
                        </div>
                        <div
                            style="background: #f3e8ff; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #9333ea; font-size: 1.2rem; flex-shrink: 0;">
                            <i class="fas fa-database"></i>
                        </div>
                        <div>
                            <h4
                                style="margin: 0 0 0.25rem 0; font-size: 1.1rem; color: var(--gray-900); font-weight: 700;">
                                Adeesha Ravimal</h4>
                            <span
                                style="font-size: 0.7rem; font-weight: 700; color: #9333ea; background: #f3e8ff; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Co-Founder
                                & Backend Lead</span>
                            <p
                                style="font-size: 0.85rem; color: var(--gray-500); margin-top: 0.75rem; line-height: 1.5;">
                                Developing the Core Database and PC Software. The backbone of the system's
                                infrastructure.</p>
                        </div>
                    </div>

                    <!-- Hansaka (Lead/Fullstack) -->
                    <div class="team-card"
                        style="background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid #f1f5f9; box-shadow: var(--shadow-sm); transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; align-items: flex-start; gap: 1rem;">
                        <div
                            style="width: 3px; height: 100%; background: #2563eb; position: absolute; left: 0; top: 0;">
                        </div>
                        <div
                            style="background: #eff6ff; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #2563eb; font-size: 1.2rem; flex-shrink: 0;">
                            <i class="fas fa-code"></i>
                        </div>
                        <div>
                            <h4
                                style="margin: 0 0 0.25rem 0; font-size: 1.1rem; color: var(--gray-900); font-weight: 700;">
                                Hansaka P. Fernando</h4>
                            <span
                                style="font-size: 0.7rem; font-weight: 700; color: #2563eb; background: #eff6ff; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Co-Founder
                                & Lead Architect</span>
                            <p
                                style="font-size: 0.85rem; color: var(--gray-500); margin-top: 0.75rem; line-height: 1.5;">
                                Complete development of the Web Interface and Mobile Admin App. Engineered the
                                full-stack ecosystem.</p>
                        </div>
                    </div>

                    <!-- Rashmi (Logic) -->
                    <div class="team-card"
                        style="background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid #f1f5f9; box-shadow: var(--shadow-sm); transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; align-items: flex-start; gap: 1rem;">
                        <div
                            style="width: 3px; height: 100%; background: #ea580c; position: absolute; left: 0; top: 0;">
                        </div>
                        <div
                            style="background: #fff7ed; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #ea580c; font-size: 1.2rem; flex-shrink: 0;">
                            <i class="fas fa-sitemap"></i>
                        </div>
                        <div>
                            <h4
                                style="margin: 0 0 0.25rem 0; font-size: 1.1rem; color: var(--gray-900); font-weight: 700;">
                                Rashmi Jananjana</h4>
                            <span
                                style="font-size: 0.7rem; font-weight: 700; color: #ea580c; background: #fff7ed; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Head
                                of Logic & Operations</span>
                            <p
                                style="font-size: 0.85rem; color: var(--gray-500); margin-top: 0.75rem; line-height: 1.5;">
                                Architected system logic and guided student data integration. Key operational
                                strategist.</p>
                        </div>
                    </div>

                    <!-- Nethmi (QA) -->
                    <div class="team-card"
                        style="background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid #f1f5f9; box-shadow: var(--shadow-sm); transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; align-items: flex-start; gap: 1rem;">
                        <div
                            style="width: 3px; height: 100%; background: #059669; position: absolute; left: 0; top: 0;">
                        </div>
                        <div
                            style="background: #ecfdf5; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #059669; font-size: 1.2rem; flex-shrink: 0;">
                            <i class="fas fa-check-shield"></i>
                        </div>
                        <div>
                            <h4
                                style="margin: 0 0 0.25rem 0; font-size: 1.1rem; color: var(--gray-900); font-weight: 700;">
                                Nethmi Dananjana</h4>
                            <span
                                style="font-size: 0.7rem; font-weight: 700; color: #059669; background: #ecfdf5; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;">QA
                                Lead & Logic Support</span>
                            <p
                                style="font-size: 0.85rem; color: var(--gray-500); margin-top: 0.75rem; line-height: 1.5;">
                                Managed system testing and supported logic development. Ensured a bug-free user
                                experience.</p>
                        </div>
                    </div>

                    <!-- Avishka (Media/UI) -->
                    <div class="team-card"
                        style="background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid #f1f5f9; box-shadow: var(--shadow-sm); transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; align-items: flex-start; gap: 1rem;">
                        <div
                            style="width: 3px; height: 100%; background: #db2777; position: absolute; left: 0; top: 0;">
                        </div>
                        <div
                            style="background: #fdf2f8; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #db2777; font-size: 1.2rem; flex-shrink: 0;">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div>
                            <h4
                                style="margin: 0 0 0.25rem 0; font-size: 1.1rem; color: var(--gray-900); font-weight: 700;">
                                Avishka kalhara</h4>
                            <span
                                style="font-size: 0.7rem; font-weight: 700; color: #db2777; background: #fdf2f8; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Media
                                Director & UI Contributor</span>
                            <p
                                style="font-size: 0.85rem; color: var(--gray-500); margin-top: 0.75rem; line-height: 1.5;">
                                Directed photography for the system and contributed to initial UI concepts for the index
                                page.</p>
                        </div>
                    </div>

                    <!-- Thevindu (Initiator) -->
                    <div class="team-card"
                        style="background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid #f1f5f9; box-shadow: var(--shadow-sm); transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; align-items: flex-start; gap: 1rem;">
                        <div
                            style="width: 3px; height: 100%; background: #be123c; position: absolute; left: 0; top: 0;">
                        </div>
                        <div
                            style="background: #fff1f2; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #be123c; font-size: 1.2rem; flex-shrink: 0;">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div>
                            <h4
                                style="margin: 0 0 0.25rem 0; font-size: 1.1rem; color: var(--gray-900); font-weight: 700;">
                                Thevindu Thisev</h4>
                            <span
                                style="font-size: 0.7rem; font-weight: 700; color: #be123c; background: #fff1f2; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Project
                                Initiator</span>
                            <p
                                style="font-size: 0.85rem; color: var(--gray-500); margin-top: 0.75rem; line-height: 1.5;">
                                Visionary behind the ECCPMS project. Initiated the collaboration and requested the
                                system development.
                            </p>
                        </div>
                    </div>

                </div>

                <!-- Footer Quote -->
                <div class="card"
                    style="margin-top: 4rem; text-align: center; background: #1a1a1a; color: white; padding: 2.5rem;">
                    <i class="fas fa-quote-left"
                        style="color: var(--gold-500); font-size: 1.5rem; margin-bottom: 1rem; display:block; opacity: 0.8;"></i>
                    <p
                        style="font-size: 1.2rem; font-style: italic; font-family: var(--font-display); letter-spacing: 0.5px; line-height: 1.6;">
                        "Let this be a tribute to those who said we can't do this."</p>
                    <div style="margin-top: 2rem; display: flex; justify-content: center; gap: 1.5rem;">
                        <a href="https://github.com" target="_blank"
                            style="color: white; opacity: 0.6; transition: 0.3s; font-size: 1.2rem;"><i
                                class="fab fa-github"></i></a>
                        <a href="#" style="color: white; opacity: 0.6; transition: 0.3s; font-size: 1.2rem;"><i
                                class="fas fa-globe"></i></a>
                        <a href="#" style="color: white; opacity: 0.6; transition: 0.3s; font-size: 1.2rem;"><i
                                class="fas fa-envelope"></i></a>
                    </div>
                </div>
        </section>

        <style>
            /* ANIMATIONS & INTERACTIONS FOR ABOUT SECTION */
            .team-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08) !important;
            }

            .team-card:hover h4 {
                color: var(--primary-600) !important;
            }

            .stat-card:hover {
                transform: translateY(-5px);
                border-color: var(--gold-300) !important;
            }

            /* Fade In Animation */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>

        <script>
            // --- NEW: POINTS HISTORY LOGIC ---
            window.loadPointsHistory = async function () {
                const list = document.getElementById('recent-points-list');
                if (!list) return;

                list.innerHTML = '<p style="color:#888; text-align:center;"><i class="fas fa-circle-notch fa-spin"></i> Loading points...</p>';

                if (!window.currentPrefectGlobal) {
                    setTimeout(loadPointsHistory, 1000);
                    return;
                }

                try {
                    const q = query(collection(db, "points"), where("prefect_id", "==", window.currentPrefectGlobal.id), orderBy("timestamp", "desc"));
                    const snap = await getDocs(q);

                    if (snap.empty) {
                        list.innerHTML = '<p style="padding:1rem; text-align:center; color:#888;">No point changes recorded yet.</p>';
                    } else {
                        let html = '<table style="width:100%; border-collapse:collapse;">';
                        html += '<tr style="background:#f8f9fa; text-align:left;"><th style="padding:0.8rem;">Date</th><th style="padding:0.8rem;">Reason</th><th style="padding:0.8rem; text-align:right;">Points</th></tr>';

                        snap.forEach(doc => {
                            const d = doc.data();
                            const color = d.points > 0 ? 'green' : 'red';
                            const sign = d.points > 0 ? '+' : '';

                            html += `
                                <tr style="border-bottom:1px solid #eee;">
                                    <td style="padding:0.8rem; font-size:0.9rem; color:#555;">${d.date}</td>
                                    <td style="padding:0.8rem; font-weight:500;">${d.reason}</td>
                                    <td style="padding:0.8rem; text-align:right; font-weight:bold; color:${color};">${sign}${d.points}</td>
                                </tr>
                               `;
                        });
                        html += '</table>';
                        list.innerHTML = html;
                    }
                } catch (e) {
                    console.error("Points Error:", e);
                    list.innerHTML = `<p style="color:red; text-align:center;">Error loading points: ${e.message}</p>`;
                }
            };

            // Add to navigation click listener
            document.querySelectorAll('.nav-item[href="#points"]').forEach(btn => {
                btn.addEventListener('click', loadPointsHistory);
            });
        </script>


        <section id="about" class="content-section" style="display:none;">
            <h2 style="margin-bottom: 1.5rem; font-family: var(--font-display);">About Us</h2>

            <div class="card" style="margin-bottom: 2rem;">
                <div class="about-header" style="text-align: center; max-width: 800px; margin: 0 auto;">
                    <h2 style="color: var(--primary-700); margin-bottom: 1rem;">About Our Mission</h2>
                    <p style="color: var(--gray-600); line-height: 1.6;">We are a team of passionate and innovative
                        students from Eheliyagoda Central College, brought
                        together by a shared vision of leveraging technology to improve our school's ecosystem.</p>
                </div>
            </div>

            <div class="about-grid">
                <div class="about-card">
                    <div class="stat-icon" style="margin: 0 auto 1rem;"><i class="fas fa-rocket"></i></div>
                    <h3>About The Project</h3>
                    <p style="color: var(--gray-600); margin-top: 0.5rem;">Welcome to the official portal for the
                        Eheliyagoda Central College Prefect Management
                        System (ECCPMS). Digitzing the Prefects' Guild.</p>
                </div>
                <div class="about-card">
                    <div class="stat-icon" style="margin: 0 auto 1rem;"><i class="fas fa-code-branch"></i></div>
                    <h3>Project Version</h3>
                    <p style="color: var(--gray-600); margin-top: 0.5rem;">Current Version: <strong>1.0.0</strong>.
                        The first official release of the ECCPMS.</p>
                </div>
            </div>

            <h3 style="margin-bottom: 1.5rem;">Meet The Team</h3>
            <div class="team-grid">
                <!-- Developers -->
                <div class="team-member">
                    <img src="Developer Team/Adeesha.jpg" alt="Adeesha"
                        onerror="this.src='meroon Transparent logo prefect.png'">
                    <h4>Adeesha Ravimal</h4>
                    <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Backend & Desktop
                        App</p>
                    <p style="font-size: 0.8rem; color: var(--gray-600);">System Architect</p>
                </div>
                <div class="team-member">
                    <img src="Developer Team/Hansaka.png" alt="Hansaka"
                        onerror="this.src='meroon Transparent logo prefect.png'">
                    <h4>Hansaka Fernando</h4>
                    <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Web & Mobile App
                    </p>
                    <p style="font-size: 0.8rem; color: var(--gray-600);">UI/UX Designer</p>
                </div>
                <div class="team-member">
                    <img src="Developer Team/thevindu.JPG" alt="Thevindu"
                        onerror="this.src='meroon Transparent logo prefect.png'">
                    <h4>Thevindu Thisev</h4>
                    <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Data Collector</p>
                    <p style="font-size: 0.8rem; color: var(--gray-600);">Database Admin</p>
                </div>
                <div class="team-member">
                    <img src="Developer Team/Nethmi.jpg" alt="Nethmi"
                        onerror="this.src='meroon Transparent logo prefect.png'">
                    <h4>Nethmi Dhananjana</h4>
                    <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Coordinator</p>
                </div>
                <div class="team-member">
                    <img src="Developer Team/Rashmi.jpg" alt="Rashmi"
                        onerror="this.src='meroon Transparent logo prefect.png'">
                    <h4>Rashmi Jananjana</h4>
                    <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Student Mgmt Lead
                    </p>
                </div>
                <div class="team-member">
                    <img src="Developer Team/Avishka.jpg" alt="Avishka"
                        onerror="this.src='meroon Transparent logo prefect.png'">
                    <h4>Avishka Kalhara</h4>
                    <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">Media Partner</p>
                </div>
            </div>
        </section>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, limit, orderBy, addDoc, doc, updateDoc, runTransaction, arrayUnion, getDoc, setDoc, writeBatch, serverTimestamp, onSnapshot, increment, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEvF1sD56pmtYlbno4QAY_Kr5xeFrTAvU",
            authDomain: "prefect-management-syste-e1575.firebaseapp.com",
            projectId: "prefect-management-syste-e1575",
            storageBucket: "prefect-management-syste-e1575.appspot.com",
            messagingSenderId: "973932803095",
            appId: "1:973932803095:web:a7f2db386cafb53330d852",
            measurementId: "G-FLF7R3B8J3"
        };

        // Fix ReferenceError
        window.currentPrefectGlobal = null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to Global Scope (for legacy scripts)
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.limit = limit;
        window.orderBy = orderBy;
        window.addDoc = addDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.runTransaction = runTransaction;
        window.arrayUnion = arrayUnion;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.writeBatch = writeBatch;
        window.serverTimestamp = serverTimestamp;
        window.onSnapshot = onSnapshot;
        window.increment = increment;
        window.deleteDoc = deleteDoc;
        window.deleteField = deleteField;

        // --- NEW: AUTOMATIC DAILY ABSENCE PROCESSOR ---
        async function checkAndRunDailyAbsence(user) {
            try {
                // 1. Check if User is Admin (Optimization: Don't try if not admin)
                // We'll try to read a protected path or just check if they are in the 'admins' list locally if we had it.
                // For now, we'll rely on the operation succeeding or failing silently. 
                // Better: Check if user ID exists in 'hpfadminformobileapp' or 'web_admins' or 'admins'
                const isAdmin = await verifyAdminStatus(user.uid);
                if (!isAdmin) {
                    console.log("Daily Process: User is not admin. Skipping.");
                    return;
                }

                console.log("Daily Process: Admin detected. Checking status...");

                // 2. Define "Yesterday"
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                // 3. Check System Status
                const statusRef = doc(db, "system", "daily_status");
                const statusSnap = await getDoc(statusRef);

                if (statusSnap.exists() && statusSnap.data()[yesterdayStr] === true) {
                    console.log(`Daily Process: ${yesterdayStr} already processed.`);
                    return;
                }

                console.log(`Daily Process: Processing for ${yesterdayStr}...`);

                // 4. Check Holiday
                // Note: Ideally query collection(db, "holidays") where date == yesterdayStr
                const holidaysQ = query(collection(db, "holidays"), where("date", "==", yesterdayStr));
                const holidaySnap = await getDocs(holidaysQ);

                const dayOfWeek = yesterday.getDay(); // 0=Sun, 6=Sat
                if (!holidaySnap.empty || dayOfWeek === 0 || dayOfWeek === 6) {
                    console.log(`Daily Process: ${yesterdayStr} is Holiday/Weekend. Marking done.`);
                    await updateDoc(statusRef, { [yesterdayStr]: true }); // Mark as skipped/done
                    return;
                }

                // 5. Run Logic: Find Missing Records
                const prefectsSnap = await getDocs(collection(db, "prefects"));
                // Fetch attendance for yesterday
                const attQ = query(collection(db, "attendance"), where("date", "==", yesterdayStr));
                const attSnap = await getDocs(attQ);

                const presentIds = new Set();
                attSnap.forEach(d => presentIds.add(d.data().prefect_id));

                const batch = writeBatch(db);
                let opsCount = 0;

                prefectsSnap.forEach(docSnap => {
                    const pid = docSnap.id;
                    if (!presentIds.has(pid)) {
                        // Found Missing Prefect -> Deduct 5
                        const prefRef = doc(db, "prefects", pid);
                        batch.update(prefRef, { total_points: increment(-5) });

                        const pointsRef = doc(collection(db, "points"));
                        batch.set(pointsRef, {
                            prefect_id: pid,
                            points: -5,
                            reason: `Absent (No Record) Auto-Process (${yesterdayStr})`,
                            date: yesterdayStr,
                            timestamp: serverTimestamp()
                        });

                        // Optional: Create Absent Record
                        // const attRef = doc(collection(db, "attendance"));
                        // batch.set(attRef, { ... });

                        opsCount++;
                    }
                });

                if (opsCount > 0) {
                    await batch.commit();
                    console.log(`Daily Process: Deducted points for ${opsCount} missing prefects.`);
                } else {
                    console.log("Daily Process: Everyone present! (Or no prefects found)");
                }

                // 6. Mark Complete
                // If doc doesn't exist, set it; else update
                if (!statusSnap.exists()) {
                    await setDoc(statusRef, { [yesterdayStr]: true });
                } else {
                    await updateDoc(statusRef, { [yesterdayStr]: true });
                }

                // Show notification to Admin
                alert(`System Alert: Daily penalties for ${yesterdayStr} processed successfully.`);

            } catch (err) {
                console.error("Daily Process Error:", err);
            }
        }

        async function verifyAdminStatus(uid) {
            // Quick check against collections
            // Note: This relies on security rules allowing reads.
            // Simplified check: Just try to read an admin-only path or use the helper from security rules logic if possible?
            // Client-side, we can just check existence in known admin paths.
            try {
                const appAdmin = await getDoc(doc(db, "hpfadminformobileapp", uid));
                if (appAdmin.exists()) return true;

                const webAdmin = await getDoc(doc(db, "web_admins", uid));
                if (webAdmin.exists()) return true;

                const superAdmin = await getDoc(doc(db, "admins", uid));
                if (superAdmin.exists()) return true;

                return false;
            } catch (e) { return false; }
        }

        // Sidebar Navigation Logic
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('show');
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('show');
            });
        }

        // Active Link Highlighting & SPA Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const href = item.getAttribute('href');
                if (!href || !href.startsWith('#')) return;

                // Remove active class from all links
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Hide all sections and show target
                contentSections.forEach(s => {
                    s.style.display = 'none';
                    s.classList.remove('active');
                });

                const targetId = href.substring(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    // Small delay to allow display to apply before opacity transition if we add one
                    setTimeout(() => targetSection.classList.add('active'), 10);
                }

                // Trigger Event Logic
                if (targetId === 'events') {
                    loadMyEvents();
                }

                // Update Header Title
                const pageTitle = document.querySelector('.page-title h2 span');
                const linkText = item.querySelector('span').textContent;
                if (pageTitle) pageTitle.textContent = linkText;

                // On mobile, close sidebar on click
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('show');
                }
            });
        });


        // Quick Actions Logic
        const btnQuickEvent = document.getElementById('btn-quick-event');
        const btnQuickIdea = document.getElementById('btn-quick-idea');
        const btnQuickAbsence = document.getElementById('btn-quick-absence');

        if (btnQuickEvent) {
            btnQuickEvent.addEventListener('click', () => {
                document.querySelector('.nav-item[href="#events"]').click();
            });
        }

        if (btnQuickIdea) {
            btnQuickIdea.addEventListener('click', () => {
                document.querySelector('.nav-item[href="#ideas"]').click();
                setTimeout(() => {
                    const titleInput = document.getElementById('idea-title');
                    if (titleInput) titleInput.focus();
                }, 100);
            });
        }

        if (btnQuickAbsence) {
            btnQuickAbsence.addEventListener('click', () => {
                document.querySelector('.nav-item[href="#attendance"]').click();
            });
        }

        const btnQuickEditProfile = document.getElementById('btn-quick-edit-profile');
        if (btnQuickEditProfile) {
            btnQuickEditProfile.addEventListener('click', () => {
                document.querySelector('.nav-item[href="#profile"]').click();
            });
        }

        // Download Report Logic
        // Download Report Logic
        const btnDownloadReport = document.getElementById('btn-download-report');

        function updateDownloadButtonState() {
            if (!btnDownloadReport) return;

            const now = new Date();
            const currentDay = now.getDate();
            const currentMonth = now.getMonth(); // 0-11
            const currentYear = now.getFullYear();

            // Target Window: 28th 00:01 to 29th 00:01
            // Check if WE ARE CURRENTLY inside the window
            let windowStart = new Date(currentYear, currentMonth, 28, 0, 1, 0);
            let windowEnd = new Date(currentYear, currentMonth, 29, 0, 1, 0);

            // Edge case: boundaries.
            // If today is 28th or 29th, the window vars above are correct for "this month's window".

            // TEMPORARY UNLOCK: Allow download today (User Request)
            // Original: const isInsideWindow = (now >= windowStart && now < windowEnd);
            const isInsideWindow = true; // Forced Unlock

            if (isInsideWindow) {
                // UNLOCKED
                btnDownloadReport.disabled = false;
                btnDownloadReport.classList.remove('disabled-countdown');
                btnDownloadReport.innerHTML = '<i class="fas fa-file-download"></i> Download Monthly Report';
            } else {
                // LOCKED - Calculate Next Unlock
                btnDownloadReport.disabled = true;
                btnDownloadReport.classList.add('disabled-countdown');

                // Determine NEXT start date
                let nextUnlock = new Date(windowStart);
                if (now >= windowEnd) {
                    // Missed this month's window, next is next month
                    nextUnlock.setMonth(nextUnlock.getMonth() + 1);
                } else if (now < windowStart) {
                    // Not yet reached this month's window
                    nextUnlock = windowStart;
                }

                const diff = nextUnlock - now;

                // Format diff
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                btnDownloadReport.innerHTML = `<i class="fas fa-lock"></i> Next Unlock: ${days}d ${hours}h ${minutes}m ${seconds}s`;
            }
        }

        // Initialize
        if (btnDownloadReport) {
            updateDownloadButtonState();
            setInterval(updateDownloadButtonState, 1000); // Live Countdown

            btnDownloadReport.addEventListener('click', async () => {
                // Self-Healing: If global is null, try to fetch it
                if (!window.currentPrefectGlobal) {
                    const user = auth.currentUser;
                    if (user) {
                        try {
                            const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                            const snapshot = await getDocs(q);
                            if (!snapshot.empty) {
                                window.currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            }
                        } catch (e) { console.error("Self-heal error:", e); }
                    }
                }

                if (!window.currentPrefectGlobal) return alert("Please wait for profile to load.");

                const originalText = btnDownloadReport.innerHTML;
                btnDownloadReport.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                btnDownloadReport.disabled = true;

                try {
                    if (typeof window.generateMonthlyReportPDF === 'function') {
                        await window.generateMonthlyReportPDF(window.currentPrefectGlobal);
                    } else {
                        alert("Error: PDF Generation function is missing!");
                    }
                } catch (error) {
                    console.error("PDF Error:", error);
                    alert("Failed to generate PDF: " + error.message);
                } finally {
                    btnDownloadReport.innerHTML = originalText;
                    btnDownloadReport.disabled = false;
                }
            });
        }

        window.generateMonthlyReportPDF = async function (prefect) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // --- 1. DATE RANGE LOGIC (Strictly up to 28th) ---
            const now = new Date();
            const currentDay = now.getDate();

            // Cycle End: ALWAYS the 28th of the current month (or previous month if today < 28)
            let cycleEnd = new Date(now);

            if (currentDay >= 28) {
                // If we are past the 28th (e.g. 30th), report should stop at 28th
                cycleEnd.setDate(28);
            } else {
                // If today is before 28th (e.g. 5th), report is for LAST month's cycle
                cycleEnd.setMonth(cycleEnd.getMonth() - 1);
                cycleEnd.setDate(28);
            }

            // Set time to end of day? No, usually cycle ends at start of day or specific time. 
            // Let's keep existing time logic or just date.


            let cycleStart = new Date(cycleEnd);
            cycleStart.setMonth(cycleStart.getMonth() - 1); // Previous Month

            // Previous Cycle (for comparison)
            let prevCycleEnd = new Date(cycleStart);
            let prevCycleStart = new Date(prevCycleEnd);
            prevCycleStart.setMonth(prevCycleStart.getMonth() - 1);

            const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
            const cycleString = `${cycleStart.toLocaleDateString('en-US', dateOptions)} - ${cycleEnd.toLocaleDateString('en-US', dateOptions)}`;

            // --- 2. DATA FETCHING ---

            // Helper: Fetch Attendance in Range
            const getAttendanceInPeriod = async (start, end) => {
                const sStr = start.toISOString().split('T')[0];
                const eStr = end.toISOString().split('T')[0];
                // Optimization: Fetch all for user and filter in JS to avoid Composite Index errors
                const q = query(collection(db, "attendance"),
                    where("prefect_id", "==", prefect.id)
                );
                const snapshot = await getDocs(q);
                return snapshot.docs.map(d => d.data()).filter(d => {
                    let dStr = d.date;
                    if (d.date && typeof d.date === 'object' && d.date.seconds) {
                        dStr = new Date(d.date.seconds * 1000).toISOString().split('T')[0];
                    }
                    return dStr >= sStr && dStr <= eStr;
                });
            };


            const currentAttendance = await getAttendanceInPeriod(cycleStart, cycleEnd);
            const prevAttendance = await getAttendanceInPeriod(prevCycleStart, prevCycleEnd);

            // Sort (Newest First)
            currentAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Calc Growth
            const countPresent = list => list.filter(r => (r.status || '').toLowerCase().match(/present|late/)).length;
            const currCount = countPresent(currentAttendance);
            const prevCount = countPresent(prevAttendance);

            let growthText = "Stable";
            let growthColor = [100, 100, 100];
            const diff = currCount - prevCount;
            if (diff > 0) { growthText = `Increase (+${diff})`; growthColor = [22, 101, 52]; } // Green
            if (diff < 0) { growthText = `Decrease (${diff})`; growthColor = [185, 28, 28]; } // Red

            // Helper: Points in Range
            const pointsSnap = await getDocs(query(collection(db, "points"), where("prefect_id", "==", prefect.id)));
            let pointsRecords = [];
            pointsSnap.forEach(d => {
                const data = d.data();
                const dDate = new Date(data.date);
                // Flexible parsing if date is string or timestamp
                const pDate = data.date && data.date.seconds ? new Date(data.date.seconds * 1000) : new Date(data.date);

                if (pDate >= cycleStart && pDate <= cycleEnd) {
                    pointsRecords.push(data);
                }
            });
            pointsRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Helper: Duties in Range
            let dutyRecords = [];
            // Optimize: Fetch events in date range, then check usage
            const eventsQ = query(collection(db, "events"),
                where("date", ">=", cycleStart.toISOString().split('T')[0]),
                where("date", "<=", cycleEnd.toISOString().split('T')[0]));

            const eventsSnap = await getDocs(eventsQ);
            for (const evDoc of eventsSnap.docs) {
                const evParams = evDoc.data();
                // Check duties
                const dutiesQ = query(collection(db, "event_duties"),
                    where("eventId", "==", evDoc.id),
                    where("assignedPrefectId", "==", prefect.id));
                const dutySnap = await getDocs(dutiesQ);
                dutySnap.forEach(d => {
                    dutyRecords.push({
                        event: evParams.title,
                        duty: d.data().title,
                        date: evParams.date
                    });
                });
            }


            // --- DESIGN & RENDER ---
            const primaryColor = [114, 14, 14]; // Maroon
            const darkText = [30, 30, 30];
            const lightText = [100, 100, 100];
            const lineColor = [200, 200, 200];

            // 1. Header (Redesigned: Photo Left, Text Center)
            doc.setFontSize(16);
            doc.setTextColor(...primaryColor);
            doc.setFont("helvetica", "bold");

            // CENTERED NAME & DETAILS
            doc.setFontSize(32);
            doc.setTextColor(...darkText);
            doc.text(prefect.name.split(" ")[0], 105, 26, { align: "center" }); // Was 38

            doc.setFont("helvetica", "normal");
            doc.text((prefect.name.split(" ").slice(1).join(" ") || ""), 105, 38, { align: "center" }); // Was 50

            doc.setFontSize(10);
            doc.setTextColor(...primaryColor);
            doc.setFont("helvetica", "bold");
            doc.text((prefect.destiny || "PREFECT").toUpperCase(), 105, 48, { align: "center" }); // Was 60

            doc.setFontSize(9);
            doc.setTextColor(...lightText);
            doc.setFont("helvetica", "normal");
            doc.text(`ID: ${prefect.school_index_number || '-'}`, 105, 58, { align: "center" }); // Was 70

            // Rank Display
            const currentPoints = prefect.total_points || 0;
            let currentRank = "Rookie";
            if (currentPoints >= 120) currentRank = "Platinum";
            else if (currentPoints >= 90) currentRank = "Gold";
            else if (currentPoints >= 80) currentRank = "Silver";
            else if (currentPoints >= 50) currentRank = "Bronze";

            doc.setFont("helvetica", "bold");
            if (currentRank === "Gold") doc.setTextColor(218, 165, 32);
            else if (currentRank === "Silver") doc.setTextColor(169, 169, 169);
            else if (currentRank === "Bronze") doc.setTextColor(205, 127, 50);
            else doc.setTextColor(...lightText);

            doc.text(`Rank: ${currentRank}`, 105, 63, { align: "center" });

            doc.setTextColor(...lightText);
            doc.setFont("helvetica", "normal");
            doc.text(`Period: ${cycleString}`, 105, 68, { align: "center" }); // Was 63 -> 68 due to extra line

            // 2. Profile Picture (Moved to Left)
            const profileImg = document.getElementById('header-profile-img');
            if (profileImg) {
                try {
                    // Create off-screen canvas for circular clipping
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const size = 520; // 52 * 10 for better quality
                    canvas.width = size;
                    canvas.height = size;

                    // Draw circular clip path
                    ctx.beginPath();
                    ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
                    ctx.closePath();
                    ctx.clip();

                    // Draw image centered and scaled to fill circle
                    // First ensure image is loaded properly
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.src = profileImg.src;

                    await new Promise((resolve, reject) => {
                        if (img.complete) resolve();
                        else {
                            img.onload = resolve;
                            img.onerror = () => reject(new Error('Image failed to load'));
                        }
                    });

                    ctx.drawImage(img, 0, 0, size, size);

                    // Convert canvas to image data
                    const circularImg = canvas.toDataURL('image/png');

                    // Add circular image to PDF (Left Aligned: X=15)
                    // New Size: 35mm
                    // Center X = 15 + 17.5 = 32.5
                    // Center Y = 15 + 17.5 = 32.5
                    doc.addImage(circularImg, 'PNG', 15, 15, 35, 35);

                    // Add white border ring
                    doc.setDrawColor(255, 255, 255);
                    doc.setLineWidth(2);
                    doc.circle(32.5, 32.5, 17.5, 'S');
                } catch (e) {
                    console.error("PDF Image Error:", e);
                    // Fallback: draw maroon circle with initials
                    doc.setFillColor(...primaryColor);
                    doc.circle(32.5, 32.5, 17.5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    const initials = prefect.name ? prefect.name.split(' ').map(n => n[0]).join('').substr(0, 2) : '??';
                    doc.text(initials, 32.5, 35, { align: 'center' });
                }
            }

            // 3. Summary
            doc.setFontSize(11);
            doc.setTextColor(...darkText);
            doc.setFont("helvetica", "bold");
            doc.text("SUMMARY", 195, 19, { align: "right" });
            doc.setDrawColor(...primaryColor);
            doc.line(175, 22, 195, 22);

            doc.setFontSize(8);
            doc.setTextColor(...lightText);
            doc.setFont("helvetica", "normal");
            const sumTxt = `Report Period: ${cycleString}. Attendance: ${growthText}. Total Points: ${prefect.total_points}. Duties: ${dutyRecords.length}.`;
            doc.text(doc.splitTextToSize(sumTxt, 50), 195, 29, { align: "right" });

            // --- 4. NEW FEATURE: RANK PROGRESS BAR ---
            const points = prefect.total_points || 0;
            const tiers = [
                { name: "Rookie", min: 0 },
                { name: "Bronze", min: 50 },
                { name: "Silver", min: 80 },
                { name: "Gold", min: 90 },
                { name: "Platinum", min: 120 }
            ];
            let nextTier = tiers.find(t => t.min > points);
            if (!nextTier) nextTier = { name: "Max Rank", min: points }; // Reached top
            let prevTier = tiers[[...tiers].reverse().findIndex(t => t.min <= points)];
            if (!prevTier) prevTier = tiers[0];
            // Fix logic to find correct previous tier strictly
            // Simpler: Just get next tier. % is (points / nextTier.min) * 100

            // Calculate Percentage
            // Simple: 0 to Next Goal
            let progressPercent = 100;
            if (nextTier.min > 0) {
                progressPercent = Math.min((points / nextTier.min) * 100, 100);
            }

            // Draw Bar (Below Summary) Y=40
            doc.setFontSize(7);
            doc.setTextColor(...lightText);
            doc.text(`Next Rank: ${nextTier.name} (${Math.round(progressPercent)}%)`, 195, 38, { align: "right" });

            // Background Bar
            doc.setFillColor(230, 230, 230);
            doc.roundedRect(145, 40, 50, 3, 1, 1, 'F');

            // Progress Fill
            doc.setFillColor(...primaryColor); // Maroon fill
            doc.roundedRect(145, 40, (50 * progressPercent) / 100, 3, 1, 1, 'F');


            // --- SEPARATOR & BODY START (REDUCED HEIGHT) ---
            doc.setDrawColor(230, 230, 230);
            doc.line(10, 75, 200, 75); // Moved UP from 90

            // ================= BODY =================
            let startY = 85;
            const MAX_ITEMS = 12;
            const ROW_HEIGHT = 8;
            // Moved UP from 105

            // --- 2.2 AUTO-DETECT MISSING DAYS (Fix "Samahara dawas adui") ---
            // Create a Set of existing dates for quick lookup
            const existingDates = new Set();
            currentAttendance.forEach(a => {
                const dStr = a.date && a.date.seconds ? new Date(a.date.seconds * 1000).toISOString().split('T')[0] : a.date;
                existingDates.add(dStr);
            });

            // Iterate through the cycle
            let dLoop = new Date(cycleStart);
            while (dLoop <= cycleEnd) {
                // Stop if we reach "tomorrow" (don't mark future as absent)
                if (dLoop > now) break;

                const checkStr = dLoop.toISOString().split('T')[0];
                const dayNum = dLoop.getDay();

                // Skip if already exists
                if (!existingDates.has(checkStr)) {
                    // Check Logic: Skip Weekends (Sat=6, Sun=0) & Holidays
                    // Access cachedHolidays global set if available, else standard weekends
                    const isHoliday = (typeof cachedHolidays !== 'undefined' && cachedHolidays.has(checkStr));
                    const isWeekend = (dayNum === 0 || dayNum === 6);

                    if (!isWeekend && !isHoliday) {
                        // It's a missing school day -> Mark as Auto Absent
                        currentAttendance.push({
                            date: checkStr,
                            status: 'Absent',
                            reason: 'No Record (Auto-Detect)',
                            auto: true
                        });
                        // Add to prev count if we were comparing (complex, let's leave cmp chart as is for now)
                    }
                }
                dLoop.setDate(dLoop.getDate() + 1);
            }

            // Re-Sort (Newest First)
            currentAttendance.sort((a, b) => {
                const dateA = a.date && a.date.seconds ? new Date(a.date.seconds * 1000) : new Date(a.date);
                const dateB = b.date && b.date.seconds ? new Date(b.date.seconds * 1000) : new Date(b.date);
                return dateB - dateA;
            });


            // --- 2.3 RE-CALCULATE COUNTS ---
            // calc counts for summary
            let nPresent = 0, nLate = 0, nAbsent = 0;
            const exceptionList = []; // For the printed list
            currentAttendance.forEach(r => {
                let s = (r.status || '').toString().toLowerCase().trim();

                // Robust Fallback using Points if Status is unclear
                if (!s && r.points_awarded != undefined) {
                    // Use loose equality (==) to handle string "2" vs number 2
                    if (r.points_awarded == 2) s = 'late';
                    else if (r.points_awarded == 4) s = 'present';
                }

                if (!s && r.time_in) s = 'present';

                if (s.includes('present') || s === 'duty') {
                    nPresent++;
                }
                else if (s.includes('late')) {
                    nLate++;
                    exceptionList.push(r);
                }
                else if (s.includes('absent') || s.includes('missing')) {
                    nAbsent++;
                    exceptionList.push(r);
                }
                // If we have a record that is neither present/late/absent, maybe log it?
            });
            const totalRecordedExclHolidays = nPresent + nLate + nAbsent;


            // ================= BODY =================


            // SECTION A: ATTENDANCE SUMMARY (Refined Design)
            doc.setFontSize(12);
            doc.setTextColor(...darkText);
            doc.setFont("helvetica", "bold");
            doc.setFillColor(...primaryColor);
            doc.circle(18, startY - 1, 2, 'F');
            doc.text(`ATTENDANCE OVERVIEW`, 25, startY);

            // Draw Summary Box
            // X: 25, Y: startY+5
            const statsY = startY + 8;

            // Present Count
            doc.setFontSize(10); doc.setTextColor(22, 101, 52); // Green
            doc.text(`Present: ${nPresent}`, 25, statsY);

            // Late Count
            doc.setTextColor(202, 138, 4); // Yellow/Gold
            doc.text(`Late: ${nLate}`, 60, statsY);

            // Absent Count
            doc.setTextColor(185, 28, 28); // Red
            doc.text(`Absent: ${nAbsent}`, 90, statsY);

            // Timeline Line
            doc.setDrawColor(...lineColor);
            doc.setLineWidth(0.5);
            doc.line(20, startY + 10, 20, 205);

            let currentY = startY + 20; // Adjusted for Stats Box

            // LIST: ONLY EXCEPTIONS (Lassanata Summarize Method)
            if (exceptionList.length === 0 && nPresent > 0) {
                doc.setFontSize(10);
                doc.setTextColor(22, 163, 74); // Green
                doc.setFont("helvetica", "bold");
                doc.text(" Perfect Attendance! Excellent!", 28, currentY);
            } else if (totalRecordedExclHolidays === 0) {
                doc.setFontSize(9); doc.setTextColor(...lightText);
                doc.text("No school days recorded in this period.", 28, currentY);
            } else {
                // Render Exceptions
                const renderList = exceptionList.slice(0, 10); // Top 10 bad records
                renderList.forEach(record => {
                    const s = (record.status || '').toLowerCase();
                    let color = darkText;
                    if (s === 'absent') color = [185, 28, 28];
                    if (s === 'late') color = [202, 138, 4];

                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(...primaryColor);
                    doc.circle(20, currentY, 1.5, 'FD');

                    doc.setFontSize(9);
                    doc.setTextColor(...color);
                    doc.setFont("helvetica", "bold");
                    doc.text((record.status || 'N/A').toUpperCase(), 28, currentY + 1);

                    doc.setFontSize(8);
                    doc.setTextColor(...lightText);
                    doc.setFont("helvetica", "normal");

                    const dateObj = record.date && record.date.seconds ? new Date(record.date.seconds * 1000) : new Date(record.date);
                    const dStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' });

                    doc.text(`${dStr} | ${record.reason || '-'}`, 28, currentY + 4);
                    currentY += 10; // More spacing for detail
                });

                if (exceptionList.length > 10) {
                    doc.setFontSize(8); doc.setTextColor(...lightText); doc.setFont("helvetica", "italic");
                    doc.text(`... and ${exceptionList.length - 10} more exceptions.`, 28, currentY);
                }
            }

            // SECTION B: POINTS
            doc.setFontSize(12);
            doc.setTextColor(...darkText);
            doc.setFont("helvetica", "bold");
            doc.setFillColor(...primaryColor);
            doc.circle(118, startY - 1, 2, 'F');
            doc.text("POINTS HISTORY", 125, startY);

            doc.setDrawColor(...lineColor);
            doc.line(120, startY + 10, 120, 205);

            currentY = startY + 15;
            let renderPoints = pointsRecords.slice(0, MAX_ITEMS);
            if (renderPoints.length === 0) {
                doc.setFontSize(9); doc.setTextColor(...lightText);
                doc.text("No points changes.", 128, currentY);
            }
            renderPoints.forEach(record => {
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(1);
                doc.circle(120, currentY, 1.5, 'FD');

                const isPlus = (record.points || 0) > 0;
                doc.setFontSize(9);
                if (isPlus) doc.setTextColor(22, 101, 52);
                else doc.setTextColor(220, 38, 38);
                doc.setFont("helvetica", "bold");
                doc.text(`${isPlus ? '+' : ''}${record.points} Points`, 128, currentY + 1);

                doc.setFontSize(8);
                doc.setTextColor(...lightText);
                doc.setFont("helvetica", "normal");
                doc.text(record.reason || 'Reason Unspecified', 128, currentY + 4);
                currentY += ROW_HEIGHT;
            });

            // Overflow Indicator (Points)
            if (pointsRecords.length > MAX_ITEMS) {
                doc.setFillColor(255, 255, 255);
                doc.circle(120, currentY, 1, 'F');
                doc.setFontSize(8);
                doc.setTextColor(...lightText);
                doc.setFont("helvetica", "italic");
                doc.text(`... and ${pointsRecords.length - MAX_ITEMS} more entries`, 128, currentY + 2);
            }

            // SECTION C: FOOTER (DUTIES + SIGNATURE)
            doc.setFillColor(245, 245, 245);
            doc.rect(0, 215, 210, 82, 'F');

            // --- 5. NEW FEATURE: POINTS GROWTH GRAPH (Moved here to be ON TOP of Footer Background) ---
            try {
                // 1. Prepare Data
                // Calculate starting points for this period
                let cyclePointsChange = 0;
                pointsRecords.forEach(r => cyclePointsChange += (parseInt(r.points) || 0));
                let startPoints = (prefect.total_points || 0) - cyclePointsChange;

                // Create daily data points
                // Map dates to cumulative score
                let graphData = [{ date: cycleStart, score: startPoints }];
                let runningScore = startPoints;

                // Sort records oldest to newest for calculation
                let sortedRecords = [...pointsRecords].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedRecords.forEach(r => {
                    runningScore += (parseInt(r.points) || 0);
                    const d = r.date && r.date.seconds ? new Date(r.date.seconds * 1000) : new Date(r.date);
                    graphData.push({ date: d, score: runningScore });
                });
                // Add today/end
                graphData.push({ date: cycleEnd, score: (prefect.total_points || 0) });

                // 2. Create Canvas
                const chartCanvas = document.createElement('canvas');
                chartCanvas.width = 600;
                chartCanvas.height = 300;
                // document.body.appendChild(chartCanvas); // Debug only

                // 3. Render Chart
                new Chart(chartCanvas, {
                    type: 'line',
                    data: {
                        labels: graphData.map(d => d.date.getDate()), // Just Day numbers
                        datasets: [{
                            label: 'Points',
                            data: graphData.map(d => d.score),
                            borderColor: '#720e0e',
                            backgroundColor: 'rgba(114, 14, 14, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0 // Clean line
                        }]
                    },
                    options: {
                        responsive: false,
                        animation: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: false } // Minimalist sparkline style
                        }
                    }
                });

                // 4. Add to PDF (Bottom Right - Above Signature)
                // Wait for render (sync in Chart.js generally if animation: false?)
                // Actually Chart.js is async-ish. Let's do a small wait or use toBase64Image()

                const graphImg = chartCanvas.toDataURL('image/png');

                // Position: Top-Right of Footer, X=130, Y=225, Width=50, Height=25
                // Signature is at Y=270, so this leaves space
                doc.addImage(graphImg, 'PNG', 130, 225, 50, 25);

                doc.setFontSize(7);
                doc.setTextColor(...lightText);
                doc.text("Points Trend", 155, 255, { align: "center" }); // Centered at 130 + 25

            } catch (e) {
                console.error("Graph Error:", e);
            }

            // C1. COMPARISON CHART (Replaces Duty Log)
            try {
                // 1. Calculate Previous Period Points
                let prevPointsTotal = 0;
                pointsSnap.forEach(d => {
                    const data = d.data();
                    const pDate = data.date && data.date.seconds ? new Date(data.date.seconds * 1000) : new Date(data.date);
                    if (pDate >= prevCycleStart && pDate <= prevCycleEnd) {
                        prevPointsTotal += (parseInt(data.points) || 0);
                    }
                });

                // Calculate Current Period Points
                let currPointsTotal = 0;
                pointsRecords.forEach(r => currPointsTotal += (parseInt(r.points) || 0));

                // 2. Prepare Data for Chart
                // Labels: Attendance, Points
                // Dataset 1 (Prev): [prevCount, prevPointsTotal]
                // Dataset 2 (Curr): [currCount, currPointsTotal]

                const compCanvas = document.createElement('canvas');
                compCanvas.width = 400;
                compCanvas.height = 200;

                new Chart(compCanvas, {
                    type: 'bar',
                    data: {
                        labels: ['Attendance', 'Points'],
                        datasets: [
                            {
                                label: 'Last Month',
                                data: [prevCount, prevPointsTotal],
                                backgroundColor: '#9ca3af', // Gray
                                borderRadius: 4,
                                barPercentage: 0.6,
                                categoryPercentage: 0.8
                            },
                            {
                                label: 'This Month',
                                data: [currCount, currPointsTotal],
                                backgroundColor: '#720e0e', // Maroon
                                borderRadius: 4,
                                barPercentage: 0.6,
                                categoryPercentage: 0.8
                            }
                        ]
                    },
                    options: {
                        responsive: false,
                        animation: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { font: { size: 10 }, boxWidth: 10 }
                            },
                            title: {
                                display: true,
                                text: 'Monthly Performance Growth',
                                font: { size: 14, weight: 'bold' },
                                padding: { bottom: 5 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { display: true, color: '#f3f4f6' },
                                ticks: { font: { size: 9 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10, weight: 'bold' } }
                            }
                        }
                    }
                });

                const compImg = compCanvas.toDataURL('image/png');

                // Add to PDF (Left Side of Footer)
                // Footer Rect starts at Y=215. Height=82.
                // Place at X=10, Y=220, W=80, H=45
                doc.addImage(compImg, 'PNG', 10, 220, 80, 45);

            } catch (cmpErr) {
                console.error("Comparison Chart Error:", cmpErr);
                // Fallback Text if chart fails
                doc.setFontSize(9);
                doc.setTextColor(...darkText);
                doc.text("Performance Comparison Data Unavailable", 15, 240);
            }

            // C2. SIGNATURE (Bottom Right)
            doc.setDrawColor(...darkText);
            doc.setLineWidth(0.5);
            doc.line(130, 270, 190, 270); // Signature Line

            doc.setFontSize(9);
            doc.setTextColor(...darkText);
            doc.setFont("helvetica", "bold");
            doc.text("H.P. Or D.H.P. SIGNATURE", 160, 276, { align: "center" });

            doc.setFontSize(7);
            doc.setTextColor(...lightText);
            doc.setFont("helvetica", "normal");
            doc.text(`Authorized by ${prefect.destiny || 'Prefect Guild'}`, 160, 281, { align: "center" });





            // Old Performance Analytics Section Removed to prevent overlap with new Duty Log & Points Graph
            // Save
            const reportMonth = cycleEnd.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            doc.save(`Monthly_Report_${reportMonth}_${prefect.name}.pdf`);
        };



        // Logout Logic
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error("Logout Error:", error);
                });
            });
        }

        // Auth & Data Loading
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User logged in:", user.uid);

                // Fetch Prefect Profile
                const prefectsRef = collection(db, "prefects");
                const q = query(prefectsRef, where("uid", "==", user.uid));

                try {
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const prefectDoc = querySnapshot.docs[0];
                        const prefectData = prefectDoc.data();
                        const prefectId = prefectDoc.id;

                        // Set Global Var for PDF & other functions
                        window.currentPrefectGlobal = { id: prefectId, ...prefectData };
                        console.log("Global Profile Set:", window.currentPrefectGlobal);

                        // Update UI with Profile Data
                        updateProfileUI(prefectData);

                        // Fetch Stats
                        await fetchKeyStats(prefectId);
                        await fetchRecentPoints(prefectId);
                        await fetchWeeklyAttendanceChart(prefectId);
                        await fetchRecentAttendance(prefectId);
                        await checkForAbsenceReason(prefectId);
                        await fetchBadWork(prefectId);

                        // Load Events & Ideas
                        loadEvents();
                        initializeIdeas();
                        loadAnnouncements();
                        initializeChat(user);
                        try { initializeFutureAbsenceForm(user); } catch (e) { console.error(e); }

                        // --- TRIGGER DAILY PROCESSOR ---
                        checkAndRunDailyAbsence(user);



                    } else {
                        console.log("No prefect profile found for this user.");
                    }
                } catch (error) {
                    console.error("Error fetching data:", error);
                }

            } else {
                console.log("No user logged in, redirecting...");
                // window.location.href = 'login.html'; // Uncomment for production
            }
        });

        function updateProfileUI(data) {
            const defaultImg = "meroon Transparent logo prefect.png";
            const imageUrl = data.picture || defaultImg;
            const name = data.name || "Prefect";
            const role = data.destiny || "Member";
            const points = data.total_points || 0;

            // Update Header Name/Role (Mobile & Desktop)
            // Note: ID was changed to 'user-name' in HTML for badge layout
            const headerName = document.getElementById('user-name') || document.getElementById('header-profile-name');
            const headerRole = document.getElementById('user-role') || document.getElementById('header-profile-role');
            const headerImg = document.getElementById('header-profile-img');

            if (headerName) headerName.textContent = name;
            if (headerRole) headerRole.textContent = role;
            if (headerImg) headerImg.src = imageUrl;

            // --- BADGE SYSTEM LOGIC ---
            const badgeContainer = document.getElementById('badge-container');
            if (badgeContainer) {
                let badgeHTML = '';
                let rankText = 'Rookie Prefect'; // Default

                if (points >= 120) {
                    badgeHTML = `<div class="role-badge badge-platinum" title="Platinum Tier (120+ Points)"><i class="fas fa-gem"></i> PLATINUM</div>`;
                    rankText = " Platinum Prefect";
                } else if (points >= 90) {
                    badgeHTML = `<div class="role-badge badge-gold" title="Gold Tier (90-119 Points)"><i class="fas fa-crown"></i> GOLD</div>`;
                    rankText = " Gold Prefect";
                } else if (points >= 80) {
                    badgeHTML = `<div class="role-badge badge-silver" title="Silver Tier (80-89 Points)"><i class="fas fa-medal"></i> SILVER</div>`;
                    rankText = " Silver Prefect";
                } else if (points >= 50) {
                    badgeHTML = `<div class="role-badge badge-bronze" title="Bronze Tier (50-79 Points)"><i class="fas fa-shield-alt"></i> BRONZE</div>`;
                    rankText = " Bronze Prefect";
                } else {
                    // Rookie
                    rankText = " Rookie Prefect";
                }
                badgeContainer.innerHTML = badgeHTML;

                // Update Hero Rank
                const heroRankEl = document.getElementById('hero-rank-display');
                if (heroRankEl) {
                    heroRankEl.innerHTML = `<strong style="color:var(--primary-600)">${rankText}</strong>  ${points} Points`;
                }
            }

            // Update Welcome Card
            const welcomeName = document.getElementById('welcome-name');
            const welcomeImg = document.getElementById('welcome-profile-img');

            if (welcomeName) welcomeName.textContent = name;
            if (welcomeImg) welcomeImg.src = imageUrl;

            // Update Profile Page Details
            const profilePageName = document.getElementById('profile-page-name');
            const profilePageRole = document.getElementById('profile-page-role-display');
            const profilePageImg = document.getElementById('profile-page-picture');
            const profileId = document.getElementById('profile-prefect-id');

            if (profilePageName) profilePageName.textContent = name;
            if (profilePageRole) profilePageRole.textContent = role;
            if (profilePageImg) profilePageImg.src = imageUrl;
            if (profileId) profileId.textContent = `ID: ${data.school_index_number || '-'}`;

            // Form Fields
            const fieldMap = {
                'profile-email': data.email,
                'profile-phone': data.phone,
                'profile-class-static': data.class,
                'profile-section': data.section,
                'profile-index': data.school_index_number,
                'profile-parents-phone': data.parents_phone,
                'profile-current-duty': data.current_duty,
                'profile-role-input': data.destiny,
                'profile-total-points': data.total_points || 0
            };

            // Check for Birthday
            if (data.dob) {
                checkBirthday(data.dob);
            }

            // Fetch Leaderboard once profile is loaded (to highlight current user)
            fetchLeaderboard();

            for (const [id, value] of Object.entries(fieldMap)) {
                const el = document.getElementById(id);
                if (el) el.value = value || '-';
            }
        }

        // --- SAVE PROFILE LOGIC ---
        // --- SAVE PROFILE LOGIC ---
        window.saveProfileChanges = async function () {
            // Self-Healing: If global is null, try to fetch it
            if (!currentPrefectGlobal) {
                const user = auth.currentUser;
                if (user) {
                    try {
                        const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                        const snapshot = await getDocs(q);
                        if (!snapshot.empty) {
                            currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            console.log("Global Profile Healed:", currentPrefectGlobal);
                        }
                    } catch (e) { console.error("Self-heal error:", e); }
                }
            }

            if (!currentPrefectGlobal) return alert("Profile not loaded. Please refresh the page.");

            const newClass = document.getElementById('profile-class-static').value;
            const newDuty = document.getElementById('profile-current-duty').value;
            const newRole = document.getElementById('profile-role-input').value;

            if (!confirm("Are you sure you want to update your profile?")) return;

            try {
                const prefRef = doc(db, "prefects", currentPrefectGlobal.id);
                await updateDoc(prefRef, {
                    class: newClass,
                    current_duty: newDuty,
                    destiny: newRole
                });

                alert("Profile updated successfully!");
                // Optimistically update the global object and UI
                currentPrefectGlobal.class = newClass;
                currentPrefectGlobal.current_duty = newDuty;
                currentPrefectGlobal.destiny = newRole;
                updateProfileUI(currentPrefectGlobal);

            } catch (e) {
                console.error("Update Error:", e);
                // Show detailed error
                console.log(JSON.stringify(e)); // Debug
                alert(`Failed to update profile.\nCode: ${e.code || 'unknown'}\nMessage: ${e.message}`);
            }
        }

        async function fetchKeyStats(prefectId) {
            // Points - Using real-time listener
            const pointsQuery = query(collection(db, "points"), where("prefect_id", "==", prefectId));
            onSnapshot(pointsQuery, (pointsSnapshot) => {
                let totalPoints = 0;
                pointsSnapshot.forEach(doc => { totalPoints += doc.data().points || 0; });

                const pointsEl = document.getElementById('total-points');
                if (pointsEl) pointsEl.textContent = totalPoints;
            }, (error) => {
                console.error("Error listening to points:", error);
            });

            // Attendance (Absences & Late & Health) - Using real-time listener
            const attendanceQuery = query(collection(db, "attendance"), where("prefect_id", "==", prefectId));
            onSnapshot(attendanceQuery, (attendanceSnapshot) => {
                let totalAbsences = 0;
                let totalLate = 0;
                let totalPresent = 0;

                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    const status = (record.status || '').toLowerCase(); // Case-insensitive comparison

                    if (status === 'absent') totalAbsences++;
                    else if (status === 'late') {
                        totalLate++;
                        totalPresent++; // Late counts as present for health
                    }
                    else if (status === 'present') totalPresent++;
                });

                const absencesEl = document.getElementById('total-absences');
                const lateEl = document.getElementById('total-late');

                if (absencesEl) absencesEl.textContent = totalAbsences;
                if (lateEl) lateEl.textContent = totalLate;

                // --- Calculate Attendance Health ---
                // Formula: (Total Present / Total Recorded Days) * 100
                const totalRecorded = totalPresent + totalAbsences; // Note: totalPresent includes Late
                let healthPercentage = 100; // Default to 100 if no records

                if (totalRecorded > 0) {
                    healthPercentage = Math.round((totalPresent / totalRecorded) * 100);
                }

                const healthValEl = document.getElementById('attendance-health-value');
                const healthBarEl = document.getElementById('attendance-health-bar');

                if (healthValEl) healthValEl.textContent = `${healthPercentage}%`;
                if (healthBarEl) {
                    healthBarEl.style.width = `${healthPercentage}%`;

                    // Dynamic Color
                    if (healthPercentage >= 80) healthBarEl.style.background = '#059669'; // Green
                    else if (healthPercentage >= 50) healthBarEl.style.background = '#d97706'; // Orange
                    else healthBarEl.style.background = '#dc2626'; // Red
                }

            }, (error) => {
                console.error("Error listening to attendance:", error);
            });
        }

        let weeklyChartInstance = null;
        let breakdownChartInstance = null;

        async function fetchWeeklyAttendanceChart(prefectId) {
            // --- 1. Bar Chart: Weekly Attendance ---
            const ctxBar = document.getElementById('attendanceBarChart');
            if (!ctxBar) return;

            try {
                // Fetch last 10 records for better trend
                const attendanceQuery = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), limit(20));

                onSnapshot(attendanceQuery, (querySnapshot) => {
                    if (querySnapshot.empty) return; // Handle empty state visually if needed

                    let attendanceData = [];
                    querySnapshot.forEach(doc => attendanceData.push(doc.data()));

                    // Sort: Oldest to Newest for Chart
                    attendanceData.sort((a, b) => {
                        const dateA = a.date?.seconds ? a.date.seconds : new Date(a.date).getTime() / 1000;
                        const dateB = b.date?.seconds ? b.date.seconds : new Date(b.date).getTime() / 1000;
                        return dateA - dateB;
                    });

                    // Take last 7 for the week view
                    const recentData = attendanceData.slice(-7);

                    const labels = recentData.map(d => formatDate(d.date).split('/')[0] + '/' + formatDate(d.date).split('/')[1]); // DD/MM
                    const statusValues = recentData.map(d => {
                        const s = (d.status || '').toLowerCase();
                        if (s === 'present') return 10; // Visualization height
                        if (s === 'late') return 6;
                        if (s === 'absent') return 10;
                        return 0;
                    });
                    const statusColors = recentData.map(d => {
                        const s = (d.status || '').toLowerCase();
                        if (s === 'present') return '#4caf50';
                        if (s === 'late') return '#fbc02d';
                        if (s === 'absent') return '#d63031';
                        return '#ccc';
                    });

                    // Render Chart.js
                    if (weeklyChartInstance) weeklyChartInstance.destroy();

                    const config = {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Attendance Status',
                                data: statusValues,
                                backgroundColor: statusColors,
                                borderRadius: 8,
                                barThickness: 25,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const val = context.raw;
                                            if (val === 10) return 'Present';
                                            if (val === 6) return 'Late';
                                            if (val === 2) return 'Absent';
                                            return 'Unknown';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    display: false,
                                    max: 12
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { family: "'Plus Jakarta Sans', sans-serif" } }
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeOutQuart'
                            }
                        }
                    };

                    weeklyChartInstance = new Chart(ctxBar, config);

                    // --- 2. Doughnut Chart: Overall Breakdown ---
                    // Calculate totals from ALL fetched data (up to 20 or more if we queried more)
                    // For better stats, we might want to query more or use the existing aggregates from fetchKeyStats

                    // Let's use the local `attendanceData` (last 20) as a sample
                    let p = 0, l = 0, a = 0;
                    attendanceData.forEach(d => {
                        const s = (d.status || '').toLowerCase();
                        if (s === 'present') p++;
                        else if (s === 'late') l++;
                        else if (s === 'absent') a++;
                    });

                    renderBreakdownChart(p, l, a);

                }, (error) => {
                    console.error("Chart Error:", error);
                });

            } catch (error) {
                console.error("Chart Init Error:", error);
            }
        }

        function renderBreakdownChart(present, late, absent) {
            const ctxDoughnut = document.getElementById('attendanceDoughnutChart');
            if (!ctxDoughnut) return;

            if (breakdownChartInstance) breakdownChartInstance.destroy();

            // Handle empty data case
            if (present === 0 && late === 0 && absent === 0) {
                // Maybe show a grey placeholder?
                present = 1; // Dummy
            }

            breakdownChartInstance = new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Late', 'Absent'],
                    datasets: [{
                        data: [present, late, absent],
                        backgroundColor: [
                            '#4caf50', // Present
                            '#fbc02d', // Late
                            '#d63031'  // Absent
                        ],
                        hoverOffset: 10,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    family: "'Plus Jakarta Sans', sans-serif",
                                    size: 12
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        async function fetchRecentPoints(prefectId) {
            const recentPointsChart = document.getElementById('recent-points-chart');
            if (!recentPointsChart) return;

            try {
                // Removed orderBy to prevent index error
                const q = query(collection(db, "points"), where("prefect_id", "==", prefectId), limit(20));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    recentPointsChart.innerHTML = '<p style="color:var(--gray-500); font-size:0.9rem;">No data available</p>';
                    return;
                }

                let pointsData = [];
                querySnapshot.forEach(doc => {
                    pointsData.push(doc.data());
                });

                // Client-side sort (date desc)
                pointsData.sort((a, b) => {
                    const dateA = a.date?.seconds || 0;
                    const dateB = b.date?.seconds || 0;
                    return dateB - dateA;
                });
                // Take top 5
                pointsData = pointsData.slice(0, 5);

                const maxPoints = Math.max(...pointsData.map(p => p.points || 0));
                let chartHtml = '';

                pointsData.reverse().forEach((point) => {
                    const barHeight = maxPoints > 0 ? ((point.points || 0) / maxPoints) * 100 : 0;
                    chartHtml += `<div class="bar" style="height: ${barHeight}%;" data-label="${formatDate(point.date)}" data-value="${point.points || 0}"></div>`;
                });

                if (recentPointsChart) recentPointsChart.innerHTML = chartHtml;

                // --- NEW: Populate Points History List (Points Section) ---
                const pointsList = document.getElementById('recent-points-list');
                if (pointsList) {
                    let listHtml = '<ul class="stats-list" style="list-style:none; padding:0;">';
                    // Reuse pointsData (sorted desc)
                    pointsData.reverse(); // It was reversed for chart (asc), reverse back for list (desc)
                    // Actually pointsData was sliced top 5. We might want ALL fetched (20).
                    // Let's use the original `querySnapshot` for the list to show more info.

                    let allPoints = [];
                    querySnapshot.forEach(doc => allPoints.push(doc.data()));
                    allPoints.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

                    if (allPoints.length === 0) {
                        pointsList.innerHTML = '<p class="text-muted">No points recorded.</p>';
                    } else {
                        allPoints.forEach(point => {
                            listHtml += `<li style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem 0; border-bottom:1px solid var(--gray-100);">
                                <div>
                                    <div style="font-weight:600; color:var(--gray-800);">${point.reason || 'Points Awarded'}</div>
                                    <div style="font-size:0.85rem; color:var(--gray-500);">${formatDate(point.date)}</div>
                                </div>
                                <div style="font-weight:700; color:${(point.points || 0) > 0 ? 'green' : 'red'}; background:${(point.points || 0) > 0 ? '#e8f5e9' : '#ffebee'}; padding:4px 10px; border-radius:12px;">
                                    ${(point.points || 0) > 0 ? '+' : ''}${point.points || 0}
                                </div>
                            </li>`;
                        });
                        listHtml += '</ul>';
                        pointsList.innerHTML = listHtml;
                    }
                }

            } catch (error) {
                console.error("Error fetching points:", error);
                if (recentPointsChart) recentPointsChart.innerHTML = '<p style="color:red; font-size:0.8rem;">Error loading points.</p>';
                const pointsList = document.getElementById('recent-points-list');
                if (pointsList) pointsList.innerHTML = `<p class='text-error'>Error: ${error.message}</p>`;
            }
        }

        function formatDate(date) {
            if (!date) return '-';
            if (date.seconds) return new Date(date.seconds * 1000).toLocaleDateString();
            const d = new Date(date);
            return isNaN(d.getTime()) ? '-' : d.toLocaleDateString();
        }

        /* --- HOLIDAY MANAGEMENT --- */
        let cachedHolidays = new Set(); // Stores "YYYY-MM-DD" strings
        let holidaysLoaded = false;

        async function loadHolidays() {
            if (holidaysLoaded) return; // Already loaded in this session

            try {
                const q = query(collection(db, "holidays"));
                const snapshot = await getDocs(q);
                cachedHolidays.clear();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.date) {
                        cachedHolidays.add(data.date); // Add "YYYY-MM-DD" to Set
                        console.log("Loaded holiday:", data.date, "-", data.title || "");
                    }
                });

                holidaysLoaded = true;
                console.log(` Loaded ${cachedHolidays.size} holidays`);
            } catch (e) {
                console.error("Error loading holidays:", e);
                // Continue even if holidays fail to load
            }
        }

        /* --- UPDATED: FETCH RECENT ATTENDANCE WITH MISSING DAYS --- */
        async function fetchRecentAttendance(prefectId) {
            const attendanceList = document.getElementById('recent-attendance-list');
            if (!attendanceList) return;

            try {
                // 0. Load holidays first (cached after first load)
                await loadHolidays();

                // 1. Database    Records   (Present & Absent with Reason)
                const q = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), limit(30));
                const querySnapshot = await getDocs(q);

                let realRecords = [];
                // Database records   (Dates)   Set    check 
                const existingDates = new Set();

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    realRecords.push(data);

                    // Date Format  YYYY-MM-DD   
                    let dateStr = "";
                    if (data.date && data.date.seconds) {
                        dateStr = new Date(data.date.seconds * 1000).toISOString().split('T')[0];
                    } else if (typeof data.date === 'string') {
                        dateStr = data.date;
                    }
                    if (dateStr) existingDates.add(dateStr);
                });

                // 2.   14       (Auto-detect Missing Absences)
                let missingRecords = [];
                const today = new Date();

                //  14   
                for (let i = 0; i < 14; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);

                    //   (Saturday=6, Sunday=0)  
                    const dayNum = d.getDay();
                    if (dayNum === 0 || dayNum === 6) continue;

                    const checkDateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD

                    //  NEW: Holidays   (School  )
                    if (cachedHolidays.has(checkDateStr)) {
                        console.log(` Skipping holiday: ${checkDateStr}`);
                        continue;
                    }

                    //       record  ,  Absent  
                    // (     ,      i=1   )
                    if (!existingDates.has(checkDateStr)) {

                        //     ,     "Missing"    (Optional Logic)
                        //    Absent      if   .
                        if (i === 0) continue;

                        missingRecords.push({
                            date: checkDateStr,
                            status: 'Absent',
                            time_in: null,
                            reason: 'No reason submitted (Auto)',
                            is_missing: true //    
                        });
                    }
                }

                // 3. Real Records  Missing Records  
                let allRecords = [...realRecords, ...missingRecords];

                //     (Newest First)
                allRecords.sort((a, b) => {
                    const dateA = a.date && a.date.seconds ? new Date(a.date.seconds * 1000) : new Date(a.date);
                    const dateB = b.date && b.date.seconds ? new Date(b.date.seconds * 1000) : new Date(b.date);
                    return dateB - dateA;
                });

                if (allRecords.length === 0) {
                    attendanceList.innerHTML = '<p class="text-muted">No recent attendance records.</p>';
                    return;
                }

                // 4. UI  Render  (SUPIRI DESIGN UPDATE)
                let html = '<div class="attendance-list-container" style="display: flex; flex-direction: column; gap: 12px;">';

                allRecords.forEach(record => {
                    const statusLower = (record.status || '').toLowerCase();
                    let statusColor = '#64748b'; // Default Gray
                    let statusIcon = 'fa-circle-question';
                    let statusLabel = 'UNKNOWN';
                    let pointsBadge = '';
                    let detailsHtml = '';

                    // 1. Determine Status & Base Styles
                    if (record.is_missing) {
                        statusColor = '#ef4444'; // Red
                        statusIcon = 'fa-circle-xmark';
                        statusLabel = 'ABSENT (MISSING)';
                        pointsBadge = '<span class="badge" style="background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">-8 Pts</span>';
                        detailsHtml = `<div style="color: #ef4444; font-size: 0.9rem;"><i class="fa-solid fa-triangle-exclamation"></i> Not Recorded</div>`;
                    }
                    else if (statusLower === 'present') {
                        statusColor = '#22c55e'; // Green
                        statusIcon = 'fa-circle-check';
                        statusLabel = 'PRESENT';
                        pointsBadge = '<span class="badge" style="background:#dcfce7; color:#15803d; border:1px solid #bbf7d0; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">+4 Pts</span>';
                        detailsHtml = `<div style="color: #334155; font-size: 0.9rem;"><i class="fa-regular fa-clock"></i> In: <strong>${record.time_in || 'N/A'}</strong></div>`;
                    }
                    else if (statusLower === 'late') {
                        statusColor = '#eab308'; // Yellow/Orange
                        statusIcon = 'fa-clock';
                        statusLabel = 'LATE';
                        pointsBadge = '<span class="badge" style="background:#fef9c3; color:#a16207; border:1px solid #fde047; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">+2 Pts</span>';
                        detailsHtml = `<div style="color: #334155; font-size: 0.9rem;"><i class="fa-regular fa-clock"></i> In: <strong>${record.time_in || 'N/A'}</strong></div>`;
                    }
                    else if (statusLower === 'absent') {
                        // Check if excused (points_awarded logic or reason)
                        const isExcused = (record.points_awarded === -5) || (record.reason && record.reason.toLowerCase().includes('excused'));

                        if (isExcused) {
                            statusColor = '#f59e0b'; // Amber
                            statusIcon = 'fa-file-circle-check'; // Excused icon
                            statusLabel = 'EXCUSED';
                            pointsBadge = '<span class="badge" style="background:#fef3c7; color:#b45309; border:1px solid #fcd34d; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">-5 Pts</span>';
                        } else {
                            statusColor = '#ef4444'; // Red
                            statusIcon = 'fa-circle-xmark';
                            statusLabel = 'ABSENT';
                            pointsBadge = '<span class="badge" style="background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">-8 Pts</span>';
                        }
                        detailsHtml = `<div style="color: #64748b; font-size: 0.9rem; font-style: italic;">${record.reason || 'No reason provided'}</div>`;
                    }

                    // Check for Issues (Additional deductions)
                    if (record.issues && Array.isArray(record.issues) && record.issues.length > 0) {
                        const issueCount = record.issues.length;
                        const deduction = issueCount * 1.5;
                        pointsBadge += ` <span class="badge" style="background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; margin-left: 4px; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">-${deduction} Issues</span>`;
                        detailsHtml += `<div style="color: #dc2626; font-size: 0.85rem; margin-top: 4px;"><i class="fa-solid fa-triangle-exclamation"></i> ${record.issues.join(', ')}</div>`;
                    }

                    // Date Formatting
                    const dateObj = record.date && record.date.seconds ? new Date(record.date.seconds * 1000) : new Date(record.date);
                    const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                    const dayNum = dateObj.getDate();
                    const monthName = dateObj.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();

                    // HTML Card Component
                    html += `
                    <div style="
                        display: flex; 
                        align-items: center; 
                        background: white; 
                        border-radius: 12px; 
                        padding: 12px 16px; 
                        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
                        border-left: 5px solid ${statusColor};
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        
                        <!-- DATE BOX -->
                        <div style="
                            display: flex; 
                            flex-direction: column; 
                            align-items: center; 
                            justify-content: center; 
                            min-width: 50px; 
                            margin-right: 16px; 
                            color: #64748b;
                        ">
                            <span style="font-size: 0.75rem; font-weight: 700;">${monthName}</span>
                            <span style="font-size: 1.5rem; font-weight: 800; line-height: 1; color: #334155;">${dayNum}</span>
                            <span style="font-size: 0.7rem; font-weight: 600;">${dayName}</span>
                        </div>

                        <!-- CONTENT -->
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; flex-wrap: wrap; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-solid ${statusIcon}" style="color: ${statusColor}; font-size: 1.1rem;"></i>
                                    <span style="font-weight: 700; color: ${statusColor}; font-size: 1rem;">${statusLabel}</span>
                                </div>
                                <div style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end;">
                                    ${pointsBadge}
                                </div>
                            </div>
                            ${detailsHtml}
                        </div>
                    </div>`;
                });

                html += '</div>';
                attendanceList.innerHTML = html;

            } catch (e) {
                console.error("Error fetching attendance:", e);
                attendanceList.innerHTML = '<p class="text-error">Error loading records.</p>';
            }
        }

        async function checkForAbsenceReason(prefectId) {
            const absentReasonContainer = document.getElementById('absent-reason-container');
            if (!absentReasonContainer) return;

            // Get Today's Date
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            const currentMonthPrefix = `${year}-${month}`;

            const q = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), where("date", "==", todayString), limit(1));

            try {
                const querySnapshot = await getDocs(q);
                let status = 'none'; // 'none', 'present', 'absent'
                let recordData = {};

                if (!querySnapshot.empty) {
                    recordData = querySnapshot.docs[0].data();
                    status = (recordData.status || '').toLowerCase();
                }

                // Determine UI State
                let isDisabled = false; // Will set to true if not active
                let cardColor = '#fff';
                let borderColor = '#ccc';
                let titleColor = '#333';
                let titleText = 'Absence Reporting';
                let messageText = `If you are absent today (<strong>${todayString}</strong>), please report it here.`;
                let icon = 'fas fa-info-circle';

                // Warning Message Placeholder
                let warningMessageHtml = `<div id="today-absence-warning" style="margin-bottom:10px; color:#e67e22; font-size:0.9rem; font-weight:600; display:block;">
                    <i class="fas fa-satellite-dish fa-spin"></i> Checking school availability...
                </div>`;


                if (status === 'present' || status === 'late') {
                    // Present/Late -> DISABLE FORM
                    isDisabled = true;
                    cardColor = '#f0fff4'; // Greenish
                    borderColor = '#00b894';
                    titleColor = '#2d3436';
                    titleText = status === 'late' ? 'Marked Present (Late)' : 'Marked Present';
                    messageText = `You have successfully checked in at <strong>${recordData.time_in || 'Unknown'}</strong>.`;
                    icon = 'fas fa-check-circle';
                    warningMessageHtml = '';

                    // HERO STATUS UPDATE: CHECKED IN
                    const heroStatusEl = document.getElementById('hero-status-display');
                    if (heroStatusEl) {
                        heroStatusEl.innerHTML = `
                            <div class="status-badge" style="background:#dcfce7; color:#166534; border: 1px solid #bbf7d0;">
                                <i class="fas fa-check-circle"></i> Checked In
                            </div>
                            <div style="font-size:0.8rem; color:#166534; margin-top:4px;">In at ${recordData.time_in || 'Unknown'}</div>
                        `;
                    }

                } else if (status === 'absent') {
                    // Marked Absent -> DISABLE FORM
                    isDisabled = true;
                    cardColor = '#fff0f0'; // Reddish
                    borderColor = '#d63031';
                    titleColor = '#d63031';
                    titleText = 'Marked Absent';
                    const existingReason = recordData.reason || 'No reason provided';
                    messageText = `You have reported absence. Reason: <strong>${existingReason}</strong>.`;
                    icon = 'fas fa-user-times';
                    warningMessageHtml = '';

                    // HERO STATUS UPDATE: ABSENT
                    const heroStatusEl = document.getElementById('hero-status-display');
                    if (heroStatusEl) {
                        heroStatusEl.innerHTML = `
                            <div class="status-badge" style="background:#fee2e2; color:#991b1b; border: 1px solid #fecaca;">
                                <i class="fas fa-times-circle"></i> Absent
                            </div>
                            <div style="font-size:0.8rem; color:#991b1b; margin-top:4px;">${existingReason}</div>
                        `;
                    }

                } else {
                    // No Record (None) -> Treat as potential absence
                    // DEFAULT TO DISABLED UNTIL CHECKED
                    isDisabled = true;
                    cardColor = '#ffffff'; // White/Neutral
                    borderColor = '#ffa726'; // Orange warning
                    titleColor = '#ef6c00';
                    titleText = 'Not Checked In';
                    messageText = `You have not scanned in for today (<strong>${todayString}</strong>). If you are absent, please submit a reason.`;
                    icon = 'fas fa-exclamation-triangle';

                    // HERO STATUS UPDATE: NOT SCANNED
                    const heroStatusEl = document.getElementById('hero-status-display');
                    if (heroStatusEl) {
                        heroStatusEl.innerHTML = `
                            <div class="status-badge" style="background:#ffedd5; color:#9a3412; border: 1px solid #fed7aa;">
                                <i class="fas fa-clock"></i> Not Scanned
                            </div>
                            <div style="font-size:0.8rem; color:#9a3412; margin-top:4px;">Mark attendance now</div>
                        `;
                    }
                }

                // Render ALWAYS
                absentReasonContainer.innerHTML = `
                    <div class="dashboard-card" style="border-left: 4px solid ${borderColor}; padding: 1.5rem; background: ${cardColor}; margin-bottom: 2rem; transition: all 0.3s ease;">
                        <h3 style="color: ${titleColor}; margin-top:0; font-size: 1.1rem;"><i class="${icon}"></i> ${titleText}</h3>
                        <p style="margin-bottom: 1rem; color: #444; font-size: 0.95rem;">${messageText}</p>
                        
                        ${warningMessageHtml}

                        <form id="today-absence-form" style="opacity: ${isDisabled && status === 'none' ? '0.6' : (isDisabled ? '0.6' : '1')}; pointer-events: ${isDisabled && status === 'none' ? 'none' : (isDisabled ? 'none' : 'all')};">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <select id="today-absence-reason-select" style="flex: 1; padding: 0.6rem; border-radius: 8px; border: 1px solid #ccc; background: white;" ${isDisabled ? 'disabled' : 'required'}>
                                        <option value="" disabled selected>Select Reason for Absence</option>
                                        <option value="Sick">Sick / Medical (3 Days Max/Month)</option>
                                        <option value="Family Emergency">Family Emergency</option>
                                        <option value="Exam / Tuition">Exam / Tuition</option>
                                        <option value="Transport Issue">Transport Issue</option>
                                        <option value="Official Duty">Official Duty</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <button type="submit" id="today-absence-submit-btn" style="background: ${isDisabled ? '#999' : '#d63031'}; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600;" ${isDisabled ? 'disabled' : ''}>
                                        <i class="fas fa-save"></i> ${status === 'absent' ? 'Submitted' : 'Mark Absent'}
                                    </button>
                                </div>
                                <input type="text" id="today-absence-reason-other" placeholder="Please specify reason..." style="display:none; width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #ccc;" ${isDisabled ? 'disabled' : ''}>
                                
                                <div id="medical-upload-container" style="display:none; background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px dashed #ffa726;">
                                    <label style="display:block; font-size: 0.85rem; color: #d35400; margin-bottom: 5px; font-weight:600;"> Medical Slip Required (Mandatory)</label>
                                    <div style="font-size: 0.8rem; color: #555; margin-bottom: 5px;">Upload a clear photo. AI will scan this document for verification.</div>
                                    <input type="file" id="medical-file-input" accept="image/*" style="font-size: 0.9rem;">
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- FAKE SCANNING MODAL -->
                    <div id="ai-scan-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
                        <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; width: 300px; box-shadow: 0 4px 15px rgba(0,255,100,0.2);">
                            <div id="scan-animation">
                                <i class="fas fa-microchip fa-3x" style="color: #0984e3; animation: pulse 1.5s infinite;"></i>
                            </div>
                            <h3 id="scan-title" style="margin: 15px 0 10px; color: #2d3436;">AI Processing</h3>
                            <p id="scan-status" style="color:#636e72; font-size: 0.9rem;">Analyzing document structure...</p>
                            <div style="width: 100%; background: #dfe6e9; height: 6px; border-radius: 3px; margin-top: 15px; overflow: hidden;">
                                <div id="scan-progress" style="width: 0%; height: 100%; background: #00b894; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Add CSS for pulse if not exists
                if (!document.getElementById('pulse-anim-style')) {
                    const style = document.createElement('style');
                    style.id = 'pulse-anim-style';
                    style.innerHTML = `@keyframes pulse { 0% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.6; transform: scale(1); } }`;
                    document.head.appendChild(style);
                }

                // Event Listeners
                const reasonSelect = document.getElementById('today-absence-reason-select');
                const reasonOther = document.getElementById('today-absence-reason-other');
                const medicalContainer = document.getElementById('medical-upload-container');
                const medicalInput = document.getElementById('medical-file-input');
                const form = document.getElementById('today-absence-form');
                const scanModal = document.getElementById('ai-scan-modal');
                const scanTitle = document.getElementById('scan-title');
                const scanStatus = document.getElementById('scan-status');
                const scanProgress = document.getElementById('scan-progress');
                const scanAnim = document.getElementById('scan-animation');

                if (reasonSelect) {
                    reasonSelect.addEventListener('change', () => {
                        // Toggle Other Input
                        if (reasonSelect.value === 'Other') {
                            reasonOther.style.display = 'block';
                            reasonOther.required = true;
                        } else {
                            reasonOther.style.display = 'none';
                            reasonOther.required = false;
                        }

                        // Toggle Medical Input for "Sick"
                        if (reasonSelect.value === 'Sick') {
                            medicalContainer.style.display = 'block';
                            // Note: We don't verify file existence here, we do it on submit
                        } else {
                            medicalContainer.style.display = 'none';
                            medicalInput.value = ''; // Clear selection
                        }
                    });
                }

                // --- SMART SCHOOL DAY CHECK ---
                async function checkStatus() {
                    const today = new Date();
                    const y = today.getFullYear();
                    const m = String(today.getMonth() + 1).padStart(2, '0');
                    const d = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${y}-${m}-${d}`;

                    // If present/absent already, skip check
                    if (status !== 'none') return;

                    const reasonSelectElement = document.getElementById('today-absence-reason-select');
                    const submitBtn = document.getElementById('today-absence-submit-btn');
                    const formElement = document.getElementById('today-absence-form');
                    const warningMsg = document.getElementById('today-absence-warning');

                    try {
                        const statusSnap = await getDoc(doc(db, "daily_status", todayStr));
                        const isDayActive = statusSnap.exists() && statusSnap.data().active;

                        if (!isDayActive) {
                            if (warningMsg) {
                                warningMsg.innerHTML = " Today has not been activated via the Mobile App scanner. <br>Absence marking is disabled for non-school days.";
                                warningMsg.style.color = "#d63031";
                            }
                        } else {
                            if (reasonSelectElement) reasonSelectElement.disabled = false;
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.style.background = '#d63031';
                            }
                            if (formElement) {
                                formElement.style.opacity = '1';
                                formElement.style.pointerEvents = 'all';
                            }
                            if (warningMsg) warningMsg.style.display = "none";
                        }
                    } catch (e) {
                        console.error("Status Check Failed", e);
                        if (warningMsg) warningMsg.innerText = " Status check failed. Please refresh.";
                    }
                }

                checkStatus();

                async function submitAbsence(reason, deductPoints, isVerified = false) {
                    const btn = document.getElementById('today-absence-submit-btn');
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                    try {
                        // Use Batch for Atomic Writes
                        const batch = writeBatch(db);

                        if (status === 'none') {
                            const userDoc = await getDoc(doc(db, "prefects", prefectId));
                            const prefectName = userDoc.exists() ? userDoc.data().name || "Unknown" : "Unknown";

                            // 1. Attendance Record
                            const attRef = doc(collection(db, "attendance"));
                            const attData = {
                                prefect_id: prefectId,
                                uid: auth.currentUser.uid,
                                name: prefectName,
                                date: todayString,
                                time_in: null,
                                time_out: null,
                                status: "Absent",
                                reason: reason,
                                created_at: serverTimestamp(),
                                medical_verification_status: reason === 'Sick' ? (isVerified ? 'verified_by_ai' : 'pending') : 'none'
                            };
                            batch.set(attRef, attData);

                            // 2. Deduct Points
                            const prefectRef = doc(db, "prefects", prefectId);
                            batch.update(prefectRef, {
                                total_points: increment(-deductPoints)
                            });

                            // 3. Log History
                            const pointsRef = doc(collection(db, "points"));
                            batch.set(pointsRef, {
                                prefect_id: prefectId,
                                points: -deductPoints,
                                reason: reason === 'Sick' ? `Sick Leave (Verified)` : `Daily Absence: ${reason}`,
                                date: todayString,
                                timestamp: serverTimestamp()
                            });

                            await batch.commit();

                        } else if (status === 'absent') {
                            // Update existing reason (No point deduction change logic for now)
                            const docId = querySnapshot.docs[0].id;
                            await updateDoc(doc(db, "attendance", docId), {
                                reason: reason,
                                medical_verification_status: (reason === 'Sick' && isVerified) ? 'verified_by_ai' : 'none'
                            });
                        }

                        openModal({
                            title: 'Success',
                            message: `Status reported. ${deductPoints} Points deducted (Synced).`,
                            type: 'success',
                            onConfirm: async () => {
                                await checkForAbsenceReason(prefectId);
                                await fetchRecentAttendance(prefectId);
                                fetchKeyStats(prefectId);
                            }
                        });


                    } catch (err) {
                        console.error("Submission Error:", err);
                        openModal({ title: 'Error', message: err.message, type: 'error' });
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                }

                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const btn = document.getElementById('today-absence-submit-btn');
                        if (btn.disabled) return;

                        let reason = reasonSelect.value;
                        if (reason === 'Other') reason = reasonOther.value.trim();

                        // --- SICK LEAVE FLOW (FAKE AI) ---
                        if (reason === 'Sick') {
                            // 1. Limit Check
                            try {
                                const qSick = query(collection(db, "attendance"), where("prefect_id", "==", prefectId), where("reason", "==", "Sick"));
                                const snapSick = await getDocs(qSick);
                                let monthSickCount = 0;
                                snapSick.forEach(d => {
                                    if (d.data().date && d.data().date.startsWith(currentMonthPrefix)) {
                                        monthSickCount++;
                                    }
                                });
                                if (monthSickCount >= 3) return alert(`Limit reached! You have already taken ${monthSickCount} sick leaves this month.`);
                            } catch (e) { return alert("Error checking limits."); }

                            // 2. Verify Upload
                            if (medicalInput.files.length === 0) return alert(" Please upload a medical slip to proceed.");

                            // 3. Fake Scan Animation
                            scanModal.style.display = "flex";

                            // Step 1: Analyzing
                            scanTitle.innerText = "Smart Scan Initiated";
                            scanStatus.innerText = "Analyzing document text hierarchy...";
                            scanProgress.style.width = "20%";

                            setTimeout(() => {
                                // Step 2: Date Verification
                                scanStatus.innerText = "Verifying dates and signatures...";
                                scanProgress.style.width = "60%";
                                scanAnim.innerHTML = '<i class="fas fa-search fa-3x" style="color: #6c5ce7; animation: pulse 1s infinite;"></i>';

                                setTimeout(() => {
                                    // Step 3: Success
                                    scanStatus.innerText = "Medical slip verified successfully.";
                                    scanProgress.style.width = "100%";
                                    scanAnim.innerHTML = '<i class="fas fa-check-circle fa-4x" style="color: #00b894;"></i>';
                                    scanTitle.innerText = "Verification Complete";
                                    scanTitle.style.color = "#00b894";

                                    setTimeout(() => {
                                        // Close and Submit
                                        scanModal.style.display = "none";
                                        submitAbsence('Sick', 3, true); // Deduct 3
                                    }, 2000);

                                }, 5000);
                            }, 4000);
                            return; // Stop default flow
                        }

                        // --- OTHER FLOW (Standard) ---
                        openModal({
                            title: 'Confirm Submission',
                            message: 'Are you sure you want to report this absence? 5 Points will be deducted.',
                            type: 'confirm',
                            confirmText: 'Yes, Report',
                            onConfirm: async () => {
                                submitAbsence(reason, 5, false); // Deduct 5
                            }
                        });
                    });
                }

            } catch (error) {
                console.error("Error checking absence status:", error);
                absentReasonContainer.innerHTML = '<p style="color:red">Error loading status.</p>';
            }
        }

        /* --- PERFORMANCE LOGIC --- */
        async function fetchBadWork(prefectId) {
            const badWorkList = document.getElementById('bad-work-list');
            if (!badWorkList) return;

            try {
                // Removed orderBy
                const q = query(collection(db, "bad_work"), where("prefect_id", "==", prefectId), limit(20));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    badWorkList.innerHTML = '<p class="text-muted">No performance issues recorded. Keep it up!</p>';
                    return;
                }

                let records = [];
                querySnapshot.forEach(doc => records.push(doc.data()));

                // Client sort
                records.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

                let html = '<ul class="stats-list" style="list-style:none; padding:0;">';
                records.forEach(record => {
                    html += `<li style="padding:0.5rem 0; border-bottom:1px solid var(--gray-100);">
                        <div style="font-weight:600; color:#d63031;">${formatDate(record.date)}</div>
                        <div style="color:var(--gray-700);">${record.description}</div>
                    </li>`;
                });
                html += '</ul>';
                badWorkList.innerHTML = html;
            } catch (error) {
                console.error("Error fetching bad work:", error);
                badWorkList.innerHTML = '<p class="text-error">Error loading records.</p>';
            }
        }

        /* --- EVENTS LOGIC --- */
        function loadEvents() {
            const eventsListDiv = document.getElementById('events-list');
            const eventsQuery = query(collection(db, 'events'), orderBy("date", "desc"), limit(10));
            onSnapshot(eventsQuery, (snapshot) => {
                const list = document.getElementById('events-list');
                if (!list) return;

                list.innerHTML = snapshot.empty ? '<p style="padding:1rem;">No events scheduled.</p>' : '';
                snapshot.forEach(eventDoc => {
                    const event = { id: eventDoc.id, ...eventDoc.data() };
                    list.appendChild(createEventCard(event));
                });
            }, (error) => {
                console.error("Error loading events:", error);
                const list = document.getElementById('events-list');
                if (list) list.innerHTML = '<p style="padding:1rem; color:red;">Error loading events.</p>';
            });
        }

        function createEventCard(event) {
            const card = document.createElement('div');
            card.className = 'dashboard-card'; // Use existing card class or custom
            card.style.marginBottom = '1rem';
            card.style.borderLeft = '4px solid var(--primary-color)';
            card.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                        <h3 style="margin:0; font-size:1.1rem;">${event.title}</h3>
                        <span style="font-size:0.85rem; color:var(--gray-500);">${formatDate(event.date)}</span>
                    </div>
                    <p style="color:var(--gray-600); font-size:0.95rem; margin-bottom:1rem;">${event.description || 'No description.'}</p>
                    <button onclick="toggleDuties('${event.id}')" style="background: var(--primary-100); color: var(--primary-700); border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight:500; font-size:0.9rem;">
                        <i class="fas fa-tasks"></i> View Duties
                    </button>
                    <ul id="duties-for-${event.id}" style="display: none; margin-top: 1rem; padding-left: 1rem; border-top:1px solid var(--gray-200); padding-top:1rem;"></ul>
                </div>`;
            return card;
        }

        window.toggleDuties = function (eventId) {
            const dutiesList = document.getElementById(`duties-for-${eventId}`);
            if (dutiesList.style.display === 'none') {
                dutiesList.style.display = 'block';
                if (dutiesList.innerHTML === '') {
                    dutiesList.innerHTML = '<li style="color:var(--gray-500);">Loading duties...</li>';
                    loadDutiesForEvent(eventId);
                }
            } else {
                dutiesList.style.display = 'none';
            }
        };

        function loadDutiesForEvent(eventId) {
            const dutiesList = document.getElementById(`duties-for-${eventId}`);
            const dutiesQuery = query(collection(db, 'event_duties'), where('eventId', '==', eventId));
            onSnapshot(dutiesQuery, (snapshot) => {
                dutiesList.innerHTML = snapshot.empty ? "<li style='color:var(--gray-500);'>No duties listed.</li>" : '';
                snapshot.forEach(dutyDoc => {
                    const duty = { id: dutyDoc.id, ...dutyDoc.data() };
                    dutiesList.appendChild(createDutyItem(duty));
                });
            });
        }

        function createDutyItem(duty) {
            const item = document.createElement('li');
            item.style.marginBottom = '0.5rem';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';

            const isTaken = !!duty.assignedPrefectName;

            item.innerHTML = `
                <span style="font-weight:500;">${duty.title}</span>
                <div>
                    ${isTaken ? `<span style="font-size:0.85rem; background:#e8f5e9; color:#2e7d32; padding:2px 8px; border-radius:4px;">Taken by: ${duty.assignedPrefectName}</span>`
                    : `<button class="take-duty-btn" style="background:var(--primary-600); color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem;">Take Duty</button>`}
                </div>`;

            if (!isTaken) {
                item.querySelector('.take-duty-btn').addEventListener('click', () => takeDuty(duty.id));
            }
            return item;
        }

        async function takeDuty(dutyId) {
            const user = auth.currentUser;
            if (!user) return alert("Please login first.");

            // We need currentPrefect data. It should be fetched in global scope or cached.
            // For now, let's fetch it again or assume we can get it from DOM or a global var.
            // In dashboard.html there was a global 'currentPrefect'. I should add that to onAuthStateChanged.

            // Simplification: Fetch prefect ID from DOM (hidden input or similar) or re-query.
            // Better: define currentPrefect globally.

            // Quick fix: query prefects by uid
            const prefectsRef = collection(db, "prefects");
            const q = query(prefectsRef, where("uid", "==", user.uid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return alert("Prefect profile not found.");
            const prefectData = snapshot.docs[0].data();
            const prefectId = snapshot.docs[0].id;

            const dutyRef = doc(db, 'event_duties', dutyId);
            try {
                const dutySnap = await getDoc(dutyRef);
                if (dutySnap.exists() && dutySnap.data().assignedPrefectId) {
                    return alert("Sorry, this duty was just taken!");
                }
                await updateDoc(dutyRef, {
                    assignedPrefectId: prefectId,
                    assignedPrefectName: prefectData.name
                });
                alert("Duty assigned to you successfully!");
            } catch (error) {
                console.error("Error taking duty: ", error);
                alert(`Error: ${error.message}`);
            }
        }

        /* --- IDEAS LOGIC --- */

        function initializeIdeas() {
            setupForm();
            // loadMyIdeas(); // Disabled to match dashboard.html and avoid permission errors
            loadPublicIdeas();
        }

        function setupForm() {
            const form = document.getElementById('idea-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                // Ensure we have prefect data
                if (!currentPrefectGlobal) {
                    const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) {
                        currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    } else {
                        return alert("Profile error.");
                    }
                }

                const submitBtn = document.getElementById('idea-submit-btn');
                const messageEl = document.getElementById('submit-message');
                submitBtn.disabled = true;
                messageEl.textContent = 'Submitting...';

                try {
                    await addDoc(collection(db, 'ideas_proposals'), {
                        prefectId: currentPrefectGlobal.id,
                        prefectName: currentPrefectGlobal.name,
                        title: document.getElementById('idea-title').value,
                        description: document.getElementById('idea-description').value,
                        status: 'Pending_Approval',
                        timestamp: serverTimestamp(),
                        upvotes: 0,
                        upvotedBy: []
                    });
                    form.reset();
                    messageEl.textContent = 'Submitted successfully!';
                    messageEl.style.color = 'green';
                } catch (error) {
                    messageEl.textContent = `Error: ${error.message}`;
                    messageEl.style.color = 'red';
                }
                submitBtn.disabled = false;
                setTimeout(() => messageEl.textContent = '', 4000);
            });
        }

        function loadMyIdeas() {
            const user = auth.currentUser;
            if (!user) return;
            // Need prefectID. Let's wait or retry if global not set? 
            // Better: call this after global is set in onAuthStateChanged

            // For now, assume global IS set because we call this inside onAuth
            setTimeout(async () => {
                if (!currentPrefectGlobal) {
                    const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                }

                if (!currentPrefectGlobal) {
                    console.error("CurrentPrefectGlobal is missing inside timeout!");
                    return;
                }
                console.log("Loading ideas for Prefect ID:", currentPrefectGlobal.id);

                const myList = document.getElementById('my-ideas-list');
                // Strict match with ideas.html: orderBy timestamp desc, NO LIMIT
                const q = query(collection(db, 'ideas_proposals'), where('prefectId', '==', currentPrefectGlobal.id), orderBy('timestamp', 'desc'));

                onSnapshot(q, (snapshot) => {
                    if (!myList) return;
                    if (snapshot.empty) {
                        myList.innerHTML = "<p class='text-muted'>You haven't submitted any ideas yet.</p>";
                    } else {
                        myList.innerHTML = '';
                        // No need for client-side sort if query has orderBy, but kept for safety or remove? 
                        // ideas.html relies on query sort.
                        snapshot.forEach(doc => myList.appendChild(renderIdea({ ...doc.data(), id: doc.id }, false, doc.id)));
                    }
                }, (error) => {
                    console.error("Error loading my ideas:", error);
                    if (myList) myList.innerHTML = `<p class='text-error'>Error: ${error.message} (PrefectID: ${currentPrefectGlobal.id})</p>`;
                });
            }, 1000); // Slight delay to ensure auth
        }

        function loadPublicIdeas() {
            const publicList = document.getElementById('public-ideas-list');
            // Removed orderBy. STATUS MUST MATCH ALLOWED VALUES IN SECURITY RULES (likely 'Pending' not 'Pending_Approval')
            const q = query(collection(db, 'ideas_proposals'), where('status', 'in', ['Pending', 'Approved', 'Completed']), limit(20));
            onSnapshot(q, (snapshot) => {
                if (!publicList) return;
                if (snapshot.empty) {
                    publicList.innerHTML = "<p class='text-muted'>No public proposals.</p>";
                } else {
                    publicList.innerHTML = '';
                    let docs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    // Client-side sort: desc
                    docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                    docs.forEach(data => publicList.appendChild(renderIdea(data, true, data.id)));
                }
            }, (error) => {
                console.error("Error loading public ideas:", error);
                if (publicList) publicList.innerHTML = "<p class='text-error'>Error loading public proposals.</p>";
            });
        }


        function renderIdea(idea, isPublic, docId) {
            const item = document.createElement('div');
            item.className = 'idea-item';
            item.style.padding = '1rem';
            item.style.borderBottom = '1px solid var(--gray-200)';

            const normalizedStatus = idea.status.replace('_', ' ');
            let statusColor = 'var(--gray-600)';
            if (idea.status.includes('Approved')) statusColor = 'green';
            if (idea.status.includes('Pending')) statusColor = 'orange';

            const dateString = idea.timestamp ? new Date(idea.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';

            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <h4 style="margin:0; font-size:1rem;">${idea.title}</h4>
                    <span style="font-size:0.75rem; background:${statusColor === 'green' ? '#e8f5e9' : '#fff3e0'}; color:${statusColor}; padding:2px 8px; border-radius:12px;">${normalizedStatus}</span>
                </div>
                <p style="font-size:0.8rem; color:var(--gray-500); margin:0.25rem 0;">By ${idea.prefectName} on ${dateString}</p>
                <p style="font-size:0.9rem; color:var(--gray-700); margin-top:0.5rem;">${idea.description}</p>
                ${isPublic ? `
                <div style="margin-top:0.75rem; display:flex; gap:1rem; align-items:center;">
                    <button class="upvote-btn" data-id="${docId}">
                        <i class="fas fa-thumbs-up"></i> Upvote
                    </button>
                    <span style="font-size:0.85rem; color:var(--gray-600);">${idea.upvotes || 0} Upvotes</span>
                </div>` : ''}`;

            if (isPublic) {
                const upvoteBtn = item.querySelector('.upvote-btn');
                if (currentPrefectGlobal && idea.upvotedBy && idea.upvotedBy.includes(currentPrefectGlobal.id)) {
                    upvoteBtn.classList.add('active-upvote');
                    upvoteBtn.disabled = true;
                    upvoteBtn.innerHTML = '<i class="fas fa-heart"></i> Upvoted';
                }
                if (!upvoteBtn.disabled) {
                    upvoteBtn.addEventListener('click', () => handleUpvote(docId));
                }
            }
            return item;
        }

        async function handleUpvote(docId) {
            if (!currentPrefectGlobal) return alert("Login error");
            const ideaRef = doc(db, "ideas_proposals", docId);
            try {
                await runTransaction(db, async (transaction) => {
                    const ideaDoc = await transaction.get(ideaRef);
                    if (!ideaDoc.exists()) throw "Document does not exist!";
                    const data = ideaDoc.data();
                    const upvotedBy = data.upvotedBy || [];
                    if (upvotedBy.includes(currentPrefectGlobal.id)) return;
                    transaction.update(ideaRef, {
                        upvotes: (data.upvotes || 0) + 1,
                        upvotedBy: arrayUnion(currentPrefectGlobal.id)
                    });
                });
            } catch (e) {
                console.error("Upvote failed: ", e);
            }
        }


        // --- NOTIFICATION & ANNOUNCEMENT LOGIC ---
        let allAnnouncementsGlobal = [];

        function loadAnnouncements() {
            const notificationsList = document.getElementById('notifications-list');
            const dropdownList = document.getElementById('notification-dropdown-list');
            const badgeCount = document.getElementById('notification-badge-count');

            try {
                const q = query(collection(db, "announcements"), orderBy("timestamp", "desc"), limit(20));
                onSnapshot(q, (snapshot) => {
                    allAnnouncementsGlobal = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Update badge count
                    if (badgeCount) badgeCount.textContent = allAnnouncementsGlobal.length;

                    // Populate Sidebar List
                    if (notificationsList) {
                        if (snapshot.empty) {
                            notificationsList.innerHTML = '<p style="padding: 1rem; color:var(--gray-500);">No announcements found.</p>';
                        } else {
                            notificationsList.innerHTML = '';
                            allAnnouncementsGlobal.forEach(ann => {
                                const item = document.createElement('div');
                                item.className = 'notification-item';
                                // Simplified render for sidebar
                                item.innerHTML = `
                                    <strong>${ann.title}</strong>
                                    <p style="font-size:0.85rem; color:var(--gray-600); margin-top:0.25rem;">${ann.content}</p>
                                    <small style="color:var(--gray-400); font-size:0.7rem;">${ann.timestamp ? new Date(ann.timestamp.seconds * 1000).toLocaleDateString() : ''}</small>
                                `;
                                notificationsList.appendChild(item);
                            });
                        }
                    }

                    // Populate Header Dropdown
                    if (dropdownList) {
                        dropdownList.innerHTML = '';
                        if (snapshot.empty) {
                            dropdownList.innerHTML = '<div style="padding:1rem; text-align:center; color:var(--gray-500);">No notifications</div>';
                        } else {
                            allAnnouncementsGlobal.slice(0, 5).forEach(ann => {
                                const item = document.createElement('div');
                                item.className = 'notification-item';
                                item.innerHTML = `
                                    <h5 style="margin:0; font-size:0.9rem;">${ann.title}</h5>
                                    <p style="margin:0; font-size:0.8rem; color:var(--gray-500); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${ann.content}</p>
                                `;
                                dropdownList.appendChild(item);
                            });
                        }
                    }
                }, (error) => {
                    console.error("Error loading announcements snapshot:", error);
                    // Handle missing index or permission errors gracefully
                    if (notificationsList) notificationsList.innerHTML = '<p style="padding:1rem; color:red;">Error loading content. Check permissions/indexes.</p>';
                });
            } catch (e) {
                console.error("Error initializing announcements query:", e);
            }
        }

        // Header Notification Toggle
        const headerNotificationBtn = document.getElementById('header-notification-btn');
        const notificationDropdownPanel = document.getElementById('notification-dropdown-panel');
        if (headerNotificationBtn && notificationDropdownPanel) {
            headerNotificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationDropdownPanel.classList.toggle('active');
            });
            document.addEventListener('click', (e) => {
                if (!notificationDropdownPanel.contains(e.target) && !headerNotificationBtn.contains(e.target)) {
                    notificationDropdownPanel.classList.remove('active');
                }
            });
        }

        // --- CHAT LOGIC ---
        const chatFab = document.getElementById('chatFab');
        const chatContainer = document.getElementById('chatContainer');
        const chatClose = document.getElementById('chatClose');
        const chatSend = document.getElementById('chatSend');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');
        let isChatOpen = false;
        let chatUnsubscribe = null;

        function initializeChat(user) {
            chatFab.addEventListener('click', () => {
                isChatOpen = !isChatOpen;
                chatContainer.classList.toggle('active');
                if (isChatOpen) {
                    listenForMessages(user.uid);
                }
            });
            chatClose.addEventListener('click', () => {
                isChatOpen = false;
                chatContainer.classList.remove('active');
            });
            chatSend.addEventListener('click', () => sendMessage(user));
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(user); });
        }

        function listenForMessages(uid) {
            if (chatUnsubscribe) chatUnsubscribe();

            try {
                const messagesRef = collection(db, 'chats', uid, 'messages');
                const q = query(messagesRef, orderBy('timestamp'), limit(50));

                chatUnsubscribe = onSnapshot(q, (snapshot) => {
                    chatMessages.innerHTML = '';
                    if (snapshot.empty) chatMessages.innerHTML = '<div class="message bot-message">Hello! How can we help you today?</div>';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const div = document.createElement('div');
                        div.className = `message ${msg.senderId === uid ? 'user-message' : 'bot-message'}`;
                        div.textContent = msg.text;
                        chatMessages.appendChild(div);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, (error) => {
                    console.error("Chat Listener Error:", error);
                    chatMessages.innerHTML = '<p class="text-error" style="text-align:center; padding:1rem;">Error loading chat history.</p>';
                });
            } catch (e) {
                console.error("Error setting up chat listener:", e);
            }
        }

        async function sendMessage(user) {
            const text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = '';

            try {
                // Ensure chat doc exists
                await setDoc(doc(db, 'chats', user.uid), {
                    userEmail: user.email,
                    lastUpdate: serverTimestamp()
                }, { merge: true });

                await addDoc(collection(db, 'chats', user.uid, 'messages'), {
                    text: text,
                    senderId: user.uid,
                    timestamp: serverTimestamp(),
                    read: false
                });
            } catch (e) {
                console.error("Chat Send Error", e);
                alert("Failed to send message: " + e.message);
            }
        }

        // --- FUTURE ABSENCE LOGIC ---
        function initializeFutureAbsenceForm(user) {
            const form = document.getElementById('future-absence-form');
            const dateInput = document.getElementById('future-absence-date');
            const select = document.getElementById('replacement-prefect-select');
            const message = document.getElementById('future-absence-message');

            if (!select) {
                console.warn("Replacement select element not found!");
                return;
            }

            // Fill Prefects with error handling
            getDocs(collection(db, 'prefects')).then(snap => {
                select.innerHTML = '<option value="">Select Replacement</option>';
                if (snap.empty) {
                    const opt = document.createElement('option');
                    opt.textContent = "No other prefects found";
                    opt.disabled = true;
                    select.appendChild(opt);
                    return;
                }
                snap.forEach(doc => {
                    const d = doc.data();
                    if (doc.id !== user.uid) { // Exclude self
                        const opt = document.createElement('option');
                        opt.value = doc.id;
                        opt.textContent = d.name || d.email || "Unknown Prefect";
                        opt.dataset.name = d.name || d.email || "Unknown";
                        select.appendChild(opt);
                    }
                });
            }).catch(err => {
                console.error("Error fetching prefects:", err);
                select.innerHTML = '<option value="">Error loading list</option>';
            });

            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentPrefectGlobal) {
                        const user = auth.currentUser;
                        if (!user) return alert("Please log in first.");

                        // Autoself-heal: Fetch profile
                        try {
                            const q = query(collection(db, "prefects"), where("uid", "==", user.uid));
                            const snapshot = await getDocs(q);
                            if (!snapshot.empty) {
                                currentPrefectGlobal = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            } else {
                                return alert("Profile could not be verified. Please refresh page.");
                            }
                        } catch (e) {
                            console.error(e);
                            return alert("Connection error. Please try again.");
                        }
                    }

                    const btn = document.getElementById('future-absence-submit-btn');
                    btn.disabled = true;
                    btn.textContent = "Submitting...";

                    try {
                        const selectedOption = select.options[select.selectedIndex];
                        if (!selectedOption || !selectedOption.value) throw new Error("Please select a replacement prefect.");

                        const replacementName = selectedOption.dataset.name;

                        await addDoc(collection(db, 'future_absences'), {
                            prefect_id: currentPrefectGlobal.id,
                            prefect_name: currentPrefectGlobal.name,
                            absence_date: dateInput.value,
                            replacement_prefect_id: select.value,
                            replacement_prefect_name: replacementName,
                            reason: document.getElementById('future-absence-reason').value,
                            status: 'pending',
                            timestamp: serverTimestamp()
                        });
                        message.textContent = "Request submitted successfully!";
                        message.style.color = "green";
                        form.reset();
                    } catch (err) {
                        console.error("Absence Request Error:", err);
                        message.textContent = "Error: " + err.message;
                        message.style.color = "red";
                    }
                    btn.disabled = false;
                    btn.textContent = "Submit Request";
                });
            }
        }



        // --- FEATURE: GENERATE SERVICE LETTER (CV) ---
        window.generateServiceLetterPDF = async function () {
            const currentPrefect = currentPrefectGlobal; // Use global var
            if (!currentPrefect) {
                alert("Profile data not loaded yet.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Colors
            const maroon = [140, 28, 19];
            const gold = [212, 175, 55];
            const darkText = [30, 41, 59];
            const lightText = [100, 116, 139];

            // --- DECORATIVE HEADER ---
            // Top Bar
            doc.setFillColor(...maroon);
            doc.rect(0, 0, 210, 45, 'F');

            // Gold Accent
            doc.setDrawColor(...gold);
            doc.setLineWidth(1.5);
            doc.line(0, 43, 210, 43);

            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("EHELIYAGODA CENTRAL COLLEGE", 105, 22, { align: "center" });

            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.setCharSpace(2);
            doc.text("PREFECTS' GUILD | OFFICIAL SERVICE RECORD", 105, 32, { align: "center" });

            // --- PROFILE SECTION ---
            doc.setTextColor(...darkText);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text((currentPrefect.name || "Prefect").toUpperCase(), 20, 65);

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(...lightText);
            doc.text(`Role: ${currentPrefect.destiny || "Member"}`, 20, 72);
            doc.text(`Index: ${currentPrefect.school_index_number || "-"}`, 20, 78);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 84);

            // --- STATS HIGHLIGHTS (Right Side) ---
            const points = document.getElementById('total-points') ? document.getElementById('total-points').textContent : "0";
            const absences = document.getElementById('total-absences') ? document.getElementById('total-absences').textContent : "0";

            // Box 1: Points
            doc.setFillColor(255, 248, 240); // Light Gold bg
            doc.setDrawColor(...gold);
            doc.roundedRect(120, 55, 35, 30, 3, 3, 'FD');
            doc.setFontSize(9);
            doc.text("TOTAL POINTS", 137.5, 63, { align: "center" });
            doc.setFontSize(18);
            doc.setTextColor(...maroon);
            doc.setFont("helvetica", "bold");
            doc.text(points, 137.5, 76, { align: "center" });

            // Box 2: Absences
            doc.setFillColor(241, 245, 249); // Light Gray bg
            doc.setDrawColor(200, 200, 200);
            doc.roundedRect(160, 55, 35, 30, 3, 3, 'FD');
            doc.setFontSize(9);
            doc.setTextColor(...lightText);
            doc.text("ABSENCES", 177.5, 63, { align: "center" });
            doc.setFontSize(18);
            doc.setTextColor(220, 38, 38); // Red
            doc.text(absences, 177.5, 76, { align: "center" });

            // --- CERTIFICATION TEXT ---
            doc.setTextColor(...darkText);
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            const today = new Date().toLocaleDateString();

            const bodyText = `This document certifies the service record of ${currentPrefect.name}, a member of the Prefects' Guild at Eheliyagoda Central College.
        
Throughout their tenure, they have demonstrated commitment to school discipline and leadership. The statistics above reflect their active participation and conduct derived from the digital management system (ECCPMS).

This record is generated automatically and serves as a proof of their standing within the guild as of ${today}.`;

            const splitText = doc.splitTextToSize(bodyText, 170);
            doc.text(splitText, 20, 110);

            // --- FOOTER ---
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text("Generated by ECCPMS - Prefect Management System", 105, 280, { align: "center" });

            doc.save(`Service_Letter_${currentPrefect.name.replace(/\s+/g, '_')}.pdf`);
        }

        // --- FEATURE: GENERATE WARNING RECORD ---
        window.generateWarningPDF = async function () {
            const currentPrefect = currentPrefectGlobal;
            if (!currentPrefect) {
                alert("Profile data not loaded yet.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Colors
            const dangerColor = [220, 53, 69]; // Red
            const darkText = [50, 50, 50];

            // --- HEADER ---
            doc.setFillColor(...dangerColor);
            doc.rect(0, 0, 210, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("DISCIPLINARY RECORD SHEET", 105, 25, { align: "center" });

            // --- INFO ---
            doc.setTextColor(...darkText);
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");

            doc.text(`Prefect: ${currentPrefect.name}`, 20, 55);
            doc.text(`Date Issued: ${new Date().toLocaleDateString()}`, 20, 63);

            // Fetch Bad Work Items

            const badWorkRef = collection(db, "bad_work");
            const q = query(badWorkRef, where("prefect_id", "==", currentPrefect.id));

            try {
                const querySnapshot = await getDocs(q);
                const badWorks = [];
                querySnapshot.forEach((doc) => {
                    badWorks.push(doc.data());
                });

                // Sort by date
                badWorks.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (badWorks.length === 0) {
                    doc.setTextColor(40, 167, 69); // Green
                    doc.setFontSize(14);
                    doc.text("No disciplinary issues recorded. Good conduct!", 105, 80, { align: 'center' });
                } else {
                    // Table
                    const tableData = badWorks.map(item => [
                        item.date,
                        item.description || "Unspecified Issue"
                    ]);

                    doc.autoTable({
                        startY: 75,
                        head: [['Date', 'Infraction Description']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: dangerColor },
                    });

                    const finalY = doc.lastAutoTable.finalY + 20;
                    doc.setFontSize(10);
                    doc.setTextColor(...dangerColor);
                    doc.text("Note: This document lists all recorded 'bad work' entries.", 20, finalY);
                }

                doc.save(`Warning_Record_${currentPrefect.name.replace(/\s+/g, '_')}.pdf`);

            } catch (error) {
                console.error("Error fetching warnings", error);
                alert("Could not fetch warning data. See console.");
            }
        }

        // --- 1. LEADERBOARD LOGIC ---
        window.fetchLeaderboard = async function () {
            const leaderboardList = document.getElementById('leaderboard-list');
            if (!leaderboardList) return;

            try {
                // Query Top 5 by Points
                const q = query(collection(db, "prefects"), orderBy("total_points", "desc"), limit(5));
                const querySnapshot = await getDocs(q);

                leaderboardList.innerHTML = "";
                let rank = 1;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const isMe = currentPrefectGlobal && currentPrefectGlobal.id === doc.id;
                    const color = rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : rank === 3 ? '#CD7F32' : '#333';
                    const bg = isMe ? 'background: #fff8e1; border: 1px solid #ffecb3;' : 'background: #f8f9fa;';

                    const item = `
                        <div style="display: flex; align-items: center; padding: 0.5rem; border-radius: 8px; ${bg}">
                            <div style="width: 25px; font-weight: bold; color: ${color}; font-size: 1.1rem;">#${rank}</div>
                            <img src="${data.picture || 'https://ui-avatars.com/api/?name=' + data.name}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin: 0 10px;">
                            <div style="flex: 1; font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${data.name}</div>
                            <div style="font-weight: bold; color: var(--primary-600); font-size: 0.9rem;">${data.total_points || 0}</div>
                        </div>
                    `;
                    leaderboardList.innerHTML += item;
                    rank++;
                });
            } catch (e) {
                console.error("Leaderboard Error:", e);
                leaderboardList.innerHTML = "<small style='color:red;'>Failed to load leaders.</small>";
            }
        }

        // Call this when dashboard loads (e.g., inside onAuthStateChanged or after profile load)
        // ideally call it once auth is ready
        setTimeout(fetchLeaderboard, 2000);

        // --- 2. DIGITAL ID LOGIC ---
        window.openDigitalID = function () {
            if (!currentPrefectGlobal) return;
            const currentPrefect = currentPrefectGlobal;

            document.getElementById('id-card-name').textContent = currentPrefect.name;
            document.getElementById('id-card-role').textContent = currentPrefect.destiny || "Member";
            document.getElementById('id-card-photo').src = currentPrefect.picture || "meroon Transparent logo prefect.png";
            document.getElementById('id-card-id').textContent = currentPrefect.prefect_unique_id || "-";
            document.getElementById('id-card-index').textContent = currentPrefect.school_index_number || "-";

            // Generate QR Code
            const qrData = `${currentPrefect.name}|${currentPrefect.prefect_unique_id}|Active`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
            document.getElementById('id-card-qr').src = qrUrl;

            document.getElementById('digital-id-modal').style.display = 'flex';
        }

        // --- 3. BIRTHDAY LOGIC ---
        window.checkBirthday = function (dobString) {
            if (!dobString) return;
            const today = new Date();
            const dob = new Date(dobString);
            if (today.getMonth() === dob.getMonth() && today.getDate() === dob.getDate()) {
                document.getElementById('birthday-overlay').style.display = 'flex';
            }
        }

    </script>

    <button class="chat-fab" id="chatFab">
        <i class="fas fa-comments"></i>
        <div id="chat-notification-badge" class="badge"
            style="display: none; position:absolute; top:0; right:0; background:red;">!</div>
    </button>

    </div>

    <!-- CHAT CONTAINER (Restored) -->
    <div id="chatContainer">
        <div class="chat-header">
            <h3>Prefect Support</h3>
            <button id="chatClose"
                style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i
                    class="fas fa-times"></i></button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">Hello! This is an AI assistant connected to ECCPMS. How can I help you
                today?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button id="chatSend"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- DIGITAL ID MODAL -->
    <div id="digital-id-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
        <div style="position:relative;">
            <button onclick="document.getElementById('digital-id-modal').style.display='none'"
                style="position:absolute; top:-10px; right:-10px; background:white; border-radius:50%; width:30px; height:30px; border:none; font-weight:bold; cursor:pointer; z-index:3;">&times;</button>
            <div class="digital-id-card">
                <div class="id-header">
                    <div style="font-size: 10px; letter-spacing: 2px;">EHELIYAGODA CENTRAL COLLEGE</div>
                    <div style="font-weight: bold; margin-top: 5px;">PREFECTS' GUILD</div>
                    <div style="height: 20px;"></div> <!-- Spacer -->
                </div>
                <img id="id-card-photo" src="" class="id-photo">
                <div class="id-body">
                    <div class="id-name" id="id-card-name">Student Name</div>
                    <div class="id-role" id="id-card-role">Prefect</div>
                    <div class="id-details">
                        ID: <span id="id-card-id">0000</span><br>
                        INDEX: <span id="id-card-index">0000</span>
                    </div>
                    <hr style="border:0; border-top:1px dashed #ccc; margin: 10px 0;">
                    <img id="id-card-qr" src="" class="id-qr">
                </div>
                <div class="id-footer">OFFICIAL IDENTITY CARD</div>
            </div>
        </div>
    </div>

    <!-- BIRTHDAY OVERLAY -->
    <div id="birthday-overlay">
        <canvas id="confetti-canvas"
            style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
        <div class="bday-content">
            <h1 style="color: #8C1C13; font-size: 3rem; margin-bottom: 10px;"> Happy Birthday! </h1>
            <p style="font-size: 1.2rem; color: #555;">Wishing you a fantastic day filled with joy!</p>
            <img src="meroon Transparent logo prefect.png" style="height: 100px; margin: 20px auto; display:block;">
            <button class="supiri-btn" onclick="document.getElementById('birthday-overlay').style.display='none'">Thank
                You!</button>
        </div>
    </div>

    <!-- Scirpts End -->
    <!-- PREMIUM MODAL SYSTEM -->
    <div id="premium-modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; justify-content: center; align-items: center; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s ease;">
        <div id="premium-modal-card"
            style="background: white; width: 90%; max-width: 400px; border-radius: 24px; padding: 2rem; box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; position: relative; overflow: hidden;">
            <div id="modal-accent-bar"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, #8C1C13, #D4AF37);">
            </div>

            <div id="modal-icon-container"
                style="width: 70px; height: 70px; margin: 0 auto 1.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                <!-- Icon injected by JS -->
            </div>

            <h3 id="modal-title"
                style="margin: 0 0 0.5rem; font-family: 'Outfit', sans-serif; font-size: 1.5rem; color: #333;">Title
            </h3>
            <p id="modal-message" style="margin: 0 0 2rem; color: #666; line-height: 1.5;">Message goes here.</p>

            <div id="modal-actions" style="display: flex; gap: 1rem; justify-content: center;">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>




    <!-- ADMIN TRIGGER BUTTONS (Hidden) -->

    <script>
        /* --- PREMIUM MODAL LOGIC --- */
        const modalOverlay = document.getElementById('premium-modal-overlay');
        const modalCard = document.getElementById('premium-modal-card');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalIconContainer = document.getElementById('modal-icon-container');
        const modalActions = document.getElementById('modal-actions');

        function openModal({ title, message, type = 'info', onConfirm, onCancel, confirmText = 'OK', cancelText = 'Cancel' }) {
            // Setup Content
            modalTitle.innerText = title;
            modalMessage.innerHTML = message; // Allow HTML

            // Setup Icon & Colors
            let iconClass = '';
            let iconColor = '';
            let iconBg = '';

            if (type === 'success') {
                iconClass = 'fa-check';
                iconColor = '#4CAF50';
                iconBg = '#E8F5E9';
            } else if (type === 'error') {
                iconClass = 'fa-times';
                iconColor = '#F44336';
                iconBg = '#FFEBEE';
            } else if (type === 'warning' || type === 'confirm') {
                iconClass = 'fa-exclamation';
                iconColor = '#FFC107';
                iconBg = '#FFF8E1';
            } else {
                iconClass = 'fa-info';
                iconColor = '#2196F3';
                iconBg = '#E3F2FD';
            }

            modalIconContainer.innerHTML = `<i class="fas ${iconClass}" style="color: ${iconColor};"></i>`;
            modalIconContainer.style.background = iconBg;

            // Setup Buttons
            modalActions.innerHTML = '';

            if (type === 'confirm') {
                // Cancel Button
                const btnCancel = document.createElement('button');
                btnCancel.innerText = cancelText;
                btnCancel.style.cssText = `border: none; background: #f5f5f5; color: #666; padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; transition: 0.2s;`;
                btnCancel.onmouseover = () => btnCancel.style.background = '#e0e0e0';
                btnCancel.onmouseout = () => btnCancel.style.background = '#f5f5f5';
                btnCancel.onclick = () => { closeModal(); if (onCancel) onCancel(); };
                modalActions.appendChild(btnCancel);

                // Confirm Button
                const btnConfirm = document.createElement('button');
                btnConfirm.innerText = confirmText;
                btnConfirm.style.cssText = `border: none; background: linear-gradient(135deg, #8C1C13, #720e0e); color: white; padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(140, 28, 19, 0.3); transition: 0.2s;`;
                btnConfirm.onmouseover = () => btnConfirm.style.transform = 'translateY(-2px)';
                btnConfirm.onmouseout = () => btnConfirm.style.transform = 'translateY(0)';
                btnConfirm.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
                modalActions.appendChild(btnConfirm);
            } else {
                // OK Button (Alert)
                const btnOk = document.createElement('button');
                btnOk.innerText = confirmText;
                btnOk.style.cssText = `border: none; background: linear-gradient(135deg, #8C1C13, #720e0e); color: white; padding: 12px 30px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; width: 100%; box-shadow: 0 4px 15px rgba(140, 28, 19, 0.3);`;
                btnOk.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
                modalActions.appendChild(btnOk);
            }

            // Show Animation
            modalOverlay.style.display = 'flex';
            // Trigger reflow
            void modalOverlay.offsetWidth;
            modalOverlay.style.opacity = '1';
            modalCard.style.transform = 'scale(1)';
        }

        function closeModal() {
            modalOverlay.style.opacity = '0';
            modalCard.style.transform = 'scale(0.9)';
            setTimeout(() => {
                modalOverlay.style.display = 'none';
            }, 300);
        }



        // --- AUTOMATED ADMIN TRIGGERS REMOVED ---
        // logic for runAdminAutomations, applyRetroactivePoints, resetTodayData has been removed.

        // --- NEW: SPLIT EVENT LOGIC (History vs All) ---
        // --- RENDER EVENTS ---

        window.loadMyEvents = async () => {
            const historyBody = document.getElementById('my-event-history-body');
            const allEventsList = document.getElementById('all-events-list');

            if (!window.currentPrefectGlobal) return;

            // -- PART A: MY HISTORY (Attendance Only) --
            try {
                // 1. Fetch Data Parallelly
                const [eventsSnap, attSnap] = await Promise.all([
                    getDocs(query(collection(db, "events"), orderBy("date", "desc"))),
                    getDocs(query(collection(db, "event_attendance"), where("prefectId", "==", window.currentPrefectGlobal.id)))
                ]);

                // 2. Prepare Data Sets
                const myAttendanceIds = new Set(attSnap.docs.map(d => d.data().eventId));

                const combinedHistory = [];
                const userClass = window.currentPrefectGlobal.class || ""; // "13-B"
                const userGrade = userClass.split("-")[0]; // "13"

                // 3. Process Events (Determine Presence)
                eventsSnap.forEach(doc => {
                    const evt = doc.data();
                    const evtId = doc.id;
                    const evtDate = new Date(evt.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // Skip Future Events for History
                    if (evtDate >= today) return;

                    const isAudience = !evt.target_grades || evt.target_grades.length === 0 || evt.target_grades.includes(userGrade);

                    if (isAudience) {
                        if (myAttendanceIds.has(evtId)) {
                            // Present
                            combinedHistory.push({
                                title: evt.title,
                                date: evt.date,
                                time: evt.time || "-",
                                status: "VERIFIED",
                                type: "present",
                                timestamp: evtDate
                            });
                        }
                        // Note: Absent/Penalty logic removed as per user request.
                    }
                });

                // 4. Sort & Render
                combinedHistory.sort((a, b) => b.timestamp - a.timestamp);

                let hRows = "";
                if (combinedHistory.length === 0) {
                    hRows = `<tr><td colspan="4" style="text-align:center; padding: 2rem; color: #94a3b8;">No participation history found.</td></tr>`;
                } else {
                    combinedHistory.forEach(item => {
                        let rowBg = '#ffffff';
                        let titleColor = '#1e293b';
                        let statusStyle = 'background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;';
                        let subText = '';
                        const dateStr = new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                        if (item.type === 'present') {
                            statusStyle = `background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;`;
                        } else if (item.type === 'penalty' || item.type === 'absent') {
                            // Keep legacy support just in case
                            rowBg = '#fff1f2';
                            statusStyle = `background: #ffe4e6; color: #be123c; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;`;
                        }

                        hRows += `
                        <tr style="border-bottom: 1px solid #f1f5f9; background: ${rowBg};">
                            <td style="padding: 1rem; font-weight: 600; color: ${titleColor};">
                                ${item.title}
                                ${subText}
                            </td>
                            <td style="padding: 1rem; color: var(--gray-600); font-size: 0.9rem;">${dateStr}</td>
                            <td style="padding: 1rem; font-family: monospace; color: var(--primary-600);">${item.time}</td>
                            <td style="padding: 1rem;">
                                <span style="${statusStyle}">${item.status}</span>
                            </td>
                        </tr>`;
                    });
                }
                historyBody.innerHTML = hRows;

            } catch (e) {
                console.error("History Error:", e);
                let errorMsg = e.message;
                if (e.message.includes("index")) {
                    errorMsg = '<b>MISSING INDEX</b><br>Check Console for link.';
                }
                historyBody.innerHTML = `<tr><td colspan="4" style="padding:1rem; color:red; text-align:center;">Load Failed: ${errorMsg}</td></tr>`;
            }


            /* const [attSnap, pointsSnap] = await Promise.all([getDocs(qAttendance), getDocs(qPoints)]);
    
            const combinedHistory = [];
    
            // Process Attendance
            attSnap.forEach(doc => {
                const data = doc.data();
                combinedHistory.push({
                    type: 'present',
                    title: data.eventTitle || "Unknown Event",
                    date: data.date,
                    time: data.time || "-",
                    timestamp: data.timestamp ? data.timestamp.toDate() : new Date(data.date),
                    status: "VERIFIED"
                });
            });
    
            // Process Absences (Negative Points)
            pointsSnap.forEach(doc => {
                const data = doc.data();
                if (data.points < 0) {
                    // Check if it's already in combinedHistory? (To avoid duplicates if we wrote both places)
                    // For now assume points record is the source of truth for absence.
                    combinedHistory.push({
                        type: 'absent',
                        title: data.reason || "Penalty / Absence", // Reason usually contains "Missed Event: ..."
                        date: data.date,
                        time: "-", // usually no time for absence
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(data.date),
                        status: "ABSENT"
                    });
                }
            });
    
            // Sort by Timestamp Descending
            combinedHistory.sort((a, b) => b.timestamp - a.timestamp);
    
            if (combinedHistory.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:2rem; color:#888;">No attendance or absence records found.</td></tr>';
            } else {
                let hRows = "";
                combinedHistory.forEach(item => {
                    const dateStr = item.date ? new Date(item.date).toLocaleDateString() : 'N/A';
    
                    // Styling based on type
                    const isAbsent = item.type === 'absent';
                    const rowBg = isAbsent ? '#fef2f2' : 'transparent'; // Light red bg for absent? Or just text? User asked for red list.
                    const statusStyle = isAbsent
                        ? `background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;`
                        : `background: #dcfce7; color: #166534;`;
    
                    const titleColor = isAbsent ? '#ef4444' : 'var(--gray-800)';
    
                    hRows += `
                    <tr style="border-bottom: 1px solid #f1f5f9; background: ${rowBg};">
                        <td style="padding: 1rem; font-weight: 600; color: ${titleColor};">
                            ${item.title}
                            ${isAbsent ? '<div style="font-size:0.75rem; color:#b91c1c; font-weight:normal;">Pt Deduction</div>' : ''}
                        </td>
                        <td style="padding: 1rem; color: var(--gray-600); font-size: 0.9rem;">${dateStr}</td>
                        <td style="padding: 1rem; font-family: monospace; color: var(--primary-600);">${item.time}</td>
                        <td style="padding: 1rem;">
                            <span style="padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; ${statusStyle}">
                                ${item.status}
                            </span>
                        </td>
                    </tr>
                    `;
                });
                historyBody.innerHTML = hRows;
            }
            } catch (e) {
                console.error("History Error:", e);
                let errorMsg = e.message;
                if (e.message.includes("index")) {
                    errorMsg = '<b>MISSING INDEX</b><br>Check Console for link.';
                }
                historyBody.innerHTML = `<tr><td colspan="4" style="padding:1rem; color:red; text-align:center;">Load Failed: ${errorMsg}</td></tr>`;
            } */

            // -- PART B: UPCOMING EVENTS & DUTY SLOTS --
            try {
                const qEvents = query(collection(db, "events"), orderBy("date", "desc"));
                const eventSnap = await getDocs(qEvents);

                if (eventSnap.empty) {
                    allEventsList.innerHTML = '<p style="padding:1rem; color:#888; text-align:center;">No events found.</p>';
                    return;
                }

                let eHtml = "";
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Use for...of loop to handle async/await correctly
                for (const docSnapshot of eventSnap.docs) {
                    const evt = docSnapshot.data();
                    const eventId = docSnapshot.id;
                    const eDate = new Date(evt.date);
                    const isUpcoming = eDate >= today;

                    let tag = isUpcoming
                        ? `<span style="background:#fef3c7; color:#92400e; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">UPCOMING</span>`
                        : `<span style="background:#f1f5f9; color:#64748b; padding:2px 8px; border-radius:4px; font-size:0.7rem;">PAST</span>`;

                    // Duty Slots Section (Only for Upcoming)
                    let dutiesHtml = "";
                    if (isUpcoming) {
                        try {
                            const qDuties = query(collection(db, "event_duties"), where("eventId", "==", eventId));
                            const dutySnap = await getDocs(qDuties);

                            if (!dutySnap.empty) {
                                dutiesHtml = `<div style="margin-top:1rem; background:#f8fafc; padding:0.8rem; border-radius:8px; border:1px solid #e2e8f0;">
                                                <div style="font-size:0.75rem; font-weight:700; color:#64748b; margin-bottom:0.5rem; text-transform:uppercase;">Available Duty Slots</div>
                                                <div style="display:flex; flex-direction:column; gap:0.5rem;">`;

                                dutySnap.forEach((dDoc) => {
                                    const duty = dDoc.data();
                                    const assignedToName = duty.assignedPrefectName;
                                    const assignedToId = duty.assignedPrefectId;
                                    const isMe = assignedToId === window.currentPrefectGlobal.id;

                                    let btn = "";
                                    if (!assignedToName) {
                                        // Open Slot
                                        btn = `<button onclick="window.takeDuty('${dDoc.id}', '${duty.title}', '${evt.title}')" style="margin-left:auto; background:var(--primary-600); color:white; border:none; padding:4px 10px; border-radius:6px; font-size:0.75rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:4px;">
                                                <i class="fas fa-plus"></i> Take
                                               </button>`;
                                    } else if (isMe) {
                                        // My Slot
                                        btn = `<span style="margin-left:auto; background:#dcfce7; color:#166534; padding:4px 10px; border-radius:6px; font-size:0.75rem; font-weight:700; border:1px solid #86efac;">
                                                <i class="fas fa-user-check"></i> YOUR DUTY
                                               </span>`;
                                    } else {
                                        // Taken Slot
                                        btn = `<span style="margin-left:auto; color:#94a3b8; font-size:0.75rem; font-style:italic;">
                                                <i class="fas fa-lock"></i> ${assignedToName}
                                               </span>`;
                                    }

                                    dutiesHtml += `
                                    <div style="display:flex; align-items:center; background:white; padding:0.5rem; border-radius:6px; border:1px solid ${isMe ? '#86efac' : '#f1f5f9'};">
                                        <div style="font-weight:600; color:#334155; font-size:0.85rem;">${duty.title}</div>
                                        ${btn}
                                    </div>`;
                                });
                                dutiesHtml += `</div></div>`;
                            } else {
                                dutiesHtml = `<div style="margin-top:0.5rem; padding:0.5rem; color:#94a3b8; font-size:0.8rem; font-style:italic;">No duty slots created by admin yet.</div>`;
                            }
                        } catch (err) {
                            console.error("Duty Load Error", err);
                        }
                    }

                    eHtml += `
                <div style="background:white; padding:1.2rem; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:0.5rem;">
                    <div style="display:flex; align-items:center; gap:1rem; margin-bottom:${isUpcoming ? '0.5rem' : '0'};">
                        <div style="flex:1;">
                            <div style="font-weight:600; color:#334155; margin-bottom:0.2rem; font-size:1rem;">${evt.title || "No Title"} <span style="margin-left:8px;">${tag}</span></div>
                            <div style="font-size:0.85rem; color:#64748b;"><i class="far fa-calendar-alt"></i> ${evt.date}</div>
                        </div>
                    </div>
                    ${dutiesHtml}
                </div>`;
                }

                allEventsList.innerHTML = eHtml;

            } catch (e) {
                console.error("All Events Error:", e);
                allEventsList.innerHTML = `<p style="color:red; font-size:0.8rem; text-align:center;">List Failed: ${e.message}</p>`;
            }
        };

        window.takeDuty = async (dutyId, dutyTitle, eventTitle) => {
            if (!confirm(`Take responsibility for "${dutyTitle}" at ${eventTitle}?`)) return;

            try {
                const dutyRef = doc(db, "event_duties", dutyId);
                await updateDoc(dutyRef, {
                    assignedPrefectId: window.currentPrefectGlobal.id,
                    assignedPrefectName: window.currentPrefectGlobal.name,
                    status: 'assigned',
                    updatedAt: serverTimestamp()
                });

                alert("Duty Assigned Successfully!");
                loadMyEvents(); // Refresh list

            } catch (e) {
                console.error("Take Duty Error:", e);
                alert("Failed to assign duty: " + e.message);
            }
        };

        // --- MIGRATION SCRIPT (ALL PREFECTS) ---
        window.initializeAllPrefectsPoints = async () => {
            if (!confirm("WARNING: RESET ALL PREFECTS to 100 points? (Requires Admin Permissions)")) return;

            try {
                const batch = writeBatch(db);
                const prefectsSnap = await getDocs(collection(db, "prefects"));

                let count = 0;
                const today = new Date().toISOString().split('T')[0];

                prefectsSnap.forEach(docSnap => {
                    const ref = doc(db, "prefects", docSnap.id);
                    // Set to 100
                    batch.update(ref, { total_points: 100 });

                    // Add History
                    const pRef = doc(collection(db, "points"));
                    batch.set(pRef, {
                        prefect_id: docSnap.id,
                        points: 100,
                        reason: "Initial Bonus (System Start)",
                        date: today,
                        timestamp: serverTimestamp()
                    });

                    count++;
                });

                await batch.commit();
                alert(`SUCCESS: Initialized ${count} prefects.`);
                location.reload();
            } catch (e) {
                console.error("Migration Failed:", e);
                alert(`FAILED: ${e.message}\n\n(If you get 'Missing permissions', your account is not an Admin in Firestore Rules)`);
            }
        };



    </script>
</body>

</html>
